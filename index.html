<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>POPPY | TAMAGOTCHI</title>
  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#101a33;
      --card:rgba(15,23,48,.86);
      --text:#eef2ff;
      --muted:#c7d2ff;
      --accent:#7cf7b2;
      --accent2:#8aa4ff;
      --warn:#ffd18a;
      --danger:#ff8aa1;
      --border:rgba(255,255,255,.14);
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-weight: 900;
      color: var(--text);
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(122,249,184,.16), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(138,164,255,.18), transparent 60%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      padding:22px;
      overflow-x:hidden;
      text-transform: uppercase;
      letter-spacing:.2px;
    }

    .wrap{
      width:min(1120px, 100%);
      margin:0 auto;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 960px){ .wrap{ grid-template-columns:1fr; } }

    .card{
      background: var(--card);
      border:1px solid rgba(255,255,255,.08);
      border-color: rgba(124,247,178,.16);
      border-top-color: rgba(138,164,255,.20);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    header{
      padding:18px 18px 10px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }

    .title{ display:flex; flex-direction:column; gap:6px; }
    h1{ margin:0; font-size: clamp(18px, 2.6vw, 26px); }
    .sub{ margin:0; color: var(--muted); font-size: 13px; }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      user-select:none;
    }
    .badge .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 6px rgba(124,247,178,.10);
    }

    .stage{
      padding: 14px 18px 18px;
      display:grid;
      gap:14px;
    }

    .screen{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(520px 260px at 50% 35%, rgba(124,247,178,.14), transparent 60%),
        radial-gradient(560px 260px at 50% 60%, rgba(138,164,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.12));
      height: 440px;
      position:relative;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 14px;
    }

    .hud{
      position:absolute;
      inset: 12px 12px auto 12px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      pointer-events:none;
    }

    .statusBox{
      pointer-events:none;
      max-width: 62%;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(6px);
      font-size: 12px;
      line-height: 1.25;
      box-shadow: 0 12px 26px rgba(0,0,0,.35);
      white-space: pre-line;
    }

    .pill{
      pointer-events:none;
      padding: 9px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      color: var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .pill b{ color: var(--text); }

    .floorGlow{
      position:absolute;
      bottom:-90px;
      width: 720px;
      height: 300px;
      border-radius: 999px;
      background: radial-gradient(circle at 50% 35%, rgba(124,247,178,.22), transparent 62%);
      filter: blur(2px);
      opacity:.85;
      pointer-events:none;
    }

    /* POPPY CHARACTER */
    .poppyWrap{
      position:relative;
      width: 300px;
      height: 320px;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      transform-origin: 50% 90%;
    }

    .nameTag{
      position:absolute;
      top: 4px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(0,0,0,.18));
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      letter-spacing: .9px;
      user-select:none;
      font-size: 12px;
    }

    .square{
      width: 180px;
      height: 180px;
      border-radius: 22px;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.26), transparent 55%),
        linear-gradient(180deg, rgba(185,255,217,1), rgba(47,228,138,1));
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 0 18px 44px rgba(0,0,0,.36);
      position:relative;
    }

    .face{
      width: 132px;
      height: 88px;
      border-radius: 22px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(10px);
      box-shadow: 0 16px 26px rgba(0,0,0,.20);
      position:absolute;
      bottom: 34px;
      left: 50%;
      transform: translateX(-50%);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:20px;
      padding-top:12px;
    }

    .eye{
      width: 15px;
      height: 15px;
      border-radius: 999px;
      background: #0b1020;
      box-shadow: 0 0 0 7px rgba(255,255,255,.10);
      position:relative;
      overflow:hidden;
    }
    .eye:after{
      content:"";
      position:absolute;
      width: 7px;height:7px;border-radius:999px;
      background: rgba(255,255,255,.90);
      top: 2px; left: 2px;
    }

    .mouth{
      position:absolute;
      left: 50%;
      bottom: 14px;
      transform: translateX(-50%);
      width: 38px;
      height: 18px;
      border: 3px solid rgba(11,16,32,.92);
      border-top: none;
      border-radius: 0 0 28px 28px;
      background: transparent;
    }

    .brow{
      position:absolute;
      top: 10px;
      width: 24px;
      height: 6px;
      border-radius: 999px;
      background: rgba(11,16,32,.92);
      opacity:0;
    }
    .brow.left{ left: 22px; transform: rotate(-10deg); }
    .brow.right{ right: 22px; transform: rotate(10deg); }

    /* FACE STATES */
    .mood-happy .mouth{ width: 46px; height: 22px; border-radius: 0 0 30px 30px; }
    .mood-sad .mouth{
      bottom: 18px; width: 46px; height: 18px;
      border-top: 3px solid rgba(11,16,32,.92);
      border-bottom:none; border-radius: 30px 30px 0 0;
    }
    .mood-angry .mouth{
      width: 38px; height: 16px;
      border-top: 3px solid rgba(11,16,32,.92);
      border-bottom:none; border-radius: 22px 22px 0 0;
    }
    .mood-angry .brow{ opacity:1; }
    .mood-angry .brow.left{ transform: rotate(18deg); }
    .mood-angry .brow.right{ transform: rotate(-18deg); }

    .mood-hungry .mouth{
      width: 18px; height: 18px;
      border: 3px solid rgba(11,16,32,.92);
      border-radius: 999px;
    }

    .mood-sick .mouth{
      width: 34px; height: 7px;
      border:none; background: rgba(11,16,32,.92); border-radius: 999px;
    }
    .mood-sick .eye{ height: 11px; }

    .mood-bored .mouth{
      width: 30px; height: 6px;
      border:none; background: rgba(11,16,32,.92); border-radius: 999px;
      opacity:.85;
    }

    /* CONSOLE */
    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 620px){ .controls{ grid-template-columns:1fr; } }

    .panel{
      padding: 14px 14px 16px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
    }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width: 620px){ .grid2{ grid-template-columns:1fr; } }

    button{
      width:100%;
      font: inherit;
      font-weight: 950;
      color: var(--text);
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 10px 12px;
      outline:none;
      cursor:pointer;
      letter-spacing:.3px;
      transition: transform .08s ease, filter .2s ease, border-color .2s ease;
    }
    button:hover{ filter: brightness(1.06); border-color: rgba(124,247,178,.42); }
    button:active{ transform: translateY(1px) scale(.99); }

    .btnMain{
      background: linear-gradient(180deg, rgba(124,247,178,.24), rgba(124,247,178,.08));
      border-color: rgba(124,247,178,.22);
    }
    .btnAlt{
      background: linear-gradient(180deg, rgba(138,164,255,.20), rgba(138,164,255,.06));
      border-color: rgba(138,164,255,.22);
    }
    .btnWarn{
      background: linear-gradient(180deg, rgba(255,209,138,.22), rgba(255,209,138,.07));
      border-color: rgba(255,209,138,.22);
    }
    .btnDanger{
      background: linear-gradient(180deg, rgba(255,138,161,.22), rgba(255,138,161,.07));
      border-color: rgba(255,138,161,.22);
    }

    .bars{
      display:grid;
      gap:10px;
    }
    .barRow{
      display:grid;
      grid-template-columns: 120px 1fr 54px;
      gap:10px;
      align-items:center;
      font-size: 12px;
      color: var(--muted);
    }
    @media (max-width: 420px){
      .barRow{ grid-template-columns: 1fr; }
    }

    .meter{
      height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .fill{
      height:100%;
      width: 50%;
      background: linear-gradient(90deg, rgba(124,247,178,.85), rgba(138,164,255,.85));
    }

    .log{
      height: 260px;
      overflow:auto;
      padding: 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.10);
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
    }
    .log b{ color: var(--text); }
    .log .item{ margin-bottom:10px; }

    /* ANIMATIONS */
    @keyframes wiggle {
      0%{ transform: rotate(0deg) translateY(0) }
      15%{ transform: rotate(-10deg) translateY(-1px) }
      35%{ transform: rotate(12deg) translateY(-2px) }
      55%{ transform: rotate(-8deg) translateY(-1px) }
      75%{ transform: rotate(10deg) translateY(-2px) }
      100%{ transform: rotate(0deg) translateY(0) }
    }
    @keyframes bounce {
      0%,100%{ transform: translateY(0) }
      25%{ transform: translateY(-16px) }
      55%{ transform: translateY(0) }
      75%{ transform: translateY(-8px) }
    }
    @keyframes panicShake {
      0%{ transform: translateX(0) rotate(0deg) }
      10%{ transform: translateX(-6px) rotate(-3deg) }
      20%{ transform: translateX(6px) rotate(3deg) }
      30%{ transform: translateX(-5px) rotate(-2deg) }
      40%{ transform: translateX(5px) rotate(2deg) }
      50%{ transform: translateX(-4px) rotate(-1deg) }
      60%{ transform: translateX(4px) rotate(1deg) }
      70%{ transform: translateX(-3px) rotate(-1deg) }
      80%{ transform: translateX(3px) rotate(1deg) }
      90%{ transform: translateX(-2px) rotate(0deg) }
      100%{ transform: translateX(0) rotate(0deg) }
    }
    @keyframes headBob {
      0%,100%{ transform: translateX(-50%) translateY(0) }
      25%{ transform: translateX(-50%) translateY(-3px) }
      50%{ transform: translateX(-50%) translateY(2px) }
      75%{ transform: translateX(-50%) translateY(-2px) }
    }

    .anim-idle .poppyWrap{ animation: none; }
    .anim-wiggle .poppyWrap{ animation: wiggle 900ms ease-in-out infinite; }
    .anim-bounce .poppyWrap{ animation: bounce 900ms ease-in-out infinite; }
    .anim-shake .poppyWrap{ animation: panicShake 520ms linear infinite; }

    .anim-wiggle .face,
    .anim-bounce .face,
    .anim-shake .face{
      animation: headBob 700ms ease-in-out infinite;
    }

    @media (prefers-reduced-motion: reduce){
      .anim-idle .poppyWrap,
      .anim-wiggle .poppyWrap,
      .anim-bounce .poppyWrap,
      .anim-shake .poppyWrap,
      .anim-wiggle .face,
      .anim-bounce .face,
      .anim-shake .face{ animation:none !important; }
    }
  </style>
</head>

<body>
  <main class="wrap">
    <section class="card" id="app">
      <header>
        <div class="title">
          <h1>POPPY</h1>
          <p class="sub">A FULL TAMAGOTCHI STYLE PET WITH NEEDS, MOODS, AND UPGRADES</p>
        </div>
        <div class="badge">
          <span class="dot" id="statusDot"></span>
          <span id="statusText">ALIVE</span>
        </div>
      </header>

      <div class="stage">
        <div class="screen" id="screen">
          <div class="hud">
            <div class="statusBox" id="statusBox">POPPY IS IDLE. TAKE CARE OF NEEDS.</div>
            <div class="pill">MOOD <b id="moodPill">HAPPY</b> AGE <b id="agePill">0</b></div>
          </div>

          <div class="floorGlow"></div>

          <div class="poppyWrap" id="poppyWrap" aria-label="Poppy">
            <div class="nameTag">POPPY</div>

            <div class="square" id="square">
              <div class="face" id="face">
                <div class="brow left"></div>
                <div class="brow right"></div>
                <div class="eye"></div>
                <div class="eye"></div>
                <div class="mouth" id="mouth"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="controls">
          <div class="panel">
            <div class="bars">
              <div class="barRow"><span>HUNGER</span><div class="meter"><div class="fill" id="hungerFill"></div></div><span id="hungerVal">50</span></div>
              <div class="barRow"><span>HAPPINESS</span><div class="meter"><div class="fill" id="happyFill"></div></div><span id="happyVal">70</span></div>
              <div class="barRow"><span>ENERGY</span><div class="meter"><div class="fill" id="energyFill"></div></div><span id="energyVal">70</span></div>
              <div class="barRow"><span>CLEANLINESS</span><div class="meter"><div class="fill" id="cleanFill"></div></div><span id="cleanVal">60</span></div>
              <div class="barRow"><span>HEALTH</span><div class="meter"><div class="fill" id="healthFill"></div></div><span id="healthVal">90</span></div>
            </div>
          </div>

          <div class="panel">
            <div class="grid2">
              <button class="btnMain" id="btnFeed" type="button">FEED</button>
              <button class="btnMain" id="btnPlay" type="button">PLAY</button>
              <button class="btnMain" id="btnSleep" type="button">SLEEP</button>
              <button class="btnMain" id="btnClean" type="button">CLEAN</button>
              <button class="btnWarn" id="btnMed" type="button">MEDICINE</button>
              <button class="btnAlt" id="btnWork" type="button">WORK</button>
            </div>

            <div class="grid2" style="margin-top:10px;">
              <button class="btnAlt" id="btnShop" type="button">SHOP</button>
              <button class="btnAlt" id="btnToggleAuto" type="button">AUTO CARE OFF</button>
            </div>

            <div class="grid2" style="margin-top:10px;">
              <button class="btnDanger" id="btnReset" type="button">RESET SAVE</button>
              <button class="btnAlt" id="btnPause" type="button">PAUSE</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <aside class="card" style="padding:16px 16px 18px;">
      <h2 style="margin:0 0 10px; font-size:16px;">EVENT LOG</h2>
      <div class="log" id="log"></div>

      <div class="panel" style="margin-top:12px;">
        <h2 style="margin:0 0 10px; font-size:16px;">MODS</h2>
        <div class="grid2">
          <button class="btnAlt" id="modSnack" type="button">SNACK DISPENSER</button>
          <button class="btnAlt" id="modToy" type="button">TOY BOX</button>
          <button class="btnAlt" id="modBlanket" type="button">SOFT BLANKET</button>
          <button class="btnAlt" id="modSoap" type="button">SOAP KIT</button>
        </div>
        <div class="panel" style="margin-top:10px;">
          <div style="font-size:12px; color:var(--muted); line-height:1.35;">
            MODS CHANGE STATS PASSIVELY. THEY COST COINS. WORK EARNS COINS.
            YOUR PET WILL GET HUNGRY, TIRED, DIRTY, SAD, OR ANGRY IF NEGLECTED.
          </div>
        </div>
      </div>
    </aside>
  </main>

  <script>
    const $ = (id)=>document.getElementById(id);

    const app = $("app");
    const face = $("face");
    const statusBox = $("statusBox");
    const moodPill = $("moodPill");
    const agePill = $("agePill");
    const statusDot = $("statusDot");
    const statusText = $("statusText");
    const logEl = $("log");
    const poppyWrap = $("poppyWrap");

    const fills = {
      hunger: $("hungerFill"),
      happy: $("happyFill"),
      energy: $("energyFill"),
      clean: $("cleanFill"),
      health: $("healthFill")
    };
    const vals = {
      hunger: $("hungerVal"),
      happy: $("happyVal"),
      energy: $("energyVal"),
      clean: $("cleanVal"),
      health: $("healthVal")
    };

    // SAVE KEY
    const KEY = "POPPY_TAMA_SAVE_V1";

    // GAME STATE
    let S = {
      alive: true,
      paused: false,
      ageMin: 0,
      coins: 0,

      hunger: 50,     // 0 worst, 100 best
      happy: 70,
      energy: 70,
      clean: 60,
      health: 90,

      mood: "HAPPY",  // derived
      anim: "IDLE",

      autoCare: false,

      mods: {
        snack: false,
        toy: false,
        blanket: false,
        soap: false
      }
    };

    // UTILS
    function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
    function rint(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

    function log(msg){
      const t = new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = "<b>" + t + "</b> | " + msg;
      logEl.prepend(div);
    }

    function setAnim(name){
      app.classList.remove("anim-idle","anim-wiggle","anim-bounce","anim-shake");
      const map = { IDLE:"anim-idle", WIGGLE:"anim-wiggle", BOUNCE:"anim-bounce", SHAKE:"anim-shake" };
      app.classList.add(map[name] || "anim-idle");
      S.anim = name;
    }

    function setFaceMood(m){
      face.classList.remove("mood-happy","mood-sad","mood-angry","mood-hungry","mood-sick","mood-bored");
      const map = {
        HAPPY:"mood-happy",
        SAD:"mood-sad",
        ANGRY:"mood-angry",
        HUNGRY:"mood-hungry",
        SICK:"mood-sick",
        BORED:"mood-bored"
      };
      face.classList.add(map[m] || "mood-happy");
    }

    function updateBars(){
      const items = ["hunger","happy","energy","clean","health"];
      items.forEach(k=>{
        const v = clamp(S[k], 0, 100);
        fills[k].style.width = v + "%";
        vals[k].textContent = String(Math.round(v));
      });
    }

    function computeMood(){
      if (!S.alive) return "DEAD";
      if (S.health <= 20) return "SICK";
      if (S.hunger <= 25) return "HUNGRY";
      if (S.clean <= 20) return "ANGRY";
      if (S.happy <= 25) return "SAD";
      if (S.energy <= 20) return "BORED";
      return "HAPPY";
    }

    function updateHUD(){
      const mood = computeMood();
      S.mood = mood;
      moodPill.textContent = mood;
      agePill.textContent = String(S.ageMin);
      setFaceMood(mood);

      // status badge color
      if (!S.alive){
        statusDot.style.background = "var(--danger)";
        statusText.textContent = "DEAD";
      } else if (mood === "SICK"){
        statusDot.style.background = "var(--danger)";
        statusText.textContent = "SICK";
      } else if (mood === "HUNGRY"){
        statusDot.style.background = "var(--warn)";
        statusText.textContent = "HUNGRY";
      } else if (mood === "ANGRY"){
        statusDot.style.background = "var(--danger)";
        statusText.textContent = "ANGRY";
      } else if (mood === "SAD"){
        statusDot.style.background = "var(--warn)";
        statusText.textContent = "SAD";
      } else {
        statusDot.style.background = "var(--accent)";
        statusText.textContent = "ALIVE";
      }

      // status text lines (no chat)
      const lines = [];
      lines.push("POPPY STATUS");
      lines.push("MOOD " + mood);
      lines.push("COINS " + S.coins);
      lines.push("MODS " + activeModsLabel());
      statusBox.textContent = lines.join("\n");

      // auto animation by mood
      if (!S.paused && S.alive){
        if (mood === "HAPPY") setAnim("WIGGLE");
        else if (mood === "BORED") setAnim("BOUNCE");
        else if (mood === "HUNGRY" || mood === "SAD") setAnim("IDLE");
        else if (mood === "ANGRY" || mood === "SICK") setAnim("SHAKE");
      } else {
        setAnim("IDLE");
      }

      updateBars();
      save();
    }

    function activeModsLabel(){
      const a = [];
      if (S.mods.snack) a.push("SNACK");
      if (S.mods.toy) a.push("TOY");
      if (S.mods.blanket) a.push("BLANKET");
      if (S.mods.soap) a.push("SOAP");
      return a.length ? a.join(",") : "NONE";
    }

    // PASSIVE TICK: NEEDS DECAY + MOD EFFECTS
    function tick(){
      if (!S.alive || S.paused) return;

      S.ageMin += 1;

      // Base decay (per minute)
      S.hunger -= 4;     // gets hungry
      S.energy -= 3;     // gets tired
      S.clean  -= 2;     // gets dirty

      // Happiness depends on other needs
      let sadPush = 0;
      if (S.hunger < 40) sadPush += 2;
      if (S.energy < 35) sadPush += 2;
      if (S.clean  < 35) sadPush += 2;
      S.happy -= (1 + sadPush);

      // Health depends on neglect
      let dmg = 0;
      if (S.hunger <= 15) dmg += 6;
      if (S.clean  <= 15) dmg += 5;
      if (S.energy <= 10) dmg += 4;
      if (S.happy  <= 10) dmg += 4;
      S.health -= dmg;

      // Mods (passive buffs)
      if (S.mods.snack) S.hunger += 2;
      if (S.mods.toy) S.happy += 2;
      if (S.mods.blanket) S.energy += 2;
      if (S.mods.soap) S.clean += 2;

      // Auto care
      if (S.autoCare){
        autoCareLogic();
      }

      // Clamp
      S.hunger = clamp(S.hunger, 0, 100);
      S.happy  = clamp(S.happy, 0, 100);
      S.energy = clamp(S.energy, 0, 100);
      S.clean  = clamp(S.clean, 0, 100);
      S.health = clamp(S.health, 0, 100);

      // Death
      if (S.health <= 0){
        S.alive = false;
        S.health = 0;
        log("POPPY HAS DIED");
      } else {
        // occasional events
        if (Math.random() < 0.12){
          randomEvent();
        }
      }

      updateHUD();
    }

    function autoCareLogic(){
      // Cheap simple rules
      if (S.hunger < 35 && S.coins >= 1){ actionFeed(true); }
      if (S.clean < 35){ actionClean(true); }
      if (S.energy < 30){ actionSleep(true); }
      if (S.happy < 35){ actionPlay(true); }
      if (S.health < 40){ actionMed(true); }
    }

    // ACTIONS (no chat)
    function actionFeed(isAuto=false){
      if (!S.alive || S.paused) return;
      const cost = 1;
      if (!isAuto && S.coins < cost){
        log("NOT ENOUGH COINS TO FEED");
        return;
      }
      if (!isAuto) S.coins -= cost;

      S.hunger += 28;
      S.clean  -= 3;
      S.happy  += 5;

      S.hunger = clamp(S.hunger, 0, 100);
      S.clean  = clamp(S.clean, 0, 100);
      S.happy  = clamp(S.happy, 0, 100);

      log(isAuto ? "AUTO FEED" : "FEED");
      setAnim("BOUNCE");
      updateHUD();
    }

    function actionPlay(isAuto=false){
      if (!S.alive || S.paused) return;
      S.happy += 22;
      S.energy -= 6;
      S.clean  -= 2;
      S.happy  = clamp(S.happy, 0, 100);
      S.energy = clamp(S.energy, 0, 100);
      S.clean  = clamp(S.clean, 0, 100);
      log(isAuto ? "AUTO PLAY" : "PLAY");
      setAnim("WIGGLE");
      updateHUD();
    }

    function actionSleep(isAuto=false){
      if (!S.alive || S.paused) return;
      S.energy += 30;
      S.hunger -= 6;
      S.energy = clamp(S.energy, 0, 100);
      S.hunger = clamp(S.hunger, 0, 100);
      log(isAuto ? "AUTO SLEEP" : "SLEEP");
      setAnim("IDLE");
      updateHUD();
    }

    function actionClean(isAuto=false){
      if (!S.alive || S.paused) return;
      S.clean += 34;
      S.happy += 3;
      S.clean = clamp(S.clean, 0, 100);
      S.happy = clamp(S.happy, 0, 100);
      log(isAuto ? "AUTO CLEAN" : "CLEAN");
      setAnim("WIGGLE");
      updateHUD();
    }

    function actionMed(isAuto=false){
      if (!S.alive || S.paused) return;
      const cost = 2;
      if (!isAuto && S.coins < cost){
        log("NOT ENOUGH COINS FOR MEDICINE");
        return;
      }
      if (!isAuto) S.coins -= cost;

      S.health += 28;
      S.happy -= 3;
      S.clean -= 2;

      S.health = clamp(S.health, 0, 100);
      S.happy  = clamp(S.happy, 0, 100);
      S.clean  = clamp(S.clean, 0, 100);

      log(isAuto ? "AUTO MEDICINE" : "MEDICINE");
      setAnim("IDLE");
      updateHUD();
    }

    function actionWork(){
      if (!S.alive || S.paused) return;
      const earned = rint(2,5);
      S.coins += earned;
      S.energy -= 8;
      S.hunger -= 6;
      S.happy  -= 3;
      S.energy = clamp(S.energy, 0, 100);
      S.hunger = clamp(S.hunger, 0, 100);
      S.happy  = clamp(S.happy, 0, 100);
      log("WORK EARNED " + earned + " COINS");
      setAnim("BOUNCE");
      updateHUD();
    }

    // SHOP + MODS
    function buyMod(key, cost, label){
      if (!S.alive || S.paused) return;
      if (S.mods[key]){
        log("ALREADY OWNS " + label);
        return;
      }
      if (S.coins < cost){
        log("NOT ENOUGH COINS FOR " + label);
        return;
      }
      S.coins -= cost;
      S.mods[key] = true;
      log("PURCHASED " + label);
      updateHUD();
    }

    // RANDOM EVENTS
    function randomEvent(){
      const roll = Math.random();
      if (roll < 0.33){
        // bonus coins
        const c = rint(1,4);
        S.coins += c;
        log("FOUND " + c + " COINS");
      } else if (roll < 0.66){
        // mess
        const d = rint(4,10);
        S.clean -= d;
        log("ACCIDENT. CLEANLINESS DOWN " + d);
      } else {
        // mood swing
        const d = rint(4,10);
        S.happy -= d;
        log("MOOD DROP. HAPPINESS DOWN " + d);
      }
    }

    // SAVE / LOAD
    function save(){
      try{
        localStorage.setItem(KEY, JSON.stringify(S));
      } catch(e){}
    }
    function load(){
      try{
        const raw = localStorage.getItem(KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (!data || typeof data !== "object") return;
        S = Object.assign(S, data);
      } catch(e){}
    }

    function resetSave(){
      localStorage.removeItem(KEY);
      location.reload();
    }

    // UI WIRING
    $("btnFeed").addEventListener("click", ()=>actionFeed(false));
    $("btnPlay").addEventListener("click", ()=>actionPlay(false));
    $("btnSleep").addEventListener("click", ()=>actionSleep(false));
    $("btnClean").addEventListener("click", ()=>actionClean(false));
    $("btnMed").addEventListener("click", ()=>actionMed(false));
    $("btnWork").addEventListener("click", ()=>actionWork());

    $("btnToggleAuto").addEventListener("click", (e)=>{
      S.autoCare = !S.autoCare;
      e.target.textContent = "AUTO CARE " + (S.autoCare ? "ON" : "OFF");
      log("AUTO CARE " + (S.autoCare ? "ON" : "OFF"));
      updateHUD();
    });

    $("btnPause").addEventListener("click", (e)=>{
      S.paused = !S.paused;
      e.target.textContent = S.paused ? "RESUME" : "PAUSE";
      log(S.paused ? "PAUSED" : "RESUMED");
      updateHUD();
    });

    $("btnReset").addEventListener("click", resetSave);

    // MOD BUTTONS
    $("modSnack").addEventListener("click", ()=>buyMod("snack", 8, "SNACK DISPENSER"));
    $("modToy").addEventListener("click", ()=>buyMod("toy", 10, "TOY BOX"));
    $("modBlanket").addEventListener("click", ()=>buyMod("blanket", 10, "SOFT BLANKET"));
    $("modSoap").addEventListener("click", ()=>buyMod("soap", 8, "SOAP KIT"));

    // SHOP BUTTON JUST OPENS LOG MESSAGE (SIMPLE)
    $("btnShop").addEventListener("click", ()=>{
      log("SHOP: BUY MODS ON THE RIGHT PANEL");
    });

    // KEYBOARD SHORTCUTS
    window.addEventListener("keydown", (e)=>{
      const k = e.key.toLowerCase();
      if (k === "f") actionFeed(false);
      if (k === "p") actionPlay(false);
      if (k === "s") actionSleep(false);
      if (k === "c") actionClean(false);
      if (k === "m") actionMed(false);
      if (k === "w") actionWork();
      if (k === " "){ S.paused = !S.paused; log(S.paused ? "PAUSED" : "RESUMED"); updateHUD(); }
    });

    // STARTUP
    load();
    logEl.innerHTML = '<div class="item"><b>WELCOME</b> | USE BUTTONS TO CARE FOR POPPY. KEYS F P S C M W. SPACE TO PAUSE.</div>';
    updateHUD();

    // TICK LOOP: 1 MINUTE REAL TIME. CHANGE TO 10 SECONDS IF YOU WANT IT FASTER.
    let timer = setInterval(tick, 60000);

    // OPTIONAL: FAST MODE FOR DEMOS (UNCOMMENT)
    // clearInterval(timer);
    // timer = setInterval(tick, 10000);

  </script>
</body>
</html>
