<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>POPPY | TAMAGOTCHI</title>
  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#101a33;
      --card:rgba(15,23,48,.86);
      --text:#eef2ff;
      --muted:#c7d2ff;
      --accent:#7cf7b2;
      --accent2:#8aa4ff;
      --warn:#ffd18a;
      --danger:#ff8aa1;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
      --ink:#0b1020;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-weight: 950;
      color: var(--text);
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(122,249,184,.16), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(138,164,255,.18), transparent 60%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      padding:22px;
      overflow-x:hidden;
      text-transform: uppercase;
      letter-spacing:.2px;
    }

    .wrap{
      width:min(1180px, 100%);
      margin:0 auto;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 980px){ .wrap{ grid-template-columns:1fr; } }

    .card{
      background: var(--card);
      border:1px solid rgba(255,255,255,.10);
      border-color: rgba(124,247,178,.16);
      border-top-color: rgba(138,164,255,.20);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    header{
      padding:18px 18px 10px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }

    .title{ display:flex; flex-direction:column; gap:6px; }
    h1{ margin:0; font-size: clamp(18px, 2.6vw, 26px); }
    .sub{ margin:0; color: var(--muted); font-size: 13px; }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      user-select:none;
    }
    .badge .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 6px rgba(124,247,178,.10);
    }

    .stage{
      padding: 14px 18px 18px;
      display:grid;
      gap:14px;
    }

    .screen{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(520px 260px at 50% 35%, rgba(124,247,178,.10), transparent 60%),
        radial-gradient(560px 260px at 50% 60%, rgba(138,164,255,.07), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.16));
      height: 468px;
      position:relative;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 14px;
    }

    .hud{
      position:absolute;
      inset: 12px 12px auto 12px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      pointer-events:none;
      z-index:5;
    }

    .statusBox{
      max-width: 66%;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(6px);
      font-size: 12px;
      line-height: 1.25;
      box-shadow: 0 12px 26px rgba(0,0,0,.35);
      white-space: pre-line;
      pointer-events:auto; /* for dblclick */
      cursor: default;
      user-select:none;
    }

    .pill{
      padding: 9px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      color: var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .pill b{ color: var(--text); }

    .floorGlow{
      position:absolute;
      bottom:-110px;
      width: 600px;
      height: 280px;
      border-radius: 999px;
      background: radial-gradient(circle at 50% 35%, rgba(124,247,178,.14), transparent 62%);
      filter: blur(2px);
      opacity:.85;
      pointer-events:none;
    }

    /* POPPY */
    .poppyWrap{
      position:relative;
      width: 270px;
      height: 300px;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      transform-origin: 50% 90%;
      z-index:2;
    }

    .nameTag{
      position:absolute;
      top: 4px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(0,0,0,.18));
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      letter-spacing: .9px;
      user-select:none;
      font-size: 12px;
    }

    .square{
      width: 178px;
      height: 178px;
      border-radius: 22px;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.22), transparent 55%),
        linear-gradient(180deg, rgba(185,255,217,1), rgba(47,228,138,1));
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 0 18px 44px rgba(0,0,0,.36);
      position:relative;
      overflow:hidden;
    }

    .face{
      width: 138px;
      height: 92px;
      border-radius: 22px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(10px);
      box-shadow: 0 16px 26px rgba(0,0,0,.20);
      position:absolute;
      bottom: 34px;
      left: 50%;
      transform: translateX(-50%);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:24px;
      padding-top:12px;
    }

    .eye{
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: #0b1020;
      box-shadow: 0 0 0 7px rgba(255,255,255,.10);
      position:relative;
      overflow:hidden;
    }
    .eye:after{
      content:"";
      position:absolute;
      width: 6px;height:6px;border-radius:999px;
      background: rgba(255,255,255,.90);
      top: 2px; left: 2px;
    }

    .mouth{
      position:absolute;
      left: 50%;
      bottom: 14px;
      transform: translateX(-50%);
      width: 36px;
      height: 16px;
      border: 3px solid rgba(11,16,32,.92);
      border-top: none;
      border-radius: 0 0 28px 28px;
      background: transparent;
    }

    .brow{
      position:absolute;
      top: 10px;
      width: 24px;
      height: 6px;
      border-radius: 999px;
      background: rgba(11,16,32,.92);
      opacity:0;
    }
    .brow.left{ left: 20px; transform: rotate(-10deg); }
    .brow.right{ right: 20px; transform: rotate(10deg); }

    /* FACE STATES */
    .mood-happy .mouth{ width: 44px; height: 20px; border-radius: 0 0 30px 30px; }
    .mood-sad .mouth{
      bottom: 18px; width: 44px; height: 16px;
      border-top: 3px solid rgba(11,16,32,.92);
      border-bottom:none; border-radius: 30px 30px 0 0;
    }
    .mood-angry .mouth{
      width: 36px; height: 14px;
      border-top: 3px solid rgba(11,16,32,.92);
      border-bottom:none; border-radius: 22px 22px 0 0;
    }
    .mood-angry .brow{ opacity:1; }
    .mood-angry .brow.left{ transform: rotate(18deg); }
    .mood-angry .brow.right{ transform: rotate(-18deg); }
    .mood-hungry .mouth{
      width: 18px; height: 18px;
      border: 3px solid rgba(11,16,32,.92);
      border-radius: 999px;
    }
    .mood-sick .mouth{
      width: 34px; height: 7px;
      border:none; background: rgba(11,16,32,.92); border-radius: 999px;
    }
    .mood-sick .eye{ height: 11px; }
    .mood-bored .mouth{
      width: 30px; height: 6px;
      border:none; background: rgba(11,16,32,.92); border-radius: 999px;
      opacity:.85;
    }
    .mood-asleep .mouth{
      width: 28px; height: 6px;
      border:none; background: rgba(11,16,32,.92); border-radius: 999px;
      opacity:.65;
    }
    .mood-asleep .eye{ transform: scaleY(.25); }

    @keyframes blink {
      0%, 90%, 100% { transform: scaleY(1); }
      92%, 96% { transform: scaleY(0.15); }
    }
    .blink .eye{ animation: blink 220ms linear 1; transform-origin:center; }

    @keyframes pop { 0%{ transform: scale(1); } 50%{ transform: scale(1.05); } 100%{ transform: scale(1); } }
    @keyframes nod { 0%{ transform: translateY(0); } 40%{ transform: translateY(-8px); } 100%{ transform: translateY(0); } }
    @keyframes wig { 0%{ transform: rotate(0deg); } 25%{ transform: rotate(-8deg); } 50%{ transform: rotate(10deg); } 75%{ transform: rotate(-6deg); } 100%{ transform: rotate(0deg); } }
    .burst-pop .square{ animation: pop 380ms ease-out 1; }
    .burst-nod .poppyWrap{ animation: nod 420ms ease-out 1; }
    .burst-wig .poppyWrap{ animation: wig 520ms ease-in-out 1; }

    .sleepTint{
      position:absolute;
      inset:0;
      background: radial-gradient(circle at 50% 30%, rgba(138,164,255,.14), rgba(0,0,0,.62));
      opacity:0;
      transition: opacity .25s ease;
      pointer-events:none;
      z-index:3;
    }
    .sleepOn .sleepTint{ opacity:1; }

    /* OVERLAY */
    .overlay{
      position:absolute;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10;
      background: radial-gradient(circle at 50% 40%, rgba(0,0,0,.20), rgba(0,0,0,.55));
      backdrop-filter: blur(3px);
    }
    .overlay.show{ display:flex; }
    .overlayCard{
      width:min(600px, 94%);
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,14,28,.84);
      box-shadow: 0 22px 60px rgba(0,0,0,.55);
      padding: 14px;
    }
    .overlayTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .overlayTop b{ color: var(--text); }
    .overlayBody{
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 12px;
      min-height: 210px;
      display:grid;
      place-items:center;
      position:relative;
      overflow:hidden;
    }
    .overlayActions{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){ .overlayActions{ grid-template-columns:1fr; } }

    /* APPLE MINI GAME */
    .gameArea{
      width: min(520px, 96%);
      height: 260px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      position:relative;
      overflow:hidden;
    }
    .apple{
      width: 40px;
      height: 40px;
      border-radius: 999px;
      position:absolute;
      left: 20px;
      top: 20px;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 18px 30px rgba(0,0,0,.30);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.85), rgba(255,255,255,0) 45%),
        radial-gradient(circle at 50% 60%, rgba(255,120,120,.95), rgba(190,30,50,.95));
    }
    .apple:before{
      content:"";
      position:absolute;
      width: 8px; height: 13px;
      left: 50%;
      top: -7px;
      transform: translateX(-50%) rotate(10deg);
      border-radius: 6px;
      background: linear-gradient(180deg, rgba(120,80,40,1), rgba(80,50,25,1));
      box-shadow: 0 4px 10px rgba(0,0,0,.25);
    }
    .apple:after{
      content:"";
      position:absolute;
      width: 16px; height: 11px;
      left: 56%;
      top: -2px;
      transform: rotate(20deg);
      border-radius: 14px 14px 14px 2px;
      background: linear-gradient(180deg, rgba(170,255,200,1), rgba(55,220,140,1));
      box-shadow: 0 6px 12px rgba(0,0,0,.18);
    }
    .gameHud{
      display:flex;
      justify-content:space-between;
      width: min(520px, 96%);
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
    }
    .gameHud b{ color: var(--text); }

    /* DINO RUNNER STYLE GAME */
    .dinoArea{
      width: min(520px, 96%);
      height: 260px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.20));
      position:relative;
      overflow:hidden;
    }
    .groundLine{
      position:absolute;
      left:0; right:0;
      height: 3px;
      bottom: 40px;
      background: rgba(255,255,255,.14);
    }
    .dino{
      width: 44px;
      height: 44px;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(185,255,217,1), rgba(47,228,138,1));
      border: 1px solid rgba(255,255,255,.12);
      position:absolute;
      left: 24px;
      bottom: 40px;
      box-shadow: 0 18px 30px rgba(0,0,0,.25);
    }
    .cactus{
      width: 20px;
      height: 48px;
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(255,255,255,.16), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.14);
      position:absolute;
      bottom: 40px;
      left: 520px;
      box-shadow: 0 18px 30px rgba(0,0,0,.25);
    }
    .cloud{
      position:absolute;
      top: 30px;
      left: 520px;
      width: 68px;
      height: 24px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.10);
      filter: blur(.2px);
      opacity:.8;
    }
    .cloud:before, .cloud:after{
      content:"";
      position:absolute;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 999px;
    }
    .cloud:before{ width: 26px; height: 18px; left: 8px; top:-10px; }
    .cloud:after{ width: 32px; height: 22px; left: 26px; top:-14px; }

    .dinoHudRow{
      width: min(520px, 96%);
      display:flex;
      justify-content:space-between;
      gap:10px;
      color: var(--muted);
      font-size: 12px;
      margin-top: 10px;
    }

    .toast{
      position:fixed;
      left: 16px;
      right: 16px;
      top: 14px;
      margin:0 auto;
      width: min(900px, calc(100% - 32px));
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
      z-index:9999;
      display:none;
      white-space: pre-line;
    }
    .errorBanner{
      position:fixed;
      left:16px;
      right:16px;
      bottom:16px;
      padding:12px 14px;
      border-radius:14px;
      background: rgba(255,138,161,.18);
      border: 1px solid rgba(255,138,161,.40);
      color: var(--text);
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
      z-index:9999;
      display:none;
      white-space: pre-line;
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 680px){ .controls{ grid-template-columns:1fr; } }

    .panel{
      padding: 14px 14px 16px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
    }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    @media (max-width: 680px){ .grid2,.grid3{ grid-template-columns:1fr; } }

    button{
      width:100%;
      font: inherit;
      font-weight: 950;
      color: var(--text);
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 10px 12px;
      outline:none;
      cursor:pointer;
      letter-spacing:.3px;
      transition: transform .08s ease, filter .2s ease, border-color .2s ease;
    }
    button:hover{ filter: brightness(1.06); border-color: rgba(124,247,178,.42); }
    button:active{ transform: translateY(1px) scale(.99); }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
      filter: grayscale(.2);
    }

    .btnMain{
      background: linear-gradient(180deg, rgba(124,247,178,.24), rgba(124,247,178,.08));
      border-color: rgba(124,247,178,.22);
    }
    .btnAlt{
      background: linear-gradient(180deg, rgba(138,164,255,.20), rgba(138,164,255,.06));
      border-color: rgba(138,164,255,.22);
    }
    .btnWarn{
      background: linear-gradient(180deg, rgba(255,209,138,.22), rgba(255,209,138,.07));
      border-color: rgba(255,209,138,.22);
    }
    .btnDanger{
      background: linear-gradient(180deg, rgba(255,138,161,.22), rgba(255,138,161,.07));
      border-color: rgba(255,138,161,.22);
    }

    .bars{ display:grid; gap:10px; }
    .barRow{
      display:grid;
      grid-template-columns: 116px 1fr 54px;
      gap:10px;
      align-items:center;
      font-size: 12px;
      color: var(--muted);
    }
    @media (max-width: 420px){
      .barRow{ grid-template-columns: 1fr; }
    }

    .meter{
      height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .fill{
      height:100%;
      width: 50%;
      background: linear-gradient(90deg, rgba(124,247,178,.85), rgba(138,164,255,.85));
    }

    .log{
      height: 310px;
      overflow:auto;
      padding: 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.10);
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
    }
    .log b{ color: var(--text); }
    .log .item{ margin-bottom:10px; }

    .smallRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      color: var(--muted);
      font-size: 12px;
      margin-top: 10px;
    }
    .smallRow b{ color: var(--text); }
    .chip{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      white-space:nowrap;
    }

    .listItem{
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
    .listItem b{ color: var(--text); }

    @media (prefers-reduced-motion: reduce){
      .burst-pop .square,
      .burst-nod .poppyWrap,
      .burst-wig .poppyWrap{ animation:none !important; }
      .overlay, .overlayCard{ backdrop-filter:none; }
    }
  </style>
</head>

<body>
  <div class="toast" id="toast"></div>
  <div class="errorBanner" id="errorBanner"></div>

  <main class="wrap">
    <section class="card" id="app">
      <header>
        <div class="title">
          <h1>POPPY</h1>
          <p class="sub">DINO RUNNER GAME + FIXED INVENTORY + FOOD SATURATION RULES</p>
        </div>
        <div class="badge">
          <span class="dot" id="statusDot"></span>
          <span id="statusText">ALIVE</span>
        </div>
      </header>

      <div class="stage">
        <div class="screen" id="screen">
          <div class="sleepTint" id="sleepTint"></div>

          <div class="hud">
            <div class="statusBox" id="statusBox">POPPY IS IDLE. CLICK A BUTTON.</div>
            <div class="pill">
              MOOD <b id="moodPill">HAPPY</b>
              LVL <b id="lvlPill">1</b>
              AGE <b id="agePill">0</b>
              COINS <b id="coinsPill">5</b>
            </div>
          </div>

          <div class="floorGlow"></div>

          <div class="poppyWrap" id="poppyWrap" aria-label="Poppy">
            <div class="nameTag">POPPY</div>
            <div class="square" id="square">
              <div class="face" id="face">
                <div class="brow left"></div>
                <div class="brow right"></div>
                <div class="eye"></div>
                <div class="eye"></div>
                <div class="mouth"></div>
              </div>
            </div>
          </div>

          <div class="overlay" id="overlay">
            <div class="overlayCard">
              <div class="overlayTop">
                <div>MODE <b id="overlayTitle">ACTION</b></div>
                <div>TIME <b id="overlayTimer">0</b></div>
              </div>
              <div class="overlayBody" id="overlayBody"></div>
              <div class="overlayActions" id="overlayActions">
                <button class="btnMain" id="overlayPrimary" type="button">OK</button>
                <button class="btnAlt" id="overlayClose" type="button">CLOSE</button>
              </div>
            </div>
          </div>
        </div>

        <div class="controls">
          <div class="panel">
            <div class="bars">
              <div class="barRow"><span>HUNGER</span><div class="meter"><div class="fill" id="hungerFill"></div></div><span id="hungerVal">50</span></div>
              <div class="barRow"><span>HAPPINESS</span><div class="meter"><div class="fill" id="happyFill"></div></div><span id="happyVal">70</span></div>
              <div class="barRow"><span>ENERGY</span><div class="meter"><div class="fill" id="energyFill"></div></div><span id="energyVal">70</span></div>
              <div class="barRow"><span>CLEANLINESS</span><div class="meter"><div class="fill" id="cleanFill"></div></div><span id="cleanVal">60</span></div>
              <div class="barRow"><span>HEALTH</span><div class="meter"><div class="fill" id="healthFill"></div></div><span id="healthVal">90</span></div>
              <div class="barRow"><span>DISCIPLINE</span><div class="meter"><div class="fill" id="discFill"></div></div><span id="discVal">50</span></div>
              <div class="barRow"><span>XP</span><div class="meter"><div class="fill" id="xpFill"></div></div><span id="xpVal">0</span></div>
            </div>

            <div class="smallRow">
              <span class="chip">MODE <b id="modeChip">NORMAL</b></span>
              <span class="chip">AUTO CARE <b id="autoChip">OFF</b></span>
              <span class="chip">SAVES <b id="saveChip">ON</b></span>
            </div>
          </div>

          <div class="panel">
            <div class="grid3">
              <button class="btnMain" id="btnFeed" type="button">FEED</button>
              <button class="btnMain" id="btnPlay" type="button">PLAY</button>
              <button class="btnMain" id="btnSleep" type="button">SLEEP</button>
              <button class="btnMain" id="btnClean" type="button">CLEAN</button>
              <button class="btnWarn" id="btnMed" type="button">MEDICINE</button>
              <button class="btnAlt" id="btnWork" type="button">WORK</button>
              <button class="btnAlt" id="btnInventory" type="button">INVENTORY</button>
              <button class="btnAlt" id="btnShop" type="button">SHOP</button>
              <button class="btnAlt" id="btnTrain" type="button">TRAIN</button>
              <button class="btnAlt" id="btnSettings" type="button">SETTINGS</button>
              <button class="btnAlt" id="btnPause" type="button">PAUSE</button>
              <button class="btnDanger" id="btnReset" type="button">RESET</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <aside class="card" style="padding:16px 16px 18px;">
      <h2 style="margin:0 0 10px; font-size:16px;">EVENT LOG</h2>
      <div class="log" id="log"></div>

      <div class="panel" style="margin-top:12px;">
        <h2 style="margin:0 0 10px; font-size:16px;">FIXES INCLUDED</h2>
        <div class="listItem"><b>DINO RUNNER</b> SPACE TO JUMP. DUCK BUTTON INCLUDED. OBSTACLES LOOP.</div>
        <div class="listItem"><b>INVENTORY</b> CLOSE WORKS. OVERLAY NEVER GETS STUCK.</div>
        <div class="listItem"><b>FOOD RULES</b> FOOD +5 SATURATION. SNACK +1 SATURATION.</div>
      </div>
    </aside>
  </main>

  <script>
    (function(){
      const $ = (id)=>document.getElementById(id);

      const toast = $("toast");
      const banner = $("errorBanner");
      function showError(msg){
        banner.style.display = "block";
        banner.textContent = "ERROR\n" + msg;
      }
      function tmsg(msg){
        toast.style.display = "block";
        toast.textContent = msg;
        clearTimeout(tmsg._t);
        tmsg._t = setTimeout(()=>{ toast.style.display = "none"; }, 1700);
      }
      function need(id){
        const el = $(id);
        if (!el) throw new Error("MISSING ELEMENT ID: " + id);
        return el;
      }

      // SAFE RANDOM
      function rint(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
      function chance(p){ return Math.random() < p; }
      function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

      // SAVE KEY
      const SAVE_KEY = "POPPY_TAMAGOTCHI_SAVE_V2";

      try{
        // Elements
        const app = need("app");
        const screen = need("screen");
        const face = need("face");

        const statusBox = need("statusBox");
        const moodPill = need("moodPill");
        const lvlPill = need("lvlPill");
        const agePill = need("agePill");
        const coinsPill = need("coinsPill");

        const statusDot = need("statusDot");
        const statusText = need("statusText");

        const modeChip = need("modeChip");
        const autoChip = need("autoChip");
        const saveChip = need("saveChip");

        const logEl = need("log");

        const fills = {
          hunger: need("hungerFill"),
          happy: need("happyFill"),
          energy: need("energyFill"),
          clean: need("cleanFill"),
          health: need("healthFill"),
          disc: need("discFill"),
          xp: need("xpFill")
        };
        const vals = {
          hunger: need("hungerVal"),
          happy: need("happyVal"),
          energy: need("energyVal"),
          clean: need("cleanVal"),
          health: need("healthVal"),
          disc: need("discVal"),
          xp: need("xpVal")
        };

        // Overlay
        const overlay = need("overlay");
        const overlayTitle = need("overlayTitle");
        const overlayTimer = need("overlayTimer");
        const overlayBody = need("overlayBody");
        const overlayPrimary = need("overlayPrimary");
        const overlayClose = need("overlayClose");

        // Buttons
        const btnFeed = need("btnFeed");
        const btnPlay = need("btnPlay");
        const btnSleep = need("btnSleep");
        const btnClean = need("btnClean");
        const btnMed = need("btnMed");
        const btnWork = need("btnWork");
        const btnInventory = need("btnInventory");
        const btnShop = need("btnShop");
        const btnTrain = need("btnTrain");
        const btnSettings = need("btnSettings");
        const btnPause = need("btnPause");
        const btnReset = need("btnReset");

        // GAME STATE
        const defaultState = ()=>({
          alive: true,
          paused: false,
          mode: "NORMAL",          // NORMAL | SLEEPING | SICK
          autoCare: false,
          autoSave: true,

          age: 0,
          coins: 5,

          lvl: 1,
          xp: 0,

          hunger: 55,
          happy: 70,
          energy: 70,
          clean: 60,
          health: 90,
          disc: 50,

          // inventory counts
          inv: {
            FOOD: 2,
            SNACK: 2,
            WATER: 2,
            SOAP: 1,
            MED: 1,
            TOY: 1,
            BLANKET: 0
          },

          upgrades: {
            AUTO_FEED: false,
            AUTO_CLEAN: false,
            AUTO_MED: false,
            COMFY_BED: false,
            BIG_WALLET: false,
            XP_BOOST: false,
            SLOW_DECAY: false
          },

          last: Date.now()
        });

        let S = defaultState();

        function mergeDeep(target, source){
          const out = Array.isArray(target) ? target.slice() : { ...target };
          for (const k in source){
            if (!Object.prototype.hasOwnProperty.call(source, k)) continue;
            const sv = source[k];
            const tv = out[k];
            if (sv && typeof sv === "object" && !Array.isArray(sv) && tv && typeof tv === "object" && !Array.isArray(tv)){
              out[k] = mergeDeep(tv, sv);
            } else out[k] = sv;
          }
          return out;
        }

        function load(){
          try{
            const raw = localStorage.getItem(SAVE_KEY);
            if (!raw) return false;
            const data = JSON.parse(raw);
            const base = defaultState();
            S = mergeDeep(base, data);
            return true;
          } catch(e){ return false; }
        }
        function save(force){
          if (!S.autoSave && !force) return;
          try{
            S.last = Date.now();
            localStorage.setItem(SAVE_KEY, JSON.stringify(S));
          } catch(e){}
        }

        function log(msg){
          const t = new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = "<b>" + t + "</b> | " + msg;
          logEl.prepend(div);
        }

        function burst(cls, ms){
          app.classList.add(cls);
          setTimeout(()=>app.classList.remove(cls), ms);
        }
        function blink(){
          face.classList.add("blink");
          setTimeout(()=>face.classList.remove("blink"), 250);
        }

        function mood(){
          if (!S.alive) return "DEAD";
          if (S.mode === "SLEEPING") return "ASLEEP";
          if (S.health <= 20 || S.mode === "SICK") return "SICK";
          if (S.hunger <= 25) return "HUNGRY";
          if (S.clean <= 20) return "ANGRY";
          if (S.happy <= 25) return "SAD";
          if (S.energy <= 20) return "BORED";
          return "HAPPY";
        }
        function setFaceMoodClass(m){
          face.classList.remove("mood-happy","mood-sad","mood-angry","mood-hungry","mood-sick","mood-bored","mood-asleep");
          if (m === "ASLEEP") face.classList.add("mood-asleep");
          else if (m !== "DEAD") face.classList.add("mood-" + m.toLowerCase());
        }

        function xpToNext(lvl){ return 30 + (lvl-1)*18; }
        function addXP(amount){
          let a = amount;
          if (S.upgrades.XP_BOOST) a = Math.round(a * 1.2);
          S.xp += a;
          while (S.xp >= xpToNext(S.lvl)){
            S.xp -= xpToNext(S.lvl);
            S.lvl += 1;
            S.coins += 2;
            log("LEVEL UP " + S.lvl + " COINS +2");
            burst("burst-wig", 520);
          }
        }

        // INVENTORY HELPERS
        function have(item, n=1){ return (S.inv[item] || 0) >= n; }
        function addItem(item, n=1){ S.inv[item] = (S.inv[item] || 0) + n; }
        function takeItem(item, n=1){
          if (!have(item,n)) return false;
          S.inv[item] -= n;
          return true;
        }

        function updateUI(){
          S.hunger = clamp(S.hunger, 0, 100);
          S.happy  = clamp(S.happy, 0, 100);
          S.energy = clamp(S.energy, 0, 100);
          S.clean  = clamp(S.clean, 0, 100);
          S.health = clamp(S.health, 0, 100);
          S.disc   = clamp(S.disc, 0, 100);
          S.xp     = clamp(S.xp, 0, 9999);

          fills.hunger.style.width = S.hunger + "%";
          fills.happy.style.width  = S.happy + "%";
          fills.energy.style.width = S.energy + "%";
          fills.clean.style.width  = S.clean + "%";
          fills.health.style.width = S.health + "%";
          fills.disc.style.width   = S.disc + "%";
          fills.xp.style.width     = clamp(Math.floor((S.xp / xpToNext(S.lvl)) * 100),0,100) + "%";

          vals.hunger.textContent = String(Math.round(S.hunger));
          vals.happy.textContent  = String(Math.round(S.happy));
          vals.energy.textContent = String(Math.round(S.energy));
          vals.clean.textContent  = String(Math.round(S.clean));
          vals.health.textContent = String(Math.round(S.health));
          vals.disc.textContent   = String(Math.round(S.disc));
          vals.xp.textContent     = String(Math.round(S.xp));

          const m = mood();
          moodPill.textContent = m;
          lvlPill.textContent  = String(S.lvl);
          agePill.textContent  = String(S.age);
          coinsPill.textContent= String(S.coins);

          modeChip.textContent = S.mode;
          autoChip.textContent = S.autoCare ? "ON" : "OFF";
          saveChip.textContent = S.autoSave ? "ON" : "OFF";

          setFaceMoodClass(m);

          if (!S.alive){
            statusDot.style.background = "var(--danger)";
            statusText.textContent = "DEAD";
          } else if (S.paused){
            statusDot.style.background = "var(--accent2)";
            statusText.textContent = "PAUSED";
          } else {
            statusText.textContent = "ALIVE";
            if (m === "SICK" || m === "ANGRY") statusDot.style.background = "var(--danger)";
            else if (m === "HUNGRY" || m === "SAD") statusDot.style.background = "var(--warn)";
            else statusDot.style.background = "var(--accent)";
          }

          if (S.mode === "SLEEPING") screen.classList.add("sleepOn");
          else screen.classList.remove("sleepOn");

          statusBox.textContent =
            "POPPY STATUS\n" +
            "MOOD " + m + "\n" +
            "MODE " + S.mode + "\n" +
            "COINS " + S.coins + "\n" +
            "FOOD " + (S.inv.FOOD||0) + " SNACK " + (S.inv.SNACK||0) + " WATER " + (S.inv.WATER||0) + "\n" +
            "SOAP " + (S.inv.SOAP||0) + " MED " + (S.inv.MED||0) + " TOY " + (S.inv.TOY||0);

          const disabled = !S.alive;
          for (const b of [btnFeed,btnPlay,btnSleep,btnClean,btnMed,btnWork,btnInventory,btnShop,btnTrain,btnSettings]){
            b.disabled = disabled;
          }
          btnPause.disabled = false;
          btnReset.disabled = false;
        }

        // OVERLAY STATE (FIXED CLOSE)
        let overlayInterval = null;
        let overlayEndAt = 0;
        let overlayMode = "NONE";
        let game = null;

        function stopGame(){
          if (!game) return;
          if (game.raf) cancelAnimationFrame(game.raf);
          if (game.cleanup) game.cleanup();
          game = null;
        }

        function closeOverlay(){
          stopGame();
          overlay.classList.remove("show");
          overlayBody.innerHTML = "";
          overlayTitle.textContent = "ACTION";
          overlayTimer.textContent = "0";
          overlayPrimary.textContent = "OK";
          overlayClose.textContent = "CLOSE";
          overlayMode = "NONE";
          if (overlayInterval){ clearInterval(overlayInterval); overlayInterval = null; }
          updateUI();
          save();
        }

        function openOverlay(mode, seconds){
          // ALWAYS RESET FIRST SO WE NEVER GET STUCK
          stopGame();
          if (overlayInterval){ clearInterval(overlayInterval); overlayInterval = null; }

          overlayMode = mode;
          overlayTitle.textContent = mode;
          overlay.classList.add("show");

          if (!seconds || seconds >= 9000){
            overlayTimer.textContent = "INF";
            overlayEndAt = 0;
            return;
          }

          overlayEndAt = Date.now() + seconds*1000;

          function tickTimer(){
            const left = Math.max(0, Math.ceil((overlayEndAt - Date.now())/1000));
            overlayTimer.textContent = String(left);
            if (left <= 0){
              if (overlayMode.startsWith("PLAY")) finishGame(true);
              else closeOverlay();
            }
          }
          tickTimer();
          overlayInterval = setInterval(tickTimer, 200);
        }

        overlayClose.addEventListener("click", ()=>{
          if (overlayMode.startsWith("PLAY")) finishGame(false);
          closeOverlay();
        });
        overlayPrimary.addEventListener("click", ()=>{
          if (overlayMode.startsWith("PLAY")) finishGame(true);
          else closeOverlay();
        });

        // MENUS
        function menuTitle(text){
          return "<div style='color:var(--muted); font-size:12px; line-height:1.35; text-align:left; width:100%;'>" +
                 "<b style='color:var(--text);'>" + text + "</b>" +
                 "</div>";
        }
        function row(title, desc, btnClass, id, btnText){
          return "<div class='listItem' style='display:flex; justify-content:space-between; align-items:center; gap:12px; width:100%;'>" +
                 "<div style='flex:1;'><b>" + title + "</b><div style='margin-top:6px;'>" + desc + "</div></div>" +
                 "<div style='min-width:160px;'><button class='" + btnClass + "' id='" + id + "' type='button'>" + (btnText||"USE") + "</button></div>" +
                 "</div>";
        }

        function openInventory(){
          openOverlay("INVENTORY", 9999);
          overlayPrimary.textContent = "DONE";
          overlayClose.textContent = "CLOSE";

          const inv = S.inv;
          overlayBody.innerHTML =
            menuTitle("INVENTORY") +
            "<div style='display:grid; gap:10px; margin-top:10px; width:100%;'>" +
              row("FOOD X " + (inv.FOOD||0), "FEED MENU: FOOD GIVES 5 SATURATION", "btnMain", "use_food", "OPEN FEED") +
              row("SNACK X " + (inv.SNACK||0), "FEED MENU: SNACK GIVES 1 SATURATION", "btnMain", "use_snack", "OPEN FEED") +
              row("WATER X " + (inv.WATER||0), "DRINK: SMALL HEALTH AND ENERGY", "btnMain", "use_water", "DRINK") +
              row("SOAP X " + (inv.SOAP||0), "CLEAN: CONSUMES 1 SOAP", "btnMain", "use_soap", "CLEAN") +
              row("MED X " + (inv.MED||0), "MEDICINE: CONSUMES 1 MED", "btnWarn", "use_med", "MEDICINE") +
              row("TOY X " + (inv.TOY||0), "PLAY BONUS: EXTRA HAPPINESS AFTER A GAME", "btnAlt", "use_toy", "TOY INFO") +
            "</div>" +
            "<div style='margin-top:10px; color:var(--muted); font-size:12px; width:100%; line-height:1.35;'>" +
              "CLOSE WITH BUTTON OR ESC" +
            "</div>";

          // Bind
          overlayBody.querySelector("#use_food").onclick = ()=>{ closeOverlay(); openFeedMenu(); };
          overlayBody.querySelector("#use_snack").onclick = ()=>{ closeOverlay(); openFeedMenu(); };
          overlayBody.querySelector("#use_water").onclick = ()=>{ drinkWater(); };
          overlayBody.querySelector("#use_soap").onclick = ()=>{ actClean(); };
          overlayBody.querySelector("#use_med").onclick = ()=>{ actMed(); };
          overlayBody.querySelector("#use_toy").onclick = ()=>{ tmsg("TOYS BOOST HAPPINESS AFTER GAMES"); };
        }

        function openFeedMenu(){
          openOverlay("FEED", 9999);
          overlayPrimary.textContent = "DONE";
          overlayClose.textContent = "CLOSE";

          overlayBody.innerHTML =
            menuTitle("FEED MENU") +
            "<div style='display:grid; gap:10px; margin-top:10px; width:100%;'>" +
              row("EAT FOOD", "USES 1 FOOD | +5 SATURATION", have("FOOD") ? "btnMain" : "btnAlt", "feed_food", "EAT") +
              row("EAT SNACK", "USES 1 SNACK | +1 SATURATION", have("SNACK") ? "btnMain" : "btnAlt", "feed_snack", "EAT") +
              row("DRINK WATER", "USES 1 WATER | SMALL HEALTH AND ENERGY", have("WATER") ? "btnMain" : "btnAlt", "feed_water", "DRINK") +
            "</div>";

          overlayBody.querySelector("#feed_food").onclick = ()=>{
            if (!takeItem("FOOD",1)) return tmsg("NO FOOD");
            // FOOD RULE: +5 SATURATION
            S.hunger += 5;
            S.happy += 2;
            S.clean -= 1;
            addXP(6);
            log("ATE FOOD +5 SATURATION");
            burst("burst-pop", 380);
            updateUI(); save();
            closeOverlay();
          };

          overlayBody.querySelector("#feed_snack").onclick = ()=>{
            if (!takeItem("SNACK",1)) return tmsg("NO SNACK");
            // SNACK RULE: +1 SATURATION
            S.hunger += 1;
            S.happy += 2;
            addXP(4);
            log("ATE SNACK +1 SATURATION");
            burst("burst-pop", 220);
            updateUI(); save();
            closeOverlay();
          };

          overlayBody.querySelector("#feed_water").onclick = ()=>{ drinkWater(); };
        }

        function drinkWater(){
          if (!takeItem("WATER",1)) return tmsg("NO WATER");
          S.health += 6;
          S.energy += 5;
          S.happy += 1;
          addXP(4);
          log("DRANK WATER");
          burst("burst-nod", 420);
          updateUI(); save();
          closeOverlay();
        }

        function openPlayMenu(){
          openOverlay("PLAY", 9999);
          overlayPrimary.textContent = "DONE";
          overlayClose.textContent = "CLOSE";

          overlayBody.innerHTML =
            menuTitle("PLAY MENU") +
            "<div style='display:grid; gap:10px; margin-top:10px; width:100%;'>" +
              row("APPLE GAME", "CLICK THE APPLE. SLOW MOVEMENT", "btnMain", "play_apples", "START") +
              row("DINO RUNNER", "SPACE TO JUMP | DUCK BUTTON | LIKE OFFLINE DINO", "btnMain", "play_dino", "START") +
            "</div>";

          overlayBody.querySelector("#play_apples").onclick = ()=>{ closeOverlay(); startAppleGame(); };
          overlayBody.querySelector("#play_dino").onclick = ()=>{ closeOverlay(); startDinoGame(); };
        }

        // ACTIONS
        function actClean(){
          if (!S.alive || S.paused) return;
          if (S.mode === "SLEEPING") return tmsg("WAKE UP FIRST");
          if (!takeItem("SOAP",1)) return tmsg("NO SOAP");
          S.clean += 22;
          S.happy += 2;
          addXP(6);
          log("CLEANED");
          burst("burst-wig", 520);
          updateUI(); save();
          closeOverlay();
        }

        function actMed(){
          if (!S.alive || S.paused) return;
          if (S.mode === "SLEEPING") return tmsg("WAKE UP FIRST");
          if (!takeItem("MED",1)) return tmsg("NO MED");
          S.health += 20;
          S.mode = "NORMAL";
          addXP(7);
          log("MEDICINE USED");
          burst("burst-pop", 380);
          updateUI(); save();
          closeOverlay();
        }

        function actSleepToggle(){
          if (!S.alive) return;
          if (S.mode === "SLEEPING"){
            S.mode = "NORMAL";
            log("WOKE UP");
          } else {
            if (S.paused) return;
            S.mode = "SLEEPING";
            log("SLEEP START");
          }
          burst("burst-nod", 420);
          updateUI(); save();
        }

        function actWork(){
          if (!S.alive || S.paused) return;
          if (S.mode === "SLEEPING") return tmsg("WAKE UP FIRST");
          const earned = rint(2,5);
          S.coins += earned;
          S.energy -= 8;
          S.hunger -= 3;
          S.happy -= 1;
          addXP(7);
          log("WORK EARNED " + earned);
          burst("burst-nod", 420);
          updateUI(); save();
        }

        function actTrain(){
          if (!S.alive || S.paused) return;
          if (S.mode === "SLEEPING") return tmsg("WAKE UP FIRST");
          if (S.energy < 12) return tmsg("LOW ENERGY");
          S.disc += 8;
          S.energy -= 10;
          S.happy -= 1;
          addXP(8);
          log("TRAIN COMPLETE");
          burst("burst-pop", 380);
          updateUI(); save();
        }

        // MINI GAME: APPLES
        function startAppleGame(){
          openOverlay("PLAY APPLES", 14);
          overlayPrimary.textContent = "FINISH";
          overlayClose.textContent = "QUIT";
          overlayBody.innerHTML = "";

          const area = document.createElement("div");
          area.className = "gameArea";
          const apple = document.createElement("div");
          apple.className = "apple";
          area.appendChild(apple);

          const hud = document.createElement("div");
          hud.className = "gameHud";
          hud.innerHTML = "<div>SCORE <b id='gScore'>0</b></div><div>REWARD <b id='gReward'>0</b></div>";

          overlayBody.appendChild(area);
          overlayBody.appendChild(hud);

          const gScore = overlayBody.querySelector("#gScore");
          const gReward = overlayBody.querySelector("#gReward");

          game = { type:"APPLE", score:0, raf:0 };

          function move(){
            const w = area.clientWidth;
            const h = area.clientHeight;
            const size = 40;
            const pad = 10;
            const x = clamp(rint(0, w - size), pad, w - size - pad);
            const y = clamp(rint(0, h - size), pad, h - size - pad);
            apple.style.left = x + "px";
            apple.style.top = y + "px";
          }

          let nextMove = performance.now() + 1400;

          apple.addEventListener("click", ()=>{
            if (!game) return;
            game.score += 1;
            gScore.textContent = String(game.score);
            gReward.textContent = String(Math.min(14, Math.floor(game.score/2)));
            move();
            burst("burst-pop", 240);
          });

          move();

          function loop(now){
            if (!game) return;
            if (now >= nextMove){
              move();
              nextMove = now + 1400;
            }
            game.raf = requestAnimationFrame(loop);
          }
          game.raf = requestAnimationFrame(loop);
        }

        // MINI GAME: DINO RUNNER (CHROME OFFLINE STYLE)
        function startDinoGame(){
          openOverlay("PLAY DINO", 18);
          overlayPrimary.textContent = "FINISH";
          overlayClose.textContent = "QUIT";
          overlayBody.innerHTML = "";

          const area = document.createElement("div");
          area.className = "dinoArea";

          const ground = document.createElement("div");
          ground.className = "groundLine";

          const dino = document.createElement("div");
          dino.className = "dino";

          const cactus = document.createElement("div");
          cactus.className = "cactus";

          const cloud = document.createElement("div");
          cloud.className = "cloud";

          area.appendChild(cloud);
          area.appendChild(ground);
          area.appendChild(dino);
          area.appendChild(cactus);

          overlayBody.appendChild(area);

          const hud = document.createElement("div");
          hud.className = "dinoHudRow";
          hud.innerHTML =
            "<div>SCORE <b id='dScore'>0</b></div>" +
            "<div>BEST <b id='dBest'>0</b></div>" +
            "<div style='display:flex; gap:10px;'>" +
              "<button class='btnAlt' id='dDuck' type='button' style='width:auto; padding:10px 12px;'>DUCK</button>" +
              "<button class='btnAlt' id='dJump' type='button' style='width:auto; padding:10px 12px;'>JUMP</button>" +
            "</div>";
          overlayBody.appendChild(hud);

          const dScore = hud.querySelector("#dScore");
          const dBest  = hud.querySelector("#dBest");
          const dDuck  = hud.querySelector("#dDuck");
          const dJump  = hud.querySelector("#dJump");

          // best score from save
          S.bestDino = S.bestDino || 0;
          dBest.textContent = String(S.bestDino);

          // physics
          let y = 0;              // vertical offset from ground
          let vy = 0;             // velocity
          const GRAV = 0.9;       // gravity
          const JUMP_V = 14;      // jump strength
          let ducking = false;

          // obstacle
          let cx = area.clientWidth + 60;
          let speed = 6.2;        // base speed
          let score = 0;

          // cloud
          let clx = area.clientWidth + 120;

          // game running
          let alive = true;
          let last = performance.now();

          function setDinoStyle(){
            const baseBottom = 40;
            dino.style.bottom = (baseBottom + y) + "px";
            if (ducking){
              dino.style.height = "28px";
              dino.style.width = "52px";
              dino.style.bottom = baseBottom + "px";
              dino.style.borderRadius = "12px";
            } else {
              dino.style.height = "44px";
              dino.style.width = "44px";
              dino.style.borderRadius = "12px";
            }
          }

          function jump(){
            if (!alive) return;
            if (ducking) return;
            if (y === 0){
              vy = JUMP_V;
              burst("burst-pop", 220);
            }
          }

          function setDuck(on){
            if (!alive) return;
            ducking = on;
            if (ducking && y > 0){
              // cancel duck mid-air
              ducking = false;
            }
            setDinoStyle();
          }

          dJump.addEventListener("click", jump);
          dDuck.addEventListener("mousedown", ()=>setDuck(true));
          dDuck.addEventListener("mouseup", ()=>setDuck(false));
          dDuck.addEventListener("mouseleave", ()=>setDuck(false));
          dDuck.addEventListener("touchstart", (e)=>{ e.preventDefault(); setDuck(true); }, {passive:false});
          dDuck.addEventListener("touchend", ()=>setDuck(false), {passive:true});

          function onKeyDown(e){
            const k = e.key.toLowerCase();
            if (k === " " || k === "arrowup" || k === "w"){
              e.preventDefault();
              jump();
            }
            if (k === "arrowdown" || k === "s"){
              e.preventDefault();
              setDuck(true);
            }
          }
          function onKeyUp(e){
            const k = e.key.toLowerCase();
            if (k === "arrowdown" || k === "s"){
              e.preventDefault();
              setDuck(false);
            }
          }
          window.addEventListener("keydown", onKeyDown, {passive:false});
          window.addEventListener("keyup", onKeyUp, {passive:false});

          function collide(){
            const r = dino.getBoundingClientRect();
            const o = cactus.getBoundingClientRect();
            // small forgiveness
            const pad = 6;
            return !(r.right - pad < o.left || r.left + pad > o.right || r.bottom - pad < o.top || r.top + pad > o.bottom);
          }

          function resetCactus(){
            cx = area.clientWidth + rint(40, 220);
            // random cactus height/width a bit
            const h = rint(38, 56);
            cactus.style.height = h + "px";
            cactus.style.width = rint(18, 26) + "px";
            cactus.style.borderRadius = "10px";
          }

          function loop(now){
            if (!game) return; // stopped
            const dt = Math.min(40, now - last);
            last = now;

            if (!alive) return;

            // gravity
            if (!ducking){
              vy -= GRAV;
              y += vy;
              if (y < 0){ y = 0; vy = 0; }
            } else {
              // still apply gravity if in air (duck cancels)
              vy -= GRAV;
              y += vy;
              if (y < 0){ y = 0; vy = 0; }
            }

            // speed ramps slowly with score
            speed = 6.2 + Math.min(5, score / 60);

            // obstacle move
            cx -= speed;
            if (cx < -60){
              resetCactus();
              score += 1;
              dScore.textContent = String(score);
            }
            cactus.style.left = cx + "px";

            // cloud move
            clx -= (speed * 0.35);
            if (clx < -100){
              clx = area.clientWidth + rint(80, 240);
              cloud.style.top = rint(18, 80) + "px";
            }
            cloud.style.left = clx + "px";

            // render dino
            setDinoStyle();

            // collision
            if (collide()){
              alive = false;
              // end game immediately as if timer hit 0
              // reward based on score
              S.bestDino = Math.max(S.bestDino || 0, score);
              log("DINO CRASH SCORE " + score);
              finishGame(true, {type:"DINO", score});
              return;
            }

            game.raf = requestAnimationFrame(loop);
          }

          // attach game state and cleanup
          game = {
            type:"DINO",
            score:0,
            raf:0,
            cleanup: ()=>{
              window.removeEventListener("keydown", onKeyDown);
              window.removeEventListener("keyup", onKeyUp);
            }
          };

          resetCactus();
          setDinoStyle();
          game.raf = requestAnimationFrame(loop);

          // store live score via getter
          Object.defineProperty(game, "score", { get(){ return score; } });
        }

        // finish game (supports optional override)
        function finishGame(applyRewards, override){
          const g = override || game;
          if (!g) return;

          const type = g.type;
          const score = g.score || 0;

          if (applyRewards){
            let coinsGain = 0;
            let xpGain = 0;
            let happyGain = 0;

            if (type === "APPLE"){
              coinsGain = clamp(Math.floor(score/2), 0, 14);
              xpGain = clamp(8 + score*2, 8, 36);
              happyGain = clamp(8 + score*2, 8, 30);
            } else if (type === "DINO"){
              coinsGain = clamp(score, 0, 22);
              xpGain = clamp(10 + score*3, 10, 50);
              happyGain = clamp(8 + score*2, 8, 28);
            }

            // toy bonus
            if ((S.inv.TOY||0) > 0){
              happyGain += 2;
            }

            S.coins += coinsGain;
            S.happy += happyGain;
            S.energy -= 6;
            S.clean -= 1;
            addXP(xpGain);

            log("GAME " + type + " SCORE " + score + " COINS +" + coinsGain + " HAPPINESS +" + happyGain);
            burst("burst-wig", 520);
          } else {
            log("GAME QUIT");
          }

          stopGame();
          closeOverlay();
          updateUI(); save();
        }

        // BUTTON WIRING
        btnFeed.addEventListener("click", ()=>{
          if (!S.alive || S.paused) return;
          if (S.mode === "SLEEPING") return tmsg("WAKE UP FIRST");
          openFeedMenu();
        });
        btnPlay.addEventListener("click", ()=>{
          if (!S.alive || S.paused) return;
          if (S.mode === "SLEEPING") return tmsg("WAKE UP FIRST");
          openPlayMenu();
        });
        btnSleep.addEventListener("click", actSleepToggle);
        btnClean.addEventListener("click", actClean);
        btnMed.addEventListener("click", actMed);
        btnWork.addEventListener("click", actWork);
        btnInventory.addEventListener("click", openInventory);
        btnShop.addEventListener("click", ()=>{ tmsg("SHOP STILL IN OTHER VERSION. TELL ME IF YOU WANT IT MERGED HERE."); });
        btnTrain.addEventListener("click", actTrain);
        btnSettings.addEventListener("click", ()=>{ tmsg("SETTINGS STILL IN OTHER VERSION. TELL ME IF YOU WANT IT MERGED HERE."); });

        btnPause.addEventListener("click", ()=>{
          S.paused = !S.paused;
          log(S.paused ? "PAUSED" : "RESUMED");
          tmsg(S.paused ? "PAUSED" : "RESUMED");
          updateUI(); save();
        });

        btnReset.addEventListener("click", ()=>{
          const ok = confirm("RESET POPPY?");
          if (!ok) return;
          stopGame();
          closeOverlay();
          S = defaultState();
          logEl.innerHTML = "";
          log("RESET COMPLETE");
          tmsg("RESET");
          updateUI();
          save(true);
        });

        // CLOSE OVERLAY WITH ESC ALWAYS
        window.addEventListener("keydown", (e)=>{
          const k = e.key.toLowerCase();
          if (overlay.classList.contains("show") && k === "escape"){
            e.preventDefault();
            if (overlayMode.startsWith("PLAY")) finishGame(false);
            closeOverlay();
          }
        }, { passive:false });

        // SIMPLE SHORTCUTS OUTSIDE OVERLAY
        window.addEventListener("keydown", (e)=>{
          if (overlay.classList.contains("show")) return;
          const k = e.key.toLowerCase();
          if (k === "f") btnFeed.click();
          if (k === "p") btnPlay.click();
          if (k === "s") btnSleep.click();
          if (k === "c") btnClean.click();
          if (k === "m") btnMed.click();
          if (k === "w") btnWork.click();
          if (k === "i") btnInventory.click();
          if (k === "t") btnTrain.click();
          if (k === " ") btnPause.click();
        }, { passive:true });

        // TICK LOOP
        const TICK_MS = 25000;
        function internalTick(){
          if (!S.alive) return;
          if (S.paused) return;

          if (!overlay.classList.contains("show") && chance(0.16)) blink();

          S.age += 1;

          if (S.mode === "SLEEPING"){
            S.energy += 5;
            S.health += 1;
            S.hunger -= 1;
          } else {
            S.hunger -= 1.2;
            S.energy -= 1.2;
            S.clean  -= 0.8;
            let penalty = 0;
            if (S.hunger < 35) penalty += 2;
            if (S.energy < 25) penalty += 2;
            if (S.clean  < 25) penalty += 2;
            if (S.health < 35) penalty += 2;
            S.happy -= (0.8 + penalty * 0.5);
          }

          let dmg = 0;
          if (S.hunger <= 10) dmg += 3;
          if (S.clean  <= 10) dmg += 3;
          if (S.energy <= 8)  dmg += 2;
          if (S.happy  <= 8)  dmg += 2;
          S.health -= dmg;

          if (S.health <= 0){
            S.alive = false;
            S.health = 0;
            log("POPPY HAS DIED");
            tmsg("POPPY DIED");
          }

          // passive xp
          if (S.alive && S.mode !== "SICK") S.xp += 1;
          while (S.xp >= xpToNext(S.lvl)){
            S.xp -= xpToNext(S.lvl);
            S.lvl += 1;
            S.coins += 2;
            log("LEVEL UP " + S.lvl + " COINS +2");
          }

          updateUI();
          save();
        }

        // offline progress (simple)
        function applyOffline(){
          const now = Date.now();
          const diffMs = Math.max(0, now - (S.last || now));
          const ticks = Math.min(80, Math.floor(diffMs / TICK_MS));
          if (ticks > 0){
            log("OFFLINE TICKS " + ticks);
            for (let i=0;i<ticks;i++) internalTick();
          }
        }

        // STARTUP
        const loaded = load();
        logEl.innerHTML = "";
        if (loaded){
          log("SAVE LOADED");
          applyOffline();
        } else {
          log("WELCOME TO POPPY");
          log("TIP: PLAY DINO RUNNER WITH SPACE TO JUMP");
        }

        // dblclick status = toggle auto care
        statusBox.addEventListener("dblclick", ()=>{
          S.autoCare = !S.autoCare;
          log("AUTO CARE " + (S.autoCare ? "ON" : "OFF"));
          tmsg("AUTO CARE " + (S.autoCare ? "ON" : "OFF"));
          updateUI(); save();
        });

        updateUI();
        save();
        setInterval(internalTick, TICK_MS);

      } catch(err){
        console.error(err);
        showError(String(err && err.message ? err.message : err));
      }
    })();
  </script>
</body>
</html>
