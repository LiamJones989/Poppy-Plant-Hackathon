<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Poppy | Mood Bot</title>
  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#101a33;
      --card:rgba(15,23,48,.86);
      --text:#eef2ff;
      --muted:#c7d2ff;
      --accent:#7cf7b2;
      --accent2:#8aa4ff;
      --warn:#ffd18a;
      --danger:#ff8aa1;
      --border:rgba(255,255,255,.14);
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-weight: 800;           /* ALL TEXT BOLD */
      color: var(--text);
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(122,249,184,.16), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(138,164,255,.18), transparent 60%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      padding:22px;
      overflow-x:hidden;
    }

    /* FIX: prevent "missing content" by avoiding vertical centering + forcing scroll */
    .wrap{
      width:min(1100px, 100%);
      margin:0 auto;
      display:grid;
      grid-template-columns: 1.12fr .88fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 900px){ .wrap{ grid-template-columns:1fr; } }

    .card{
      background: var(--card);
      border:1px solid rgba(255,255,255,.08);
      border-color: rgba(124,247,178,.16);
      border-top-color: rgba(138,164,255,.20);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    header{
      padding:18px 18px 10px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }

    .title{ display:flex; flex-direction:column; gap:6px; }
    h1{ margin:0; font-size: clamp(18px, 2.6vw, 26px); letter-spacing:.4px; }
    .sub{ margin:0; color: var(--muted); font-size: 13px; letter-spacing:.2px; }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      user-select:none;
    }
    .badge .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 6px rgba(124,247,178,.10);
    }

    .stage{
      padding: 14px 18px 18px;
      display:grid;
      gap:14px;
    }

    .plantArea{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(520px 260px at 50% 35%, rgba(124,247,178,.16), transparent 60%),
        radial-gradient(560px 260px at 50% 60%, rgba(138,164,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.10));
      height: 420px;                /* FIX: consistent stage height */
      position:relative;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 10px;
    }

    .floorGlow{
      position:absolute;
      bottom:-80px;
      width: 620px;
      height: 260px;
      border-radius: 999px;
      background: radial-gradient(circle at 50% 35%, rgba(124,247,178,.25), transparent 62%);
      filter: blur(2px);
      opacity:.85;
      pointer-events:none;
    }

    .speech{
      position:absolute;
      top: 14px;
      left: 14px;
      right: 14px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      pointer-events:none;
    }
    .bubble{
      max-width: 72%;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(6px);
      font-size: 13px;
      line-height: 1.25;
      box-shadow: 0 12px 26px rgba(0,0,0,.35);
      white-space: pre-line;         /* MULTI-LINE RESPONSES */
    }
    .chip{
      padding: 9px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      color: var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .chip b{ color:var(--text); }

    /* ===== POPPY: GREEN SQUARE CHARACTER ===== */
    .poppyWrap{
      position:relative;
      width: 280px;
      height: 320px;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      transform-origin: 50% 90%;
    }

    .nameTag{
      position:absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(0,0,0,.18));
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      letter-spacing: .9px;
      text-transform: uppercase;
      user-select:none;
      font-size: 12px;
    }

    .square{
      width: 170px;
      height: 170px;
      border-radius: 22px;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.28), transparent 55%),
        linear-gradient(180deg, rgba(185,255,217,1), rgba(47,228,138,1));
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .face{
      width: 120px;
      height: 78px;
      border-radius: 22px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(10px);
      box-shadow: 0 16px 26px rgba(0,0,0,.20);
      position:absolute;
      bottom: 32px;
      left: 50%;
      transform: translateX(-50%);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:18px;
      padding-top:10px;
    }

    .eye{
      width: 15px;
      height: 15px;
      border-radius: 999px;
      background: #0b1020;
      box-shadow: 0 0 0 7px rgba(255,255,255,.10);
      position:relative;
      overflow:hidden;
    }
    .eye:after{
      content:"";
      position:absolute;
      width: 7px;height:7px;border-radius:999px;
      background: rgba(255,255,255,.90);
      top: 2px; left: 2px;
    }

    .mouth{
      position:absolute;
      left: 50%;
      bottom: 14px;
      transform: translateX(-50%);
      width: 38px;
      height: 18px;
      border: 3px solid rgba(11,16,32,.92);
      border-top: none;
      border-radius: 0 0 28px 28px;
      background: transparent;
    }

    .brow{
      position:absolute;
      top: 10px;
      width: 24px;
      height: 6px;
      border-radius: 999px;
      background: rgba(11,16,32,.92);
      opacity:0;
    }
    .brow.left{ left: 22px; transform: rotate(-10deg); }
    .brow.right{ right: 22px; transform: rotate(10deg); }

    /* Mood faces */
    .mood-happy .mouth{ width: 46px; height: 22px; border-radius: 0 0 30px 30px; }
    .mood-sad .mouth{
      bottom: 18px;
      width: 46px; height: 18px;
      border-top: 3px solid rgba(11,16,32,.92);
      border-bottom:none;
      border-radius: 30px 30px 0 0;
    }
    .mood-silly .mouth{
      width: 18px; height: 18px;
      border: 3px solid rgba(11,16,32,.92);
      border-radius: 999px;
    }
    .mood-tired .mouth{
      width: 34px; height: 7px;
      border: none;
      background: rgba(11,16,32,.92);
      border-radius: 999px;
    }
    .mood-tired .eye{ height: 11px; }
    .mood-angry .mouth{
      width: 38px; height: 16px;
      border-top: 3px solid rgba(11,16,32,.92);
      border-bottom:none;
      border-radius: 22px 22px 0 0;
    }
    .mood-angry .brow{ opacity:1; }
    .mood-angry .brow.left{ transform: rotate(18deg); }
    .mood-angry .brow.right{ transform: rotate(-18deg); }

    /* Confetti */
    .spark{
      position:absolute;
      width: 10px;height: 10px;
      border-radius: 3px;
      background: rgba(255,255,255,.95);
      opacity:0;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      pointer-events:none;
    }

    /* Controls */
    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 560px){ .controls{ grid-template-columns:1fr; } }

    .panel{
      padding: 14px 14px 16px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 7px;
      letter-spacing:.2px;
    }

    select, input[type="range"], button, textarea{
      width:100%;
      font: inherit;
      font-weight: 900;
      color: var(--text);
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 10px 12px;
      outline:none;
    }

    textarea{ resize: vertical; min-height: 82px; }

    select:focus, button:focus, textarea:focus{
      border-color: rgba(124,247,178,.38);
      box-shadow: 0 0 0 4px rgba(124,247,178,.12);
    }

    .row{ display:flex; gap:10px; align-items:center; }
    .row > *{ flex:1; }

    .btn{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(124,247,178,.24), rgba(124,247,178,.08));
      transition: transform .08s ease, filter .2s ease, border-color .2s ease;
      letter-spacing:.3px;
    }
    .btn:hover{ filter: brightness(1.06); border-color: rgba(124,247,178,.40); }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn.secondary{
      background: linear-gradient(180deg, rgba(138,164,255,.20), rgba(138,164,255,.06));
    }

    .readout{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .meter{
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      flex:1;
    }
    .meter > span{
      display:block;
      height:100%;
      width: 55%;
      background: linear-gradient(90deg, rgba(124,247,178,.85), rgba(138,164,255,.85));
    }

    .hint{
      margin-top: 12px;
      padding: 12px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,.18);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
      background: rgba(255,255,255,.03);
      letter-spacing:.2px;
    }
    .kbd{
      display:inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-weight: 900;
      font-size: 11px;
      transform: translateY(-1px);
      letter-spacing:.3px;
    }

    /* Right */
    .side{ padding: 16px 16px 18px; }
    .side h2{ margin:0 0 6px; font-size: 16px; letter-spacing:.3px; }
    .side p{ margin:0 0 14px; color: var(--muted); font-size: 13px; line-height: 1.4; letter-spacing:.2px; }

    .log{
      height: 230px;
      overflow:auto;
      padding: 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.10);
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
      letter-spacing:.2px;
    }
    .log b{ color: var(--text); }
    .log .item{ margin-bottom:10px; }

    /* Animations */
    @keyframes wiggle {
      0%{ transform: rotate(0deg) translateY(0) }
      15%{ transform: rotate(-10deg) translateY(-1px) }
      35%{ transform: rotate(12deg) translateY(-2px) }
      55%{ transform: rotate(-8deg) translateY(-1px) }
      75%{ transform: rotate(10deg) translateY(-2px) }
      100%{ transform: rotate(0deg) translateY(0) }
    }
    @keyframes bounce {
      0%,100%{ transform: translateY(0) }
      25%{ transform: translateY(-16px) }
      55%{ transform: translateY(0) }
      75%{ transform: translateY(-8px) }
    }
    @keyframes discoSpin { 0%{ transform: rotate(0deg) } 100%{ transform: rotate(360deg) } }
    @keyframes headBob {
      0%,100%{ transform: translateX(-50%) translateY(0) }
      25%{ transform: translateX(-50%) translateY(-3px) }
      50%{ transform: translateX(-50%) translateY(2px) }
      75%{ transform: translateX(-50%) translateY(-2px) }
    }
    @keyframes sparkPop {
      0%{ opacity:0; transform: translate(-50%,-50%) scale(.3) rotate(0deg) }
      20%{ opacity:1 }
      100%{ opacity:0; transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(1.2) rotate(220deg) }
    }
    @keyframes panicShake {
      0%{ transform: translateX(0) rotate(0deg) }
      10%{ transform: translateX(-6px) rotate(-3deg) }
      20%{ transform: translateX(6px) rotate(3deg) }
      30%{ transform: translateX(-5px) rotate(-2deg) }
      40%{ transform: translateX(5px) rotate(2deg) }
      50%{ transform: translateX(-4px) rotate(-1deg) }
      60%{ transform: translateX(4px) rotate(1deg) }
      70%{ transform: translateX(-3px) rotate(-1deg) }
      80%{ transform: translateX(3px) rotate(1deg) }
      90%{ transform: translateX(-2px) rotate(0deg) }
      100%{ transform: translateX(0) rotate(0deg) }
    }

    .dance-wiggle .poppyWrap{ animation: wiggle 900ms ease-in-out infinite; }
    .dance-bounce .poppyWrap{ animation: bounce 900ms ease-in-out infinite; }
    .dance-disco .poppyWrap{ animation: wiggle 720ms ease-in-out infinite; }
    .dance-disco .disco{ opacity:1; animation: discoSpin 2.2s linear infinite; }
    .dance-panic .poppyWrap{ animation: panicShake 520ms linear infinite; }

    .dance-wiggle .face,
    .dance-bounce .face,
    .dance-disco .face,
    .dance-panic .face{
      animation: headBob 700ms ease-in-out infinite;
    }

    @media (prefers-reduced-motion: reduce){
      .dance-wiggle .poppyWrap,
      .dance-bounce .poppyWrap,
      .dance-disco .poppyWrap,
      .dance-panic .poppyWrap,
      .dance-wiggle .face,
      .dance-bounce .face,
      .dance-disco .face,
      .dance-panic .face,
      .dance-disco .disco{ animation:none !important; }
    }
  </style>
</head>

<body>
  <main class="wrap">
    <section class="card" id="app">
      <header>
        <div class="title">
          <h1>POPPY</h1>
          <p class="sub">A VIRTUAL CHARACTER THAT RESPONDS TO YOUR MOOD WITH SILLY DANCE ANIMATIONS</p>
        </div>
        <div class="badge">
          <span class="dot" id="statusDot"></span>
          <span id="statusText">READY</span>
        </div>
      </header>

      <div class="stage">
        <div class="plantArea" id="plantArea">
          <div class="speech">
            <div class="bubble" id="bubble">TYPE A MESSAGE AND PICK A MOOD. POPPY WILL RESPOND WITH MULTIPLE LINES.</div>
            <div class="chip">MOOD <b id="moodChip">HAPPY</b> ENERGY <b id="energyChip">55</b></div>
          </div>

          <div class="disco" id="disco"></div>
          <div class="floorGlow"></div>

          <div class="poppyWrap" id="poppyWrap" aria-label="Poppy">
            <div class="nameTag">POPPY</div>

            <div class="square">
              <div class="face" id="face">
                <div class="brow left"></div>
                <div class="brow right"></div>
                <div class="eye"></div>
                <div class="eye"></div>
                <div class="mouth" id="mouth"></div>
              </div>
            </div>
          </div>

          <div class="spark" id="spark1"></div>
          <div class="spark" id="spark2"></div>
          <div class="spark" id="spark3"></div>
        </div>

        <div class="controls">
          <div class="panel">
            <label for="moodSelect">MOOD</label>
            <select id="moodSelect">
              <option value="happy">HAPPY</option>
              <option value="sad">SAD</option>
              <option value="stressed">STRESSED</option>
              <option value="silly">SILLY</option>
              <option value="angry">ANGRY</option>
              <option value="tired">TIRED</option>
              <option value="excited">EXCITED</option>
            </select>

            <div class="readout">
              <span>ENERGY</span>
              <div class="meter"><span id="energyBar"></span></div>
              <span id="energyLabel">55</span>
            </div>

            <label for="energyRange" style="margin-top:10px;">ENERGY SLIDER</label>
            <input id="energyRange" type="range" min="0" max="100" value="55" />
          </div>

          <div class="panel">
            <label for="userText">YOUR MESSAGE</label>
            <textarea id="userText" rows="3" placeholder="TYPE HERE"></textarea>

            <div class="row" style="margin-top:10px;">
              <button class="btn" id="btnReact" type="button">SEND AND DANCE</button>
              <button class="btn secondary" id="btnRandom" type="button">RANDOM MOOD</button>
            </div>

            <div class="row" style="margin-top:10px;">
              <button class="btn secondary" id="btnSpark" type="button">CONFETTI</button>
              <button class="btn secondary" id="btnStop" type="button">STOP</button>
            </div>

            <div class="hint">
              SHORTCUTS <span class="kbd">R</span> SEND <span class="kbd">C</span> CONFETTI <span class="kbd">S</span> STOP
            </div>
          </div>
        </div>
      </div>
    </section>

    <aside class="card side">
      <h2>WHAT IT DOES</h2>
      <p>
        PICK A MOOD AND TYPE A MESSAGE. POPPY RESPONDS WITH MULTIPLE LINES AND CHOOSES A DANCE.
        ENERGY MAKES THE DANCE CALMER OR MORE INTENSE.
      </p>

      <div class="log" id="log" aria-live="polite"></div>

      <div class="hint">
        EXTENSIONS: SENTIMENT FROM TEXT, MOOD HISTORY, UNLOCK DANCES, FRIENDSHIP LEVEL.
      </div>
    </aside>
  </main>

  <script>
    const app = document.getElementById("app");
    const face = document.getElementById("face");
    const bubble = document.getElementById("bubble");
    const moodChip = document.getElementById("moodChip");
    const energyChip = document.getElementById("energyChip");
    const moodSelect = document.getElementById("moodSelect");
    const energyRange = document.getElementById("energyRange");
    const energyLabel = document.getElementById("energyLabel");
    const energyBar = document.getElementById("energyBar");
    const userText = document.getElementById("userText");
    const log = document.getElementById("log");
    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");
    const plantArea = document.getElementById("plantArea");

    const sparks = [
      document.getElementById("spark1"),
      document.getElementById("spark2"),
      document.getElementById("spark3")
    ];

    const moods = ["happy","sad","stressed","silly","angry","tired","excited"];

    function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

    function setEnergy(val){
      const v = clamp(Number(val), 0, 100);
      energyRange.value = v;
      energyLabel.textContent = String(v);
      energyChip.textContent = String(v);
      energyBar.style.width = v + "%";
    }

    function clearDance(){
      app.classList.remove("dance-wiggle","dance-bounce","dance-disco","dance-panic");
      statusDot.style.background = "var(--accent)";
      statusText.textContent = "READY";
    }

    function setMood(mood){
      face.classList.remove("mood-happy","mood-sad","mood-silly","mood-angry","mood-tired");
      const map = {
        happy:"mood-happy",
        excited:"mood-happy",
        stressed:"mood-tired",
        silly:"mood-silly",
        sad:"mood-sad",
        angry:"mood-angry",
        tired:"mood-tired"
      };
      face.classList.add(map[mood] || "mood-happy");
      moodChip.textContent = mood.toUpperCase();
      moodSelect.value = mood;
    }

    function pickDance(mood, energy){
      if (mood === "sad") return energy > 55 ? "dance-wiggle" : "dance-bounce";
      if (mood === "tired") return energy > 65 ? "dance-panic" : "dance-bounce";
      if (mood === "angry") return energy > 50 ? "dance-panic" : "dance-wiggle";
      if (mood === "stressed") return energy > 60 ? "dance-panic" : "dance-bounce";
      if (mood === "silly") return energy > 45 ? "dance-disco" : "dance-wiggle";
      if (mood === "excited") return energy > 35 ? "dance-disco" : "dance-bounce";
      return energy > 50 ? "dance-bounce" : "dance-wiggle";
    }

    function respondLines(mood, energy, userMsg){
      const msg = (userMsg || "").trim();
      const hasMsg = msg.length > 0;

      const opener = {
        happy:["I AM POPPY. I AM FEELING LIGHT.", "I AM POPPY. I AM READY.", "I AM POPPY. I CAN MATCH THIS."],
        sad:["I AM POPPY. WE CAN GO SLOW.", "I AM POPPY. I AM HERE.", "I AM POPPY. SMALL STEPS."],
        stressed:["I AM POPPY. LET US RESET.", "I AM POPPY. WE CAN BREATHE.", "I AM POPPY. ONE THING AT A TIME."],
        silly:["I AM POPPY. I WILL BE RIDICULOUS.", "I AM POPPY. THIS WILL BE WEIRD.", "I AM POPPY. I AM IN GOOFY MODE."],
        angry:["I AM POPPY. I WILL SHAKE IT OUT.", "I AM POPPY. I WILL TURN THIS INTO MOTION.", "I AM POPPY. I AM FOCUSED."],
        tired:["I AM POPPY. I AM LOW ENERGY.", "I AM POPPY. KEEP IT SIMPLE.", "I AM POPPY. SLOW SWAY."],
        excited:["I AM POPPY. HIGH ENERGY.", "I AM POPPY. TURNING IT UP.", "I AM POPPY. LET US MOVE."]
      }[mood] || ["I AM POPPY. READY."];

      const guidance = {
        happy:["KEEP IT GOING.", "I WILL MATCH YOUR VIBE.", "LET US KEEP IT LIGHT."],
        sad:["GENTLE MOVE.", "SLOW AND STEADY.", "WE CAN TAKE A BEAT."],
        stressed:["RESET MODE.", "BREATHE AND MOVE.", "SMALL RESET DANCE."],
        silly:["EXPECT CHAOS.", "THIS IS A STRANGE DANCE.", "DO NOT ASK WHY."],
        angry:["POWER MOVE.", "SHAKE THE TENSION.", "TURN IT INTO ENERGY."],
        tired:["CALM MOVE.", "LOW MOTION.", "SLOW MODE."],
        excited:["FULL MODE.", "BIG MOVES.", "TURN IT UP."]
      }[mood] || ["READY."];

      const lines = [];
      lines.push(opener[Math.floor(Math.random()*opener.length)]);

      if (hasMsg){
        lines.push("I HEARD YOU.");
        lines.push("YOU SAID: " + msg.slice(0, 160) + (msg.length > 160 ? "..." : ""));
      } else {
        lines.push("TYPE A MESSAGE ANY TIME.");
      }

      lines.push(guidance[Math.floor(Math.random()*guidance.length)]);

      if (energy >= 80) lines.push("ENERGY IS HIGH. INTENSE DANCE.");
      if (energy <= 20) lines.push("ENERGY IS LOW. CALM DANCE.");

      return lines.join("\n");
    }

    function setStatus(dance){
      if (dance === "dance-panic"){
        statusDot.style.background = "var(--danger)";
        statusText.textContent = "INTENSE";
        return;
      }
      if (dance === "dance-disco"){
        statusDot.style.background = "var(--accent2)";
        statusText.textContent = "PARTY";
        return;
      }
      statusDot.style.background = "var(--accent)";
      statusText.textContent = "DANCING";
    }

    function logEvent(mood, dance, energy, msg){
      const time = new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
      const danceName = {
        "dance-wiggle":"WIGGLE",
        "dance-bounce":"BOUNCE",
        "dance-disco":"DISCO",
        "dance-panic":"SHAKE"
      }[dance] || dance.toUpperCase();

      const safe = (msg || "").trim();
      const snippet = safe ? (" | MSG " + safe.slice(0, 60) + (safe.length > 60 ? "..." : "")) : "";

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML =
        "<b>" + time + "</b> | MOOD <b>" + mood.toUpperCase() + "</b> | DANCE <b>" + danceName + "</b> | ENERGY <b>" + energy + "</b>" + snippet;
      log.prepend(div);
    }

    function sparkPop(){
      const rect = plantArea.getBoundingClientRect();
      const cx = rect.width/2;
      const cy = rect.height/2;

      sparks.forEach((s,i)=>{
        const dx = (Math.random()*220 - 110) + "px";
        const dy = (Math.random()*220 - 110) + "px";
        s.style.setProperty("--dx", dx);
        s.style.setProperty("--dy", dy);

        s.style.opacity = 0;
        s.style.left = (cx + (Math.random()*40-20)) + "px";
        s.style.top  = (cy + (Math.random()*40-20)) + "px";

        s.style.animation = "none";
        void s.offsetWidth;
        s.style.animation = "sparkPop 700ms ease-out " + (i*70) + "ms 1";
      });
    }

    function react(){
      const mood = moodSelect.value;
      const energy = Number(energyRange.value);
      const msg = userText.value;

      clearDance();
      setMood(mood);

      const dance = pickDance(mood, energy);
      app.classList.add(dance);
      setStatus(dance);

      bubble.textContent = respondLines(mood, energy, msg);
      logEvent(mood, dance, energy, msg);

      if (dance === "dance-disco" || energy >= 85) sparkPop();
    }

    function randomMood(){
      const mood = moods[Math.floor(Math.random()*moods.length)];
      moodSelect.value = mood;
      const e = clamp(Number(energyRange.value) + (Math.random()*30 - 15), 0, 100);
      setEnergy(Math.round(e));
      react();
    }

    document.getElementById("btnReact").addEventListener("click", react);
    document.getElementById("btnRandom").addEventListener("click", randomMood);
    document.getElementById("btnSpark").addEventListener("click", sparkPop);
    document.getElementById("btnStop").addEventListener("click", ()=>{
      clearDance();
      bubble.textContent = "POPPY IS PAUSED. PICK A MOOD AND SEND A MESSAGE.";
    });

    moodSelect.addEventListener("change", ()=> setMood(moodSelect.value));
    energyRange.addEventListener("input", (e)=> setEnergy(e.target.value));

    window.addEventListener("keydown", (e)=>{
      const k = e.key.toLowerCase();
      if (k === "r") react();
      if (k === "c") sparkPop();
      if (k === "s") clearDance();
      if (k === "enter" && (e.ctrlKey || e.metaKey)) react();
    });

    setMood("happy");
    setEnergy(55);
    log.innerHTML = '<div class="item"><b>WELCOME</b> | POPPY IS READY. PICK A MOOD AND CLICK SEND AND DANCE.</div>';
  </script>
</body>
</html>
