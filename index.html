<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>POPPY | TAMAGOTCHI</title>
  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#101a33;
      --card:rgba(15,23,48,.86);
      --text:#eef2ff;
      --muted:#c7d2ff;
      --accent:#7cf7b2;
      --accent2:#8aa4ff;
      --warn:#ffd18a;
      --danger:#ff8aa1;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-weight: 950;
      color: var(--text);
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(122,249,184,.16), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(138,164,255,.18), transparent 60%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      padding:22px;
      overflow-x:hidden;
      text-transform: uppercase;
      letter-spacing:.2px;
    }

    .wrap{
      width:min(1120px, 100%);
      margin:0 auto;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 960px){ .wrap{ grid-template-columns:1fr; } }

    .card{
      background: var(--card);
      border:1px solid rgba(255,255,255,.10);
      border-color: rgba(124,247,178,.16);
      border-top-color: rgba(138,164,255,.20);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    header{
      padding:18px 18px 10px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }

    .title{ display:flex; flex-direction:column; gap:6px; }
    h1{ margin:0; font-size: clamp(18px, 2.6vw, 26px); }
    .sub{ margin:0; color: var(--muted); font-size: 13px; }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      user-select:none;
    }
    .badge .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 6px rgba(124,247,178,.10);
    }

    .stage{
      padding: 14px 18px 18px;
      display:grid;
      gap:14px;
    }

    /* MORE TAMAGOTCHI-LIKE: SMALLER SCREEN + LESS CONSTANT MOTION */
    .screen{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(520px 260px at 50% 35%, rgba(124,247,178,.10), transparent 60%),
        radial-gradient(560px 260px at 50% 60%, rgba(138,164,255,.07), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.16));
      height: 420px;
      position:relative;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 14px;
    }

    .hud{
      position:absolute;
      inset: 12px 12px auto 12px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      pointer-events:none;
      z-index:5;
    }

    .statusBox{
      max-width: 66%;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(6px);
      font-size: 12px;
      line-height: 1.25;
      box-shadow: 0 12px 26px rgba(0,0,0,.35);
      white-space: pre-line;
    }

    .pill{
      padding: 9px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      color: var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .pill b{ color: var(--text); }

    .floorGlow{
      position:absolute;
      bottom:-100px;
      width: 560px;
      height: 260px;
      border-radius: 999px;
      background: radial-gradient(circle at 50% 35%, rgba(124,247,178,.14), transparent 62%);
      filter: blur(2px);
      opacity:.8;
      pointer-events:none;
    }

    /* POPPY */
    .poppyWrap{
      position:relative;
      width: 260px;
      height: 280px;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      transform-origin: 50% 90%;
      z-index:2;
    }

    .nameTag{
      position:absolute;
      top: 4px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(0,0,0,.18));
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      letter-spacing: .9px;
      user-select:none;
      font-size: 12px;
    }

    .square{
      width: 170px;
      height: 170px;
      border-radius: 22px;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.22), transparent 55%),
        linear-gradient(180deg, rgba(185,255,217,1), rgba(47,228,138,1));
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 0 18px 44px rgba(0,0,0,.36);
      position:relative;
      overflow:hidden;
    }

    .face{
      width: 132px;
      height: 88px;
      border-radius: 22px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(10px);
      box-shadow: 0 16px 26px rgba(0,0,0,.20);
      position:absolute;
      bottom: 32px;
      left: 50%;
      transform: translateX(-50%);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:22px;
      padding-top:12px;
    }

    .eye{
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: #0b1020;
      box-shadow: 0 0 0 7px rgba(255,255,255,.10);
      position:relative;
      overflow:hidden;
    }
    .eye:after{
      content:"";
      position:absolute;
      width: 6px;height:6px;border-radius:999px;
      background: rgba(255,255,255,.90);
      top: 2px; left: 2px;
    }

    .mouth{
      position:absolute;
      left: 50%;
      bottom: 14px;
      transform: translateX(-50%);
      width: 36px;
      height: 16px;
      border: 3px solid rgba(11,16,32,.92);
      border-top: none;
      border-radius: 0 0 28px 28px;
      background: transparent;
    }

    .brow{
      position:absolute;
      top: 10px;
      width: 24px;
      height: 6px;
      border-radius: 999px;
      background: rgba(11,16,32,.92);
      opacity:0;
    }
    .brow.left{ left: 20px; transform: rotate(-10deg); }
    .brow.right{ right: 20px; transform: rotate(10deg); }

    /* FACE STATES */
    .mood-happy .mouth{ width: 44px; height: 20px; border-radius: 0 0 30px 30px; }
    .mood-sad .mouth{
      bottom: 18px; width: 44px; height: 16px;
      border-top: 3px solid rgba(11,16,32,.92);
      border-bottom:none; border-radius: 30px 30px 0 0;
    }
    .mood-angry .mouth{
      width: 36px; height: 14px;
      border-top: 3px solid rgba(11,16,32,.92);
      border-bottom:none; border-radius: 22px 22px 0 0;
    }
    .mood-angry .brow{ opacity:1; }
    .mood-angry .brow.left{ transform: rotate(18deg); }
    .mood-angry .brow.right{ transform: rotate(-18deg); }

    .mood-hungry .mouth{
      width: 18px; height: 18px;
      border: 3px solid rgba(11,16,32,.92);
      border-radius: 999px;
    }

    .mood-sick .mouth{
      width: 34px; height: 7px;
      border:none; background: rgba(11,16,32,.92); border-radius: 999px;
    }
    .mood-sick .eye{ height: 11px; }

    .mood-bored .mouth{
      width: 30px; height: 6px;
      border:none; background: rgba(11,16,32,.92); border-radius: 999px;
      opacity:.85;
    }

    /* TAMAGOTCHI-LIKE: NO CONSTANT LOOPING ANIMATIONS
       ONLY SMALL "BLINK" SOMETIMES + SHORT ACTION BURSTS */
    @keyframes blink {
      0%, 90%, 100% { transform: scaleY(1); }
      92%, 96% { transform: scaleY(0.15); }
    }
    .blink .eye{ animation: blink 220ms linear 1; transform-origin:center; }

    /* SHORT ACTION BURSTS */
    @keyframes pop {
      0%{ transform: scale(1); }
      50%{ transform: scale(1.04); }
      100%{ transform: scale(1); }
    }
    @keyframes nod {
      0%{ transform: translateY(0); }
      40%{ transform: translateY(-8px); }
      100%{ transform: translateY(0); }
    }
    @keyframes wig {
      0%{ transform: rotate(0deg); }
      25%{ transform: rotate(-8deg); }
      50%{ transform: rotate(10deg); }
      75%{ transform: rotate(-6deg); }
      100%{ transform: rotate(0deg); }
    }
    .burst-pop .square{ animation: pop 380ms ease-out 1; }
    .burst-nod .poppyWrap{ animation: nod 420ms ease-out 1; }
    .burst-wig .poppyWrap{ animation: wig 520ms ease-in-out 1; }

    /* SLEEP LOOK */
    .sleepTint{
      position:absolute;
      inset:0;
      background: radial-gradient(circle at 50% 30%, rgba(138,164,255,.14), rgba(0,0,0,.62));
      opacity:0;
      transition: opacity .25s ease;
      pointer-events:none;
      z-index:3;
    }
    .sleepOn .sleepTint{ opacity:1; }

    /* OVERLAY (MINI GAME / ACTIONS) */
    .overlay{
      position:absolute;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10;
      background: radial-gradient(circle at 50% 40%, rgba(0,0,0,.20), rgba(0,0,0,.55));
      backdrop-filter: blur(3px);
    }
    .overlay.show{ display:flex; }
    .overlayCard{
      width:min(520px, 92%);
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,14,28,.80);
      box-shadow: 0 22px 60px rgba(0,0,0,.55);
      padding: 14px;
    }
    .overlayTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .overlayTop b{ color: var(--text); }
    .overlayBody{
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 12px;
      min-height: 160px;
      display:grid;
      place-items:center;
      position:relative;
      overflow:hidden;
    }
    .overlayActions{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){ .overlayActions{ grid-template-columns:1fr; } }

    /* FEED VISUAL: FOOD DOTS */
    .food{
      position:absolute;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.9), rgba(255,209,138,.9));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 12px 20px rgba(0,0,0,.25);
      opacity:0;
    }
    @keyframes foodDrop{
      0%{ transform: translate(0,-40px) scale(.6); opacity:0; }
      15%{ opacity:1; }
      65%{ transform: translate(var(--dx), var(--dy)) scale(1.0); opacity:1; }
      100%{ transform: translate(calc(var(--dx) + 40px), calc(var(--dy) + 40px)) scale(.2); opacity:0; }
    }

    /* CLEAN VISUAL: BUBBLES */
    .bubble{
      position:absolute;
      width: 14px; height: 14px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.08);
      opacity:0;
    }
    @keyframes bubbleRise{
      0%{ transform: translate(0, 20px) scale(.6); opacity:0; }
      10%{ opacity:1; }
      80%{ opacity:1; }
      100%{ transform: translate(var(--dx), -170px) scale(1.15); opacity:0; }
    }

    /* MED VISUAL: PULSE RING */
    .pulseRing{
      width: 110px; height: 110px;
      border-radius: 999px;
      border: 2px solid rgba(124,247,178,.55);
      box-shadow: 0 0 0 10px rgba(124,247,178,.12);
      opacity:0;
      position:absolute;
    }
    @keyframes pulse{
      0%{ transform: scale(.7); opacity:0; }
      18%{ opacity:1; }
      100%{ transform: scale(1.6); opacity:0; }
    }

    /* MINI GAME: CLICK TARGET */
    .gameArea{
      width: min(460px, 92%);
      height: 220px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      position:relative;
      overflow:hidden;
    }
    .target{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      position:absolute;
      left: 20px;
      top: 20px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.9), rgba(138,164,255,.95));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 18px 30px rgba(0,0,0,.30);
      cursor:pointer;
    }
    .gameHud{
      display:flex;
      justify-content:space-between;
      width: min(460px, 92%);
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
    }
    .gameHud b{ color: var(--text); }

    /* CONTROLS */
    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 620px){ .controls{ grid-template-columns:1fr; } }

    .panel{
      padding: 14px 14px 16px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
    }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width: 620px){ .grid2{ grid-template-columns:1fr; } }

    button{
      width:100%;
      font: inherit;
      font-weight: 950;
      color: var(--text);
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 10px 12px;
      outline:none;
      cursor:pointer;
      letter-spacing:.3px;
      transition: transform .08s ease, filter .2s ease, border-color .2s ease;
    }
    button:hover{ filter: brightness(1.06); border-color: rgba(124,247,178,.42); }
    button:active{ transform: translateY(1px) scale(.99); }

    .btnMain{
      background: linear-gradient(180deg, rgba(124,247,178,.24), rgba(124,247,178,.08));
      border-color: rgba(124,247,178,.22);
    }
    .btnAlt{
      background: linear-gradient(180deg, rgba(138,164,255,.20), rgba(138,164,255,.06));
      border-color: rgba(138,164,255,.22);
    }
    .btnWarn{
      background: linear-gradient(180deg, rgba(255,209,138,.22), rgba(255,209,138,.07));
      border-color: rgba(255,209,138,.22);
    }
    .btnDanger{
      background: linear-gradient(180deg, rgba(255,138,161,.22), rgba(255,138,161,.07));
      border-color: rgba(255,138,161,.22);
    }

    .bars{ display:grid; gap:10px; }
    .barRow{
      display:grid;
      grid-template-columns: 120px 1fr 54px;
      gap:10px;
      align-items:center;
      font-size: 12px;
      color: var(--muted);
    }
    @media (max-width: 420px){
      .barRow{ grid-template-columns: 1fr; }
    }

    .meter{
      height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .fill{
      height:100%;
      width: 50%;
      background: linear-gradient(90deg, rgba(124,247,178,.85), rgba(138,164,255,.85));
    }

    .log{
      height: 300px;
      overflow:auto;
      padding: 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.10);
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
    }
    .log b{ color: var(--text); }
    .log .item{ margin-bottom:10px; }

    .errorBanner{
      position:fixed;
      left:16px;
      right:16px;
      bottom:16px;
      padding:12px 14px;
      border-radius:14px;
      background: rgba(255,138,161,.18);
      border: 1px solid rgba(255,138,161,.40);
      color: var(--text);
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
      z-index:9999;
      display:none;
      white-space: pre-line;
    }

    @media (prefers-reduced-motion: reduce){
      .burst-pop .square,
      .burst-nod .poppyWrap,
      .burst-wig .poppyWrap{ animation:none !important; }
      .overlay, .overlayCard{ backdrop-filter:none; }
    }
  </style>
</head>

<body>
  <div class="errorBanner" id="errorBanner"></div>

  <main class="wrap">
    <section class="card" id="app">
      <header>
        <div class="title">
          <h1>POPPY</h1>
          <p class="sub">TAMAGOTCHI STYLE: MOSTLY STILL, ONLY MOVES ON EVENTS</p>
        </div>
        <div class="badge">
          <span class="dot" id="statusDot"></span>
          <span id="statusText">ALIVE</span>
        </div>
      </header>

      <div class="stage">
        <div class="screen" id="screen">
          <div class="sleepTint" id="sleepTint"></div>

          <div class="hud">
            <div class="statusBox" id="statusBox">POPPY IS IDLE. CLICK A BUTTON.</div>
            <div class="pill">MOOD <b id="moodPill">HAPPY</b> AGE <b id="agePill">0</b> COINS <b id="coinsPill">5</b></div>
          </div>

          <div class="floorGlow"></div>

          <div class="poppyWrap" id="poppyWrap" aria-label="Poppy">
            <div class="nameTag">POPPY</div>
            <div class="square" id="square">
              <div class="face" id="face">
                <div class="brow left"></div>
                <div class="brow right"></div>
                <div class="eye"></div>
                <div class="eye"></div>
                <div class="mouth"></div>
              </div>
            </div>
          </div>

          <div class="overlay" id="overlay">
            <div class="overlayCard">
              <div class="overlayTop">
                <div>MODE <b id="overlayTitle">ACTION</b></div>
                <div>TIME <b id="overlayTimer">0</b></div>
              </div>
              <div class="overlayBody" id="overlayBody"></div>
              <div class="overlayActions" id="overlayActions">
                <button class="btnMain" id="overlayPrimary" type="button">OK</button>
                <button class="btnAlt" id="overlayClose" type="button">CLOSE</button>
              </div>
            </div>
          </div>
        </div>

        <div class="controls">
          <div class="panel">
            <div class="bars">
              <div class="barRow"><span>HUNGER</span><div class="meter"><div class="fill" id="hungerFill"></div></div><span id="hungerVal">50</span></div>
              <div class="barRow"><span>HAPPINESS</span><div class="meter"><div class="fill" id="happyFill"></div></div><span id="happyVal">70</span></div>
              <div class="barRow"><span>ENERGY</span><div class="meter"><div class="fill" id="energyFill"></div></div><span id="energyVal">70</span></div>
              <div class="barRow"><span>CLEANLINESS</span><div class="meter"><div class="fill" id="cleanFill"></div></div><span id="cleanVal">60</span></div>
              <div class="barRow"><span>HEALTH</span><div class="meter"><div class="fill" id="healthFill"></div></div><span id="healthVal">90</span></div>
            </div>
          </div>

          <div class="panel">
            <div class="grid2">
              <button class="btnMain" id="btnFeed" type="button">FEED (COST 1)</button>
              <button class="btnMain" id="btnPlay" type="button">PLAY (GAME)</button>
              <button class="btnMain" id="btnSleep" type="button">SLEEP</button>
              <button class="btnMain" id="btnClean" type="button">CLEAN</button>
              <button class="btnWarn" id="btnMed" type="button">MEDICINE (COST 2)</button>
              <button class="btnAlt" id="btnWork" type="button">WORK</button>
            </div>

            <div class="grid2" style="margin-top:10px;">
              <button class="btnAlt" id="btnToggleAuto" type="button">AUTO CARE OFF</button>
              <button class="btnAlt" id="btnPause" type="button">PAUSE</button>
            </div>

            <div class="grid2" style="margin-top:10px;">
              <button class="btnAlt" id="btnShopInfo" type="button">SHOP INFO</button>
              <button class="btnDanger" id="btnReset" type="button">RESET</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <aside class="card" style="padding:16px 16px 18px;">
      <h2 style="margin:0 0 10px; font-size:16px;">EVENT LOG</h2>
      <div class="log" id="log"></div>

      <div class="panel" style="margin-top:12px;">
        <h2 style="margin:0 0 10px; font-size:16px;">MODS</h2>
        <div class="grid2">
          <button class="btnAlt" id="modSnack" type="button">SNACK DISPENSER (8)</button>
          <button class="btnAlt" id="modToy" type="button">TOY BOX (10)</button>
          <button class="btnAlt" id="modBlanket" type="button">SOFT BLANKET (10)</button>
          <button class="btnAlt" id="modSoap" type="button">SOAP KIT (8)</button>
        </div>
        <div class="panel" style="margin-top:10px;">
          <div style="font-size:12px; color:var(--muted); line-height:1.35;">
            THIS IS TAMAGOTCHI STYLE: POPPY IS MOSTLY STILL. BLINKS SOMETIMES. ONLY MOVES ON BUTTON ACTIONS.
          </div>
        </div>
      </div>
    </aside>
  </main>

  <script>
    (function(){
      const $ = (id)=>document.getElementById(id);
      const banner = $("errorBanner");
      function showError(msg){
        banner.style.display = "block";
        banner.textContent = "ERROR\n" + msg;
      }
      function need(id){
        const el = $(id);
        if (!el) throw new Error("MISSING ELEMENT ID: " + id);
        return el;
      }

      try{
        const app = need("app");
        const screen = need("screen");
        const face = need("face");
        const square = need("square");
        const statusBox = need("statusBox");
        const moodPill = need("moodPill");
        const agePill = need("agePill");
        const coinsPill = need("coinsPill");
        const statusDot = need("statusDot");
        const statusText = need("statusText");
        const logEl = need("log");

        const fills = {
          hunger: need("hungerFill"),
          happy: need("happyFill"),
          energy: need("energyFill"),
          clean: need("cleanFill"),
          health: need("healthFill")
        };
        const vals = {
          hunger: need("hungerVal"),
          happy: need("happyVal"),
          energy: need("energyVal"),
          clean: need("cleanVal"),
          health: need("healthVal")
        };

        // Overlay
        const overlay = need("overlay");
        const overlayTitle = need("overlayTitle");
        const overlayTimer = need("overlayTimer");
        const overlayBody = need("overlayBody");
        const overlayPrimary = need("overlayPrimary");
        const overlayClose = need("overlayClose");

        // Buttons
        const btnFeed = need("btnFeed");
        const btnPlay = need("btnPlay");
        const btnSleep = need("btnSleep");
        const btnClean = need("btnClean");
        const btnMed = need("btnMed");
        const btnWork = need("btnWork");
        const btnToggleAuto = need("btnToggleAuto");
        const btnPause = need("btnPause");
        const btnReset = need("btnReset");
        const btnShopInfo = need("btnShopInfo");
        const modSnack = need("modSnack");
        const modToy = need("modToy");
        const modBlanket = need("modBlanket");
        const modSoap = need("modSoap");

        const S = {
          alive: true,
          paused: false,
          autoCare: false,
          age: 0,
          coins: 5,
          hunger: 50,
          happy: 70,
          energy: 70,
          clean: 60,
          health: 90,
          mods: { snack:false, toy:false, blanket:false, soap:false }
        };

        const clamp = (n,a,b)=>Math.max(a, Math.min(b, n));
        const rint = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;

        function log(msg){
          const t = new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = "<b>" + t + "</b> | " + msg;
          logEl.prepend(div);
        }

        function burst(cls, ms){
          app.classList.add(cls);
          setTimeout(()=>app.classList.remove(cls), ms);
        }

        function blink(){
          face.classList.add("blink");
          setTimeout(()=>face.classList.remove("blink"), 250);
        }

        function activeModsLabel(){
          const a = [];
          if (S.mods.snack) a.push("SNACK");
          if (S.mods.toy) a.push("TOY");
          if (S.mods.blanket) a.push("BLANKET");
          if (S.mods.soap) a.push("SOAP");
          return a.length ? a.join(",") : "NONE";
        }

        function mood(){
          if (!S.alive) return "DEAD";
          if (S.health <= 20) return "SICK";
          if (S.hunger <= 25) return "HUNGRY";
          if (S.clean <= 20) return "ANGRY";
          if (S.happy <= 25) return "SAD";
          if (S.energy <= 20) return "BORED";
          return "HAPPY";
        }

        function setFaceMoodClass(m){
          face.classList.remove("mood-happy","mood-sad","mood-angry","mood-hungry","mood-sick","mood-bored");
          if (m !== "DEAD") face.classList.add("mood-" + m.toLowerCase());
        }

        function updateUI(){
          S.hunger = clamp(S.hunger, 0, 100);
          S.happy  = clamp(S.happy, 0, 100);
          S.energy = clamp(S.energy, 0, 100);
          S.clean  = clamp(S.clean, 0, 100);
          S.health = clamp(S.health, 0, 100);

          for (const k of ["hunger","happy","energy","clean","health"]){
            fills[k].style.width = S[k] + "%";
            vals[k].textContent = String(Math.round(S[k]));
          }

          const m = mood();
          moodPill.textContent = m;
          agePill.textContent = String(S.age);
          coinsPill.textContent = String(S.coins);
          setFaceMoodClass(m);

          if (!S.alive){
            statusDot.style.background = "var(--danger)";
            statusText.textContent = "DEAD";
          } else {
            statusText.textContent = S.paused ? "PAUSED" : "ALIVE";
            if (m === "SICK" || m === "ANGRY") statusDot.style.background = "var(--danger)";
            else if (m === "HUNGRY" || m === "SAD") statusDot.style.background = "var(--warn)";
            else statusDot.style.background = "var(--accent)";
          }

          statusBox.textContent =
            "POPPY STATUS\n" +
            "MOOD " + m + "\n" +
            "COINS " + S.coins + "\n" +
            "MODS " + activeModsLabel() + "\n" +
            "AUTO CARE " + (S.autoCare ? "ON" : "OFF");

          btnToggleAuto.textContent = "AUTO CARE " + (S.autoCare ? "ON" : "OFF");
          btnPause.textContent = S.paused ? "RESUME" : "PAUSE";
        }

        // OVERLAY
        let overlayInterval = null;
        let overlayEndAt = 0;
        let overlayMode = "NONE";
        let game = null;

        function closeOverlay(){
          overlay.classList.remove("show");
          overlayBody.innerHTML = "";
          overlayTitle.textContent = "ACTION";
          overlayTimer.textContent = "0";
          overlayMode = "NONE";
          if (overlayInterval){ clearInterval(overlayInterval); overlayInterval = null; }
          if (game && game.moveTimer) clearInterval(game.moveTimer);
          game = null;
          updateUI();
        }

        function openOverlay(mode, seconds){
          overlayMode = mode;
          overlayTitle.textContent = mode;
          overlay.classList.add("show");
          overlayEndAt = Date.now() + seconds*1000;

          function tickTimer(){
            const left = Math.max(0, Math.ceil((overlayEndAt - Date.now())/1000));
            overlayTimer.textContent = String(left);
            if (left <= 0){
              if (overlayMode === "PLAY"){
                endGame(true);
              } else {
                closeOverlay();
              }
            }
          }
          tickTimer();
          if (overlayInterval) clearInterval(overlayInterval);
          overlayInterval = setInterval(tickTimer, 200);
        }

        overlayClose.addEventListener("click", ()=>{
          if (overlayMode === "PLAY") endGame(false);
          closeOverlay();
        });
        overlayPrimary.addEventListener("click", ()=>{
          if (overlayMode === "PLAY") endGame(true);
          else closeOverlay();
        });

        // ACTION VISUALS
        function animFeed(){
          burst("burst-pop", 380);
          burst("burst-nod", 420);

          openOverlay("FEED", 2);
          overlayPrimary.textContent = "DONE";
          overlayClose.textContent = "CLOSE";
          overlayBody.innerHTML = "";

          for (let i=0;i<6;i++){
            const f = document.createElement("div");
            f.className = "food";
            f.style.left = (10 + Math.random()*40) + "%";
            f.style.top = (10 + Math.random()*20) + "%";
            f.style.setProperty("--dx", (120 + Math.random()*120) + "px");
            f.style.setProperty("--dy", (70 + Math.random()*80) + "px");
            f.style.animation = "foodDrop 820ms ease-in " + (i*90) + "ms 1";
            overlayBody.appendChild(f);
          }
        }

        function animClean(){
          burst("burst-wig", 520);

          openOverlay("CLEAN", 2);
          overlayPrimary.textContent = "DONE";
          overlayClose.textContent = "CLOSE";
          overlayBody.innerHTML = "";

          for (let i=0;i<14;i++){
            const b = document.createElement("div");
            b.className = "bubble";
            b.style.left = (10 + Math.random()*80) + "%";
            b.style.top = (140 + Math.random()*40) + "px";
            b.style.setProperty("--dx", (Math.random()*120 - 60) + "px");
            b.style.animation = "bubbleRise 980ms ease-out " + (i*60) + "ms 1";
            overlayBody.appendChild(b);
          }
        }

        function animMed(){
          burst("burst-pop", 380);

          openOverlay("MEDICINE", 2);
          overlayPrimary.textContent = "DONE";
          overlayClose.textContent = "CLOSE";
          overlayBody.innerHTML = "";

          for (let i=0;i<4;i++){
            const ring = document.createElement("div");
            ring.className = "pulseRing";
            ring.style.animation = "pulse 820ms ease-out " + (i*160) + "ms 1";
            overlayBody.appendChild(ring);
          }
        }

        function animSleep(){
          screen.classList.add("sleepOn");
          burst("burst-nod", 420);

          openOverlay("SLEEP", 3);
          overlayPrimary.textContent = "WAKE";
          overlayClose.textContent = "CLOSE";
          overlayBody.innerHTML =
            "<div style='color:var(--muted); font-size:12px; line-height:1.35; text-align:center;'>POPPY IS RESTING\nENERGY UP</div>";

          setTimeout(()=>screen.classList.remove("sleepOn"), 3200);
        }

        // MINI GAME
        function startGame(){
          openOverlay("PLAY", 10);
          overlayPrimary.textContent = "FINISH";
          overlayClose.textContent = "QUIT";
          overlayBody.innerHTML = "";

          const area = document.createElement("div");
          area.className = "gameArea";
          const target = document.createElement("div");
          target.className = "target";
          area.appendChild(target);

          const hud = document.createElement("div");
          hud.className = "gameHud";
          hud.innerHTML = "<div>SCORE <b id='gScore'>0</b></div><div>REWARD <b id='gReward'>0</b></div>";

          overlayBody.appendChild(area);
          overlayBody.appendChild(hud);

          const gScore = overlayBody.querySelector("#gScore");
          const gReward = overlayBody.querySelector("#gReward");

          game = { score: 0, target, area, gScore, gReward, moveTimer: null };

          function moveTarget(){
            const w = area.clientWidth;
            const h = area.clientHeight;
            const x = Math.max(6, Math.min(w-24, Math.floor(Math.random()*(w-18))));
            const y = Math.max(6, Math.min(h-24, Math.floor(Math.random()*(h-18))));
            target.style.left = x + "px";
            target.style.top = y + "px";
          }

          target.addEventListener("click", ()=>{
            if (!game) return;
            game.score += 1;
            gScore.textContent = String(game.score);
            const reward = Math.min(10, Math.floor(game.score/2));
            gReward.textContent = String(reward);
            moveTarget();
            burst("burst-pop", 250);
          });

          moveTarget();
          game.moveTimer = setInterval(moveTarget, 650);
        }

        function endGame(applyRewards){
          if (!game) return;
          clearInterval(game.moveTimer);

          const score = game.score;
          game = null;

          if (applyRewards){
            const happyGain = clamp(10 + score*2, 10, 32);
            const coinsGain = clamp(Math.floor(score/2), 0, 10);
            S.happy += happyGain;
            S.energy -= 6;
            S.clean  -= 2;
            S.coins += coinsGain;
            log("PLAY SCORE " + score + " HAPPINESS +" + happyGain + " COINS +" + coinsGain);
            burst("burst-wig", 520);
          } else {
            log("PLAY QUIT");
          }
          closeOverlay();
        }

        // ACTIONS
        function actFeed(){
          if (!S.alive || S.paused) return log("CANNOT FEED RIGHT NOW");
          if (S.coins < 1) return log("NOT ENOUGH COINS TO FEED");
          S.coins -= 1;
          S.hunger += 28;
          S.clean  -= 3;
          S.happy  += 5;
          log("FEED");
          animFeed();
          updateUI();
        }

        function actPlay(){
          if (!S.alive || S.paused) return log("CANNOT PLAY RIGHT NOW");
          log("PLAY START");
          startGame();
          updateUI();
        }

        function actSleep(){
          if (!S.alive || S.paused) return log("CANNOT SLEEP RIGHT NOW");
          S.energy += 30;
          S.hunger -= 6;
          log("SLEEP");
          animSleep();
          updateUI();
        }

        function actClean(){
          if (!S.alive || S.paused) return log("CANNOT CLEAN RIGHT NOW");
          S.clean += 34;
          S.happy += 3;
          log("CLEAN");
          animClean();
          updateUI();
        }

        function actMed(){
          if (!S.alive || S.paused) return log("CANNOT USE MEDICINE RIGHT NOW");
          if (S.coins < 2) return log("NOT ENOUGH COINS FOR MEDICINE");
          S.coins -= 2;
          S.health += 28;
          S.happy  -= 3;
          S.clean  -= 2;
          log("MEDICINE");
          animMed();
          updateUI();
        }

        function actWork(){
          if (!S.alive || S.paused) return log("CANNOT WORK RIGHT NOW");
          const earned = rint(2,5);
          S.coins += earned;
          S.energy -= 8;
          S.hunger -= 6;
          S.happy  -= 3;
          log("WORK EARNED " + earned);
          burst("burst-nod", 420);
          updateUI();
        }

        function buyMod(key, cost, label){
          if (!S.alive || S.paused) return log("CANNOT BUY RIGHT NOW");
          if (S.mods[key]) return log("ALREADY OWNS " + label);
          if (S.coins < cost) return log("NOT ENOUGH COINS FOR " + label);
          S.coins -= cost;
          S.mods[key] = true;
          log("PURCHASED " + label);
          burst("burst-pop", 380);
          updateUI();
        }

        // TICK: REAL TAMAGOTCHI FEEL (SLOWER)
        // Change to 10_000 if you want demo-fast.
        const TICK_MS = 30000; // 30 seconds per tick

        function tick(){
          if (!S.alive || S.paused) return;

          // small chance to blink each tick
          if (Math.random() < 0.55) blink();

          // Age counts in ticks
          S.age += 1;

          // Slower decay (more tamagotchi feel)
          S.hunger -= 2;
          S.energy -= 2;
          S.clean  -= 1;

          let sadPush = 0;
          if (S.hunger < 35) sadPush += 2;
          if (S.energy < 25) sadPush += 2;
          if (S.clean  < 25) sadPush += 2;
          S.happy -= (1 + sadPush);

          let dmg = 0;
          if (S.hunger <= 10) dmg += 4;
          if (S.clean  <= 10) dmg += 4;
          if (S.energy <= 8)  dmg += 3;
          if (S.happy  <= 8)  dmg += 3;
          S.health -= dmg;

          // Mods are gentle
          if (S.mods.snack) S.hunger += 1;
          if (S.mods.toy) S.happy += 1;
          if (S.mods.blanket) S.energy += 1;
          if (S.mods.soap) S.clean += 1;

          // Random event rarely (more like tamagotchi)
          if (!overlay.classList.contains("show") && Math.random() < 0.06){
            const roll = Math.random();
            if (roll < 0.34){ const c = rint(1,3); S.coins += c; log("FOUND " + c + " COINS"); }
            else if (roll < 0.67){ const d = rint(2,6); S.clean -= d; log("MESS. CLEANLINESS DOWN " + d); }
            else { const d = rint(2,6); S.happy -= d; log("MOOD DROP. HAPPINESS DOWN " + d); }
          }

          if (S.health <= 0 && S.alive){
            S.alive = false;
            S.health = 0;
            log("POPPY HAS DIED");
          }

          updateUI();
        }

        // Wire buttons
        btnFeed.addEventListener("click", actFeed);
        btnPlay.addEventListener("click", actPlay);
        btnSleep.addEventListener("click", actSleep);
        btnClean.addEventListener("click", actClean);
        btnMed.addEventListener("click", actMed);
        btnWork.addEventListener("click", actWork);

        btnToggleAuto.addEventListener("click", ()=>{
          S.autoCare = !S.autoCare;
          log("AUTO CARE " + (S.autoCare ? "ON" : "OFF"));
          updateUI();
        });

        btnPause.addEventListener("click", ()=>{
          S.paused = !S.paused;
          log(S.paused ? "PAUSED" : "RESUMED");
          updateUI();
        });

        btnShopInfo.addEventListener("click", ()=>{
          log("SHOP: BUY MODS. WORK EARNS COINS.");
        });

        btnReset.addEventListener("click", ()=>{
          closeOverlay();
          screen.classList.remove("sleepOn");

          S.alive = true;
          S.paused = false;
          S.autoCare = false;
          S.age = 0;
          S.coins = 5;
          S.hunger = 50;
          S.happy = 70;
          S.energy = 70;
          S.clean = 60;
          S.health = 90;
          S.mods = { snack:false, toy:false, blanket:false, soap:false };
          log("RESET COMPLETE");
          updateUI();
        });

        modSnack.addEventListener("click", ()=>buyMod("snack", 8, "SNACK DISPENSER"));
        modToy.addEventListener("click", ()=>buyMod("toy", 10, "TOY BOX"));
        modBlanket.addEventListener("click", ()=>buyMod("blanket", 10, "SOFT BLANKET"));
        modSoap.addEventListener("click", ()=>buyMod("soap", 8, "SOAP KIT"));

        // Keyboard shortcuts (no movement unless you press)
        window.addEventListener("keydown", (e)=>{
          const k = e.key.toLowerCase();
          if (overlay.classList.contains("show")){
            if (k === "escape"){
              if (overlayMode === "PLAY") endGame(false);
              closeOverlay();
            }
            return;
          }
          if (k === "f") actFeed();
          if (k === "p") actPlay();
          if (k === "s") actSleep();
          if (k === "c") actClean();
          if (k === "m") actMed();
          if (k === "w") actWork();
          if (k === " "){ S.paused = !S.paused; log(S.paused ? "PAUSED" : "RESUMED"); updateUI(); }
        });

        // Start: minimal motion
        logEl.innerHTML = '<div class="item"><b>WELCOME</b> | TAMAGOTCHI STYLE. POPPY IS MOSTLY STILL. USE BUTTONS TO CARE FOR POPPY.</div>';
        updateUI();

        // Add occasional idle blink (not constant motion)
        setInterval(()=>{
          if (S.alive && !S.paused && !overlay.classList.contains("show") && Math.random() < 0.22){
            blink();
          }
        }, 2500);

        // Main tick
        setInterval(tick, TICK_MS);

      } catch(err){
        console.error(err);
        showError(String(err && err.message ? err.message : err));
      }
    })();
  </script>
</body>
</html>
