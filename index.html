<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>POPPY | TAMAGOTCHI</title>
  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#101a33;
      --card:rgba(15,23,48,.86);
      --text:#eef2ff;
      --muted:#c7d2ff;
      --accent:#7cf7b2;
      --accent2:#8aa4ff;
      --warn:#ffd18a;
      --danger:#ff8aa1;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-weight: 950;
      color: var(--text);
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(122,249,184,.16), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(138,164,255,.18), transparent 60%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      padding:22px;
      overflow-x:hidden;
      text-transform: uppercase;
      letter-spacing:.2px;
    }
    .wrap{
      width:min(1180px, 100%);
      margin:0 auto;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 980px){ .wrap{ grid-template-columns:1fr; } }
    .card{
      background: var(--card);
      border:1px solid rgba(255,255,255,.10);
      border-color: rgba(124,247,178,.16);
      border-top-color: rgba(138,164,255,.20);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    header{
      padding:18px 18px 10px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .title{ display:flex; flex-direction:column; gap:6px; }
    h1{ margin:0; font-size: clamp(18px, 2.6vw, 26px); }
    .sub{ margin:0; color: var(--muted); font-size: 13px; }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      user-select:none;
    }
    .badge .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 6px rgba(124,247,178,.10);
    }
    .stage{ padding: 14px 18px 18px; display:grid; gap:14px; }
    .screen{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(520px 260px at 50% 35%, rgba(124,247,178,.10), transparent 60%),
        radial-gradient(560px 260px at 50% 60%, rgba(138,164,255,.07), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.16));
      height: 468px;
      position:relative;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 14px;
    }
    .hud{
      position:absolute;
      inset: 12px 12px auto 12px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      z-index:5;
      pointer-events:none;
    }
    .statusBox{
      max-width: 66%;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(6px);
      font-size: 12px;
      line-height: 1.25;
      box-shadow: 0 12px 26px rgba(0,0,0,.35);
      white-space: pre-line;
      pointer-events:auto;
      user-select:none;
    }
    .pill{
      padding: 9px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      color: var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      pointer-events:none;
    }
    .pill b{ color: var(--text); }
    .floorGlow{
      position:absolute;
      bottom:-110px;
      width: 600px;
      height: 280px;
      border-radius: 999px;
      background: radial-gradient(circle at 50% 35%, rgba(124,247,178,.14), transparent 62%);
      filter: blur(2px);
      opacity:.85;
      pointer-events:none;
    }

    .poppyWrap{
      position:relative;
      width: 270px;
      height: 300px;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      transform-origin: 50% 90%;
      z-index:2;
    }
    .nameTag{
      position:absolute;
      top: 4px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(0,0,0,.18));
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      user-select:none;
      font-size: 12px;
      letter-spacing:.9px;
    }
    .square{
      width: 178px;
      height: 178px;
      border-radius: 22px;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.22), transparent 55%),
        linear-gradient(180deg, rgba(185,255,217,1), rgba(47,228,138,1));
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 0 18px 44px rgba(0,0,0,.36);
      position:relative;
      overflow:hidden;
    }
    .face{
      width: 138px;
      height: 92px;
      border-radius: 22px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(10px);
      box-shadow: 0 16px 26px rgba(0,0,0,.20);
      position:absolute;
      bottom: 34px;
      left: 50%;
      transform: translateX(-50%);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:24px;
      padding-top:12px;
      z-index:2;
    }

    .accLayer{ position:absolute; inset:0; z-index:4; pointer-events:none; }
    .acc{ position:absolute; pointer-events:none; display:none; }
    .acc.show{ display:block; }

    .hat{
      width: 130px; height: 36px;
      left: 50%; top: 22px;
      transform: translateX(-50%);
      border-radius: 16px 16px 10px 10px;
      background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(0,0,0,.20));
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 16px 30px rgba(0,0,0,.24);
    }
    .hat:after{
      content:"";
      position:absolute;
      left: 50%; top: -14px;
      transform: translateX(-50%);
      width: 70px; height: 20px;
      border-radius: 14px 14px 10px 10px;
      background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(0,0,0,.22));
      border: 1px solid rgba(255,255,255,.14);
    }

    .tie{
      width: 16px; height: 48px;
      left: 50%; top: 118px;
      transform: translateX(-50%);
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(0,0,0,.22));
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 14px 24px rgba(0,0,0,.20);
    }
    .tie:before{
      content:"";
      position:absolute;
      left: 50%; top: -12px;
      transform: translateX(-50%);
      width: 22px; height: 14px;
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(0,0,0,.20));
      border:1px solid rgba(255,255,255,.14);
    }

    .glasses{
      width: 120px; height: 28px;
      left: 50%; top: 88px;
      transform: translateX(-50%);
      border-radius: 18px;
      border: 2px solid rgba(11,16,32,.88);
      background: rgba(255,255,255,.08);
      box-shadow: 0 12px 22px rgba(0,0,0,.22);
    }
    .glasses:before,.glasses:after{
      content:"";
      position:absolute;
      top: 4px;
      width: 42px; height: 18px;
      border-radius: 14px;
      border: 2px solid rgba(11,16,32,.88);
      background: rgba(255,255,255,.08);
    }
    .glasses:before{ left: 8px; }
    .glasses:after{ right: 8px; }
    .glasses i{
      position:absolute;
      left: 50%; top: 12px;
      transform: translateX(-50%);
      width: 16px; height: 4px;
      border-radius: 999px;
      background: rgba(11,16,32,.88);
      display:block;
    }

    .bow{
      width: 54px; height: 24px;
      left: 50%; top: 112px;
      transform: translateX(-50%);
      border-radius: 14px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 14px 22px rgba(0,0,0,.20);
    }
    .bow:before,.bow:after{
      content:"";
      position:absolute;
      top: 4px;
      width: 22px; height: 16px;
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.12);
    }
    .bow:before{ left: 4px; }
    .bow:after{ right: 4px; }
    .bow i{
      position:absolute;
      left:50%; top: 9px;
      transform: translateX(-50%);
      width: 10px; height: 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.12);
      display:block;
    }

    .eye{
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: #0b1020;
      box-shadow: 0 0 0 7px rgba(255,255,255,.10);
      position:relative;
      overflow:hidden;
    }
    .eye:after{
      content:"";
      position:absolute;
      width: 6px;height:6px;border-radius:999px;
      background: rgba(255,255,255,.90);
      top: 2px; left: 2px;
    }

    .mouth{
      position:absolute;
      left: 50%;
      bottom: 14px;
      transform: translateX(-50%);
      width: 36px;
      height: 16px;
      border: 3px solid rgba(11,16,32,.92);
      border-top: none;
      border-radius: 0 0 28px 28px;
      background: transparent;
    }

    .brow{
      position:absolute;
      top: 10px;
      width: 24px;
      height: 6px;
      border-radius: 999px;
      background: rgba(11,16,32,.92);
      opacity:0;
    }
    .brow.left{ left: 20px; transform: rotate(-10deg); }
    .brow.right{ right: 20px; transform: rotate(10deg); }

    .mood-happy .mouth{ width: 44px; height: 20px; border-radius: 0 0 30px 30px; }
    .mood-sad .mouth{
      bottom: 18px; width: 44px; height: 16px;
      border-top: 3px solid rgba(11,16,32,.92);
      border-bottom:none; border-radius: 30px 30px 0 0;
    }
    .mood-angry .mouth{
      width: 36px; height: 14px;
      border-top: 3px solid rgba(11,16,32,.92);
      border-bottom:none; border-radius: 22px 22px 0 0;
    }
    .mood-angry .brow{ opacity:1; }
    .mood-angry .brow.left{ transform: rotate(18deg); }
    .mood-angry .brow.right{ transform: rotate(-18deg); }
    .mood-hungry .mouth{
      width: 18px; height: 18px;
      border: 3px solid rgba(11,16,32,.92);
      border-radius: 999px;
    }
    .mood-sick .mouth{
      width: 34px; height: 7px;
      border:none; background: rgba(11,16,32,.92); border-radius: 999px;
    }
    .mood-sick .eye{ height: 11px; }
    .mood-bored .mouth{
      width: 30px; height: 6px;
      border:none; background: rgba(11,16,32,.92); border-radius: 999px;
      opacity:.85;
    }
    .mood-asleep .mouth{
      width: 28px; height: 6px;
      border:none; background: rgba(11,16,32,.92); border-radius: 999px;
      opacity:.65;
    }
    .mood-asleep .eye{ transform: scaleY(.25); }

    @keyframes blink {
      0%, 90%, 100% { transform: scaleY(1); }
      92%, 96% { transform: scaleY(0.15); }
    }
    .blink .eye{ animation: blink 220ms linear 1; transform-origin:center; }

    @keyframes pop { 0%{ transform: scale(1); } 50%{ transform: scale(1.05); } 100%{ transform: scale(1); } }
    @keyframes nod { 0%{ transform: translateY(0); } 40%{ transform: translateY(-8px); } 100%{ transform: translateY(0); } }
    @keyframes wig { 0%{ transform: rotate(0deg); } 25%{ transform: rotate(-8deg); } 50%{ transform: rotate(10deg); } 75%{ transform: rotate(-6deg); } 100%{ transform: rotate(0deg); } }
    .burst-pop .square{ animation: pop 380ms ease-out 1; }
    .burst-nod .poppyWrap{ animation: nod 420ms ease-out 1; }
    .burst-wig .poppyWrap{ animation: wig 520ms ease-in-out 1; }

    .sleepTint{
      position:absolute; inset:0;
      background: radial-gradient(circle at 50% 30%, rgba(138,164,255,.14), rgba(0,0,0,.62));
      opacity:0;
      transition: opacity .25s ease;
      pointer-events:none;
      z-index:3;
    }
    .sleepOn .sleepTint{ opacity:1; }

    .overlay{
      position:absolute;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10;
      background: radial-gradient(circle at 50% 40%, rgba(0,0,0,.20), rgba(0,0,0,.62));
      backdrop-filter: blur(3px);
    }
    .overlay.show{ display:flex; }
    .overlayCard{
      width:min(720px, 94%);
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,14,28,.90);
      box-shadow: 0 22px 60px rgba(0,0,0,.55);
      padding: 14px;
      position:relative;
    }
    .overlayX{
      position:absolute;
      right: 10px; top: 10px;
      width: 44px; height: 40px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--text);
      cursor:pointer;
      display:grid;
      place-items:center;
      user-select:none;
    }
    .overlayX:hover{ border-color: rgba(124,247,178,.42); }
    .overlayTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 2px 50px 10px 2px;
      font-size: 12px;
      color: var(--muted);
    }
    .overlayTop b{ color: var(--text); }
    .overlayTabs{
      display:flex;
      gap:10px;
      margin-bottom: 10px;
      flex-wrap:wrap;
    }
    .tabBtn{
      width:auto;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      cursor:pointer;
    }
    .tabBtn.active{
      border-color: rgba(124,247,178,.46);
      background: rgba(124,247,178,.12);
    }
    .overlayBody{
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 12px;
      min-height: 240px;
      position:relative;
      overflow:hidden;
    }
    .overlayActions{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){ .overlayActions{ grid-template-columns:1fr; } }

    .toast{
      position:fixed;
      left: 16px; right: 16px;
      top: 14px;
      margin:0 auto;
      width: min(900px, calc(100% - 32px));
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
      z-index:9999;
      display:none;
      white-space: pre-line;
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 680px){ .controls{ grid-template-columns:1fr; } }
    .panel{
      padding: 14px 14px 16px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
    }
    .grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    @media (max-width: 680px){ .grid3{ grid-template-columns:1fr; } }

    button{
      width:100%;
      font: inherit;
      font-weight: 950;
      color: var(--text);
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 10px 12px;
      outline:none;
      cursor:pointer;
      letter-spacing:.3px;
      transition: transform .08s ease, filter .2s ease, border-color .2s ease;
    }
    button:hover{ filter: brightness(1.06); border-color: rgba(124,247,178,.42); }
    button:active{ transform: translateY(1px) scale(.99); }
    button:disabled{ opacity:.55; cursor:not-allowed; }
    .btnMain{
      background: linear-gradient(180deg, rgba(124,247,178,.24), rgba(124,247,178,.08));
      border-color: rgba(124,247,178,.22);
    }
    .btnAlt{
      background: linear-gradient(180deg, rgba(138,164,255,.20), rgba(138,164,255,.06));
      border-color: rgba(138,164,255,.22);
    }
    .btnWarn{
      background: linear-gradient(180deg, rgba(255,209,138,.22), rgba(255,209,138,.07));
      border-color: rgba(255,209,138,.22);
    }
    .btnDanger{
      background: linear-gradient(180deg, rgba(255,138,161,.22), rgba(255,138,161,.07));
      border-color: rgba(255,138,161,.22);
    }

    .bars{ display:grid; gap:10px; }
    .barRow{
      display:grid;
      grid-template-columns: 116px 1fr 54px;
      gap:10px;
      align-items:center;
      font-size: 12px;
      color: var(--muted);
    }
    @media (max-width: 420px){ .barRow{ grid-template-columns: 1fr; } }
    .meter{
      height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .fill{
      height:100%;
      width: 50%;
      background: linear-gradient(90deg, rgba(124,247,178,.85), rgba(138,164,255,.85));
    }

    .log{
      height: 310px;
      overflow:auto;
      padding: 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.10);
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
    }
    .log b{ color: var(--text); }
    .log .item{ margin-bottom:10px; }

    .listItem{
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
    .listItem b{ color: var(--text); }

    @media (prefers-reduced-motion: reduce){
      .burst-pop .square,
      .burst-nod .poppyWrap,
      .burst-wig .poppyWrap{ animation:none !important; }
      .overlay, .overlayCard{ backdrop-filter:none; }
    }
  </style>
</head>

<body>
  <div class="toast" id="toast"></div>

  <main class="wrap" id="app">
    <section class="card">
      <header>
        <div class="title">
          <h1>POPPY</h1>
          <p class="sub">SHOP HAS FOOD, WATER, SNACK, SOAP, MED | MADE BY LIAMJONES989 | DETICATED TO MY CAT BUTTERS</p>
        </div>
        <div class="badge">
          <span class="dot" id="statusDot"></span>
          <span id="statusText">ALIVE</span>
        </div>
      </header>

      <div class="stage">
        <div class="screen" id="screen">
          <div class="sleepTint" id="sleepTint"></div>

          <div class="hud">
            <div class="statusBox" id="statusBox">POPPY IS IDLE. CLICK A BUTTON.</div>
            <div class="pill">
              MOOD <b id="moodPill">HAPPY</b>
              LVL <b id="lvlPill">1</b>
              AGE <b id="agePill">0</b>
              COINS <b id="coinsPill">8</b>
            </div>
          </div>

          <div class="floorGlow"></div>

          <div class="poppyWrap" id="poppyWrap">
            <div class="nameTag">POPPY</div>
            <div class="square" id="square">
              <div class="accLayer">
                <div class="acc hat" id="accHat"></div>
                <div class="acc tie" id="accTie"></div>
                <div class="acc glasses" id="accGlasses"><i></i></div>
                <div class="acc bow" id="accBow"><i></i></div>
              </div>

              <div class="face" id="face">
                <div class="brow left"></div>
                <div class="brow right"></div>
                <div class="eye"></div>
                <div class="eye"></div>
                <div class="mouth"></div>
              </div>
            </div>
          </div>

          <div class="overlay" id="overlay" aria-hidden="true">
            <div class="overlayCard" role="dialog" aria-modal="true">
              <div class="overlayX" id="overlayX" title="CLOSE">X</div>

              <div class="overlayTop">
                <div>MODE <b id="overlayTitle">ACTION</b></div>
                <div>TIME <b id="overlayTimer">INF</b></div>
              </div>

              <div class="overlayTabs" id="overlayTabs" style="display:none;"></div>
              <div class="overlayBody" id="overlayBody"></div>

              <div class="overlayActions">
                <button class="btnMain" id="overlayPrimary" type="button">DONE</button>
                <button class="btnAlt" id="overlayClose" type="button">CLOSE</button>
              </div>
            </div>
          </div>
        </div>

        <div class="controls">
          <div class="panel">
            <div class="bars">
              <div class="barRow"><span>HUNGER</span><div class="meter"><div class="fill" id="hungerFill"></div></div><span id="hungerVal">55</span></div>
              <div class="barRow"><span>HAPPINESS</span><div class="meter"><div class="fill" id="happyFill"></div></div><span id="happyVal">70</span></div>
              <div class="barRow"><span>ENERGY</span><div class="meter"><div class="fill" id="energyFill"></div></div><span id="energyVal">70</span></div>
              <div class="barRow"><span>CLEANLINESS</span><div class="meter"><div class="fill" id="cleanFill"></div></div><span id="cleanVal">60</span></div>
              <div class="barRow"><span>HEALTH</span><div class="meter"><div class="fill" id="healthFill"></div></div><span id="healthVal">90</span></div>
              <div class="barRow"><span>DISCIPLINE</span><div class="meter"><div class="fill" id="discFill"></div></div><span id="discVal">50</span></div>
              <div class="barRow"><span>XP</span><div class="meter"><div class="fill" id="xpFill"></div></div><span id="xpVal">0</span></div>
            </div>
          </div>

          <div class="panel">
            <div class="grid3">
              <button class="btnMain" id="btnFeed" type="button">FEED</button>
              <button class="btnMain" id="btnSleep" type="button">SLEEP</button>
              <button class="btnMain" id="btnClean" type="button">CLEAN</button>

              <button class="btnWarn" id="btnMed" type="button">MEDICINE</button>
              <button class="btnAlt" id="btnWork" type="button">WORK</button>
              <button class="btnAlt" id="btnTrain" type="button">TRAIN</button>

              <button class="btnAlt" id="btnInventory" type="button">INVENTORY</button>
              <button class="btnAlt" id="btnShop" type="button">SHOP</button>
              <button class="btnAlt" id="btnAchievements" type="button">ACHIEVEMENTS</button>

              <button class="btnAlt" id="btnSettings" type="button">SETTINGS</button>
              <button class="btnAlt" id="btnPause" type="button">PAUSE</button>
              <button class="btnDanger" id="btnReset" type="button">RESET</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <aside class="card" style="padding:16px 16px 18px;">
      <h2 style="margin:0 0 10px; font-size:16px;">EVENT LOG</h2>
      <div class="log" id="log"></div>

      <div class="panel" style="margin-top:12px;">
        <h2 style="margin:0 0 10px; font-size:16px;">NOTES</h2>
        <div class="listItem"><b>SHOP</b> BUY ITEMS FOR INVENTORY AND BUY ACCESSORIES THAT AUTO-EQUIP</div>
        <div class="listItem"><b>FOOD RULE</b> FOOD +5 SATURATION | SNACK +1 SATURATION</div>
        <div class="listItem"><b>CLOSE</b> CLOSE, X, ESC, OR CLICK OUTSIDE</div>
      </div>
    </aside>
  </main>

  <script>
    (function(){
      const $ = (id)=>document.getElementById(id);
      const toast = $("toast");
      const app = $("app");
      function tmsg(msg){
        toast.style.display = "block";
        toast.textContent = msg;
        clearTimeout(tmsg._t);
        tmsg._t = setTimeout(()=>{ toast.style.display = "none"; }, 1600);
      }
      function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
      function rint(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
      function chance(p){ return Math.random() < p; }

      const SAVE_KEY = "POPPY_TAMAGOTCHI_SAVE_V5";

      const defaultState = ()=>({
        alive:true,
        paused:false,
        autoCare:false,
        autoSave:true,
        mode:"NORMAL",
        age:0,
        coins:8,
        lvl:1,
        xp:0,

        hunger:55,
        happy:70,
        energy:70,
        clean:60,
        health:90,
        disc:50,

        inv:{ FOOD:2, SNACK:2, WATER:2, SOAP:1, MED:1 },

        ownedAccessories: { HAT:false, TIE:false, GLASSES:false, BOW:false },
        equippedAccessories: { HAT:false, TIE:false, GLASSES:false, BOW:false },

        counters:{
          feeds:0, snacks:0, waters:0, cleans:0, meds:0,
          works:0, trains:0, purchases:0
        },

        unlockedAchievements:{},
        last: Date.now()
      });

      function mergeDeep(target, source){
        const out = Array.isArray(target) ? target.slice() : { ...target };
        for (const k in source){
          if (!Object.prototype.hasOwnProperty.call(source, k)) continue;
          const sv = source[k];
          const tv = out[k];
          if (sv && typeof sv === "object" && !Array.isArray(sv) && tv && typeof tv === "object" && !Array.isArray(tv)){
            out[k] = mergeDeep(tv, sv);
          } else out[k] = sv;
        }
        return out;
      }

      let S = defaultState();
      function load(){
        try{
          const raw = localStorage.getItem(SAVE_KEY);
          if (!raw) return false;
          S = mergeDeep(defaultState(), JSON.parse(raw));
          return true;
        } catch(e){ return false; }
      }
      function save(){
        if (!S.autoSave) return;
        try{
          S.last = Date.now();
          localStorage.setItem(SAVE_KEY, JSON.stringify(S));
        } catch(e){}
      }

      // ELEMENTS
      const screen = $("screen");
      const face = $("face");
      const statusBox = $("statusBox");
      const moodPill = $("moodPill");
      const lvlPill = $("lvlPill");
      const agePill = $("agePill");
      const coinsPill = $("coinsPill");
      const statusDot = $("statusDot");
      const statusText = $("statusText");
      const logEl = $("log");

      const fills = {
        hunger: $("hungerFill"),
        happy: $("happyFill"),
        energy: $("energyFill"),
        clean: $("cleanFill"),
        health: $("healthFill"),
        disc: $("discFill"),
        xp: $("xpFill")
      };
      const vals = {
        hunger: $("hungerVal"),
        happy: $("happyVal"),
        energy: $("energyVal"),
        clean: $("cleanVal"),
        health: $("healthVal"),
        disc: $("discVal"),
        xp: $("xpVal")
      };

      const accEls = {
        HAT: $("accHat"),
        TIE: $("accTie"),
        GLASSES: $("accGlasses"),
        BOW: $("accBow")
      };

      // Overlay
      const overlay = $("overlay");
      const overlayX = $("overlayX");
      const overlayTitle = $("overlayTitle");
      const overlayTimer = $("overlayTimer");
      const overlayTabs = $("overlayTabs");
      const overlayBody = $("overlayBody");
      const overlayPrimary = $("overlayPrimary");
      const overlayClose = $("overlayClose");

      // Buttons
      const btnFeed = $("btnFeed");
      const btnSleep = $("btnSleep");
      const btnClean = $("btnClean");
      const btnMed = $("btnMed");
      const btnWork = $("btnWork");
      const btnTrain = $("btnTrain");
      const btnInventory = $("btnInventory");
      const btnShop = $("btnShop");
      const btnAchievements = $("btnAchievements");
      const btnSettings = $("btnSettings");
      const btnPause = $("btnPause");
      const btnReset = $("btnReset");

      function log(msg){
        const t = new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = "<b>" + t + "</b> | " + msg;
        logEl.prepend(div);
      }

      function burst(cls, ms){
        app.classList.add(cls);
        setTimeout(()=>app.classList.remove(cls), ms);
      }
      function blink(){
        face.classList.add("blink");
        setTimeout(()=>face.classList.remove("blink"), 250);
      }

      function mood(){
        if (!S.alive) return "DEAD";
        if (S.mode === "SLEEPING") return "ASLEEP";
        if (S.health <= 20 || S.mode === "SICK") return "SICK";
        if (S.hunger <= 25) return "HUNGRY";
        if (S.clean <= 20) return "ANGRY";
        if (S.happy <= 25) return "SAD";
        if (S.energy <= 20) return "BORED";
        return "HAPPY";
      }
      function setFaceMoodClass(m){
        face.classList.remove("mood-happy","mood-sad","mood-angry","mood-hungry","mood-sick","mood-bored","mood-asleep");
        if (m === "ASLEEP") face.classList.add("mood-asleep");
        else if (m !== "DEAD") face.classList.add("mood-" + m.toLowerCase());
      }

      function xpToNext(lvl){ return 30 + (lvl-1)*18; }
      function addXP(amount){
        S.xp += amount;
        while (S.xp >= xpToNext(S.lvl)){
          S.xp -= xpToNext(S.lvl);
          S.lvl += 1;
          S.coins += 2;
          log("LEVEL UP " + S.lvl + " COINS +2");
        }
      }

      function have(item, n=1){ return (S.inv[item] || 0) >= n; }
      function addItem(item, n=1){ S.inv[item] = (S.inv[item] || 0) + n; }
      function takeItem(item, n=1){
        if (!have(item,n)) return false;
        S.inv[item] -= n;
        return true;
      }

      // ACHIEVEMENTS (RE-ADDED, MORE)
      const ACH = [
        { id:"FIRST_FEED", name:"FIRST FEED", desc:"FEED POPPY ONCE", check:()=>S.counters.feeds>=1 },
        { id:"SNACK_5", name:"SNACK TIME", desc:"EAT 5 SNACKS", check:()=>S.counters.snacks>=5 },
        { id:"WATER_5", name:"HYDRATED", desc:"DRINK 5 WATERS", check:()=>S.counters.waters>=5 },
        { id:"CLEAN_5", name:"CLEAN MACHINE", desc:"CLEAN 5 TIMES", check:()=>S.counters.cleans>=5 },
        { id:"WORK_5", name:"WORK ETHIC", desc:"WORK 5 TIMES", check:()=>S.counters.works>=5 },
        { id:"LEVEL_3", name:"LEVEL 3", desc:"REACH LEVEL 3", check:()=>S.lvl>=3 },
        { id:"FIRST_BUY", name:"FIRST BUY", desc:"BUY ANYTHING IN SHOP", check:()=>S.counters.purchases>=1 },
        { id:"ACCESSORY_2", name:"WARDROBE", desc:"OWN 2 ACCESSORIES", check:()=>ownedCount()>=2 },
        { id:"COINS_25", name:"SAVINGS", desc:"HOLD 25 COINS", check:()=>S.coins>=25 }
      ];
      function ownedCount(){
        const o = S.ownedAccessories;
        return (o.HAT?1:0)+(o.TIE?1:0)+(o.GLASSES?1:0)+(o.BOW?1:0);
      }
      function unlockAchievements(){
        for (const a of ACH){
          if (!S.unlockedAchievements[a.id] && a.check()){
            S.unlockedAchievements[a.id] = true;
            log("ACHIEVEMENT UNLOCKED " + a.name);
            tmsg("ACHIEVEMENT UNLOCKED\n" + a.name);
          }
        }
      }

      // SHOP: SUPPLIES + ACCESSORIES
      const SHOP_SUPPLIES = [
        { id:"FOOD",  name:"FOOD",  cost:3,  qty:1, desc:"INVENTORY FOOD | FEED +5 SATURATION" },
        { id:"SNACK", name:"SNACK", cost:1,  qty:1, desc:"INVENTORY SNACK | FEED +1 SATURATION" },
        { id:"WATER", name:"WATER", cost:2,  qty:1, desc:"INVENTORY WATER | HEALTH AND ENERGY" },
        { id:"SOAP",  name:"SOAP",  cost:2,  qty:1, desc:"INVENTORY SOAP | CLEANLINESS" },
        { id:"MED",   name:"MED",   cost:4,  qty:1, desc:"INVENTORY MED | HEALTH" }
      ];
      const SHOP_ACCESSORIES = [
        { id:"HAT", name:"HAT", cost:12, desc:"TOP ACCESSORY" },
        { id:"TIE", name:"TIE", cost:9,  desc:"FRONT ACCESSORY" },
        { id:"GLASSES", name:"GLASSES", cost:15, desc:"FACE ACCESSORY" },
        { id:"BOW", name:"BOW", cost:10, desc:"FRONT ACCESSORY" }
      ];

      function renderAccessories(){
        for (const k of ["HAT","TIE","GLASSES","BOW"]){
          const el = accEls[k];
          if (!el) continue;
          if (S.equippedAccessories[k]) el.classList.add("show");
          else el.classList.remove("show");
        }
      }

      function updateUI(){
        S.hunger = clamp(S.hunger, 0, 100);
        S.happy  = clamp(S.happy, 0, 100);
        S.energy = clamp(S.energy, 0, 100);
        S.clean  = clamp(S.clean, 0, 100);
        S.health = clamp(S.health, 0, 100);
        S.disc   = clamp(S.disc, 0, 100);

        fills.hunger.style.width = S.hunger + "%";
        fills.happy.style.width  = S.happy + "%";
        fills.energy.style.width = S.energy + "%";
        fills.clean.style.width  = S.clean + "%";
        fills.health.style.width = S.health + "%";
        fills.disc.style.width   = S.disc + "%";
        fills.xp.style.width     = clamp(Math.floor((S.xp / xpToNext(S.lvl)) * 100),0,100) + "%";

        vals.hunger.textContent = String(Math.round(S.hunger));
        vals.happy.textContent  = String(Math.round(S.happy));
        vals.energy.textContent = String(Math.round(S.energy));
        vals.clean.textContent  = String(Math.round(S.clean));
        vals.health.textContent = String(Math.round(S.health));
        vals.disc.textContent   = String(Math.round(S.disc));
        vals.xp.textContent     = String(Math.round(S.xp));

        const m = mood();
        moodPill.textContent = m;
        lvlPill.textContent  = String(S.lvl);
        agePill.textContent  = String(S.age);
        coinsPill.textContent= String(S.coins);

        setFaceMoodClass(m);

        statusText.textContent = (!S.alive) ? "DEAD" : (S.paused ? "PAUSED" : "ALIVE");
        statusDot.style.background = (!S.alive) ? "var(--danger)" :
          (m === "SICK" || m === "ANGRY") ? "var(--danger)" :
          (m === "HUNGRY" || m === "SAD") ? "var(--warn)" : "var(--accent)";

        statusBox.textContent =
          "POPPY STATUS\n" +
          "MOOD " + m + "\n" +
          "MODE " + S.mode + "\n" +
          "COINS " + S.coins + "\n" +
          "FOOD " + (S.inv.FOOD||0) + " SNACK " + (S.inv.SNACK||0) + " WATER " + (S.inv.WATER||0) + "\n" +
          "SOAP " + (S.inv.SOAP||0) + " MED " + (S.inv.MED||0);

        if (S.mode === "SLEEPING") screen.classList.add("sleepOn");
        else screen.classList.remove("sleepOn");

        renderAccessories();
        save();
      }

      // OVERLAY
      function closeOverlay(){
        overlay.classList.remove("show");
        overlay.setAttribute("aria-hidden","true");
        overlayTabs.style.display = "none";
        overlayTabs.innerHTML = "";
        overlayBody.innerHTML = "";
        overlayTitle.textContent = "ACTION";
        overlayTimer.textContent = "INF";
        overlayPrimary.textContent = "DONE";
        overlayClose.textContent = "CLOSE";
        updateUI();
      }
      function openOverlay(mode){
        overlayTitle.textContent = mode;
        overlayTimer.textContent = "INF";
        overlay.classList.add("show");
        overlay.setAttribute("aria-hidden","false");
      }

      overlayX.addEventListener("click", closeOverlay);
      overlayClose.addEventListener("click", closeOverlay);
      overlayPrimary.addEventListener("click", closeOverlay);
      overlay.addEventListener("click", (e)=>{ if (e.target === overlay) closeOverlay(); });
      window.addEventListener("keydown", (e)=>{
        if (!overlay.classList.contains("show")) return;
        if (e.key.toLowerCase() === "escape"){ e.preventDefault(); closeOverlay(); }
      }, {passive:false});

      function menuTitle(text){
        return "<div style='color:var(--muted); font-size:12px; line-height:1.35; text-align:left; width:100%;'>" +
               "<b style='color:var(--text);'>" + text + "</b>" +
               "</div>";
      }
      function row(title, desc, btnClass, id, btnText){
        return "<div class='listItem' style='display:flex; justify-content:space-between; align-items:center; gap:12px; width:100%;'>" +
               "<div style='flex:1;'><b>" + title + "</b><div style='margin-top:6px;'>" + desc + "</div></div>" +
               "<div style='min-width:160px;'><button class='" + btnClass + "' id='" + id + "' type='button'>" + (btnText||"USE") + "</button></div>" +
               "</div>";
      }
      function setTabs(tabs, activeId){
        overlayTabs.style.display = "flex";
        overlayTabs.innerHTML = "";
        for (const t of tabs){
          const b = document.createElement("button");
          b.className = "tabBtn" + (t.id === activeId ? " active" : "");
          b.type = "button";
          b.textContent = t.label;
          b.onclick = ()=> t.onClick();
          overlayTabs.appendChild(b);
        }
      }

      // MENUS
      function openInventory(){
        openOverlay("INVENTORY");
        overlayTabs.style.display = "none";

        const inv = S.inv;
        overlayBody.innerHTML =
          menuTitle("INVENTORY") +
          "<div style='display:grid; gap:10px; margin-top:10px; width:100%;'>" +
            row("FOOD X " + (inv.FOOD||0), "EAT FOOD | +5 SATURATION", (inv.FOOD||0) ? "btnMain" : "btnAlt", "inv_food", "USE") +
            row("SNACK X " + (inv.SNACK||0), "EAT SNACK | +1 SATURATION", (inv.SNACK||0) ? "btnMain" : "btnAlt", "inv_snack", "USE") +
            row("WATER X " + (inv.WATER||0), "DRINK WATER", (inv.WATER||0) ? "btnMain" : "btnAlt", "inv_water", "USE") +
            row("SOAP X " + (inv.SOAP||0), "CLEAN POPPY", (inv.SOAP||0) ? "btnMain" : "btnAlt", "inv_soap", "USE") +
            row("MED X " + (inv.MED||0), "USE MEDICINE", (inv.MED||0) ? "btnWarn" : "btnAlt", "inv_med", "USE") +
          "</div>";

        overlayBody.querySelector("#inv_food").onclick = ()=>{
          if (!takeItem("FOOD",1)) return tmsg("NO FOOD");
          S.hunger += 5; S.happy += 2; S.clean -= 1;
          S.counters.feeds += 1; addXP(6); unlockAchievements();
          log("ATE FOOD +5 SATURATION"); burst("burst-pop", 260);
          updateUI(); openInventory();
        };
        overlayBody.querySelector("#inv_snack").onclick = ()=>{
          if (!takeItem("SNACK",1)) return tmsg("NO SNACK");
          S.hunger += 1; S.happy += 2;
          S.counters.feeds += 1; S.counters.snacks += 1;
          addXP(4); unlockAchievements();
          log("ATE SNACK +1 SATURATION"); burst("burst-pop", 220);
          updateUI(); openInventory();
        };
        overlayBody.querySelector("#inv_water").onclick = ()=>{
          if (!takeItem("WATER",1)) return tmsg("NO WATER");
          S.health += 6; S.energy += 5; S.happy += 1;
          S.counters.waters += 1; addXP(4); unlockAchievements();
          log("DRANK WATER"); burst("burst-nod", 420);
          updateUI(); openInventory();
        };
        overlayBody.querySelector("#inv_soap").onclick = ()=>{
          if (!takeItem("SOAP",1)) return tmsg("NO SOAP");
          S.clean += 22; S.happy += 2;
          S.counters.cleans += 1; addXP(6); unlockAchievements();
          log("CLEANED"); burst("burst-wig", 520);
          updateUI(); openInventory();
        };
        overlayBody.querySelector("#inv_med").onclick = ()=>{
          if (!takeItem("MED",1)) return tmsg("NO MED");
          S.health += 20; S.mode = "NORMAL";
          S.counters.meds += 1; addXP(7); unlockAchievements();
          log("MEDICINE USED"); burst("burst-pop", 260);
          updateUI(); openInventory();
        };
      }

      function openShop(){
        openOverlay("SHOP");

        function renderSupplies(){
          setTabs([
            {id:"SUPPLIES", label:"SUPPLIES", onClick: renderSupplies},
            {id:"ACCESSORIES", label:"ACCESSORIES", onClick: renderAccessoriesTab},
            {id:"WARDROBE", label:"WARDROBE", onClick: renderWardrobe}
          ], "SUPPLIES");

          let html = menuTitle("SUPPLIES") + "<div style='display:grid; gap:10px; margin-top:10px; width:100%;'>";
          for (const it of SHOP_SUPPLIES){
            const canBuy = S.coins >= it.cost;
            html += row(
              it.name + " | OWN " + (S.inv[it.id]||0),
              it.desc + " | COST " + it.cost,
              canBuy ? "btnMain" : "btnAlt",
              "buy_" + it.id,
              "BUY"
            );
          }
          html += "</div>";
          overlayBody.innerHTML = html;

          for (const it of SHOP_SUPPLIES){
            overlayBody.querySelector("#buy_" + it.id).onclick = ()=>{
              if (S.coins < it.cost) return tmsg("NOT ENOUGH COINS");
              S.coins -= it.cost;
              addItem(it.id, it.qty);
              S.counters.purchases += 1;
              addXP(3);
              unlockAchievements();
              log("BOUGHT " + it.name + " +" + it.qty);
              burst("burst-pop", 220);
              updateUI();
              renderSupplies();
            };
          }
        }

        function renderAccessoriesTab(){
          setTabs([
            {id:"SUPPLIES", label:"SUPPLIES", onClick: renderSupplies},
            {id:"ACCESSORIES", label:"ACCESSORIES", onClick: renderAccessoriesTab},
            {id:"WARDROBE", label:"WARDROBE", onClick: renderWardrobe}
          ], "ACCESSORIES");

          let html = menuTitle("ACCESSORIES") + "<div style='display:grid; gap:10px; margin-top:10px; width:100%;'>";
          for (const it of SHOP_ACCESSORIES){
            const owned = !!S.ownedAccessories[it.id];
            const canBuy = S.coins >= it.cost && !owned;
            html += row(
              it.name + (owned ? " | OWNED" : ""),
              it.desc + " | COST " + it.cost,
              owned ? "btnAlt" : (canBuy ? "btnMain" : "btnAlt"),
              "buyacc_" + it.id,
              owned ? "OWNED" : "BUY"
            );
          }
          html += "</div>";
          overlayBody.innerHTML = html;

          for (const it of SHOP_ACCESSORIES){
            overlayBody.querySelector("#buyacc_" + it.id).onclick = ()=>{
              if (S.ownedAccessories[it.id]) return tmsg("ALREADY OWNED");
              if (S.coins < it.cost) return tmsg("NOT ENOUGH COINS");
              S.coins -= it.cost;
              S.ownedAccessories[it.id] = true;
              S.equippedAccessories[it.id] = true; // AUTO SHOW ON POPPY
              S.counters.purchases += 1;
              addXP(6);
              unlockAchievements();
              log("BOUGHT AND EQUIPPED " + it.name);
              burst("burst-wig", 520);
              updateUI();
              renderAccessoriesTab();
            };
          }
        }

        function renderWardrobe(){
          setTabs([
            {id:"SUPPLIES", label:"SUPPLIES", onClick: renderSupplies},
            {id:"ACCESSORIES", label:"ACCESSORIES", onClick: renderAccessoriesTab},
            {id:"WARDROBE", label:"WARDROBE", onClick: renderWardrobe}
          ], "WARDROBE");

          let html = menuTitle("WARDROBE") + "<div style='display:grid; gap:10px; margin-top:10px; width:100%;'>";
          for (const it of SHOP_ACCESSORIES){
            const owned = !!S.ownedAccessories[it.id];
            const equipped = !!S.equippedAccessories[it.id];
            if (!owned){
              html += "<div class='listItem'><b>" + it.name + "</b><div style='margin-top:6px;'>NOT OWNED</div></div>";
              continue;
            }
            html += row(
              it.name + (equipped ? " | EQUIPPED" : ""),
              "TOGGLE EQUIP",
              equipped ? "btnMain" : "btnAlt",
              "eq_" + it.id,
              equipped ? "UNEQUIP" : "EQUIP"
            );
          }
          html += "</div>";
          overlayBody.innerHTML = html;

          for (const it of SHOP_ACCESSORIES){
            const btn = overlayBody.querySelector("#eq_" + it.id);
            if (!btn) continue;
            btn.onclick = ()=>{
              S.equippedAccessories[it.id] = !S.equippedAccessories[it.id];
              log((S.equippedAccessories[it.id] ? "EQUIPPED " : "UNEQUIPPED ") + it.name);
              burst("burst-pop", 220);
              updateUI();
              renderWardrobe();
            };
          }
        }

        renderSupplies();
      }

      function openAchievements(){
        openOverlay("ACHIEVEMENTS");
        overlayTabs.style.display = "none";
        unlockAchievements();

        let unlocked = 0;
        for (const a of ACH) if (S.unlockedAchievements[a.id]) unlocked++;

        let html = menuTitle("ACHIEVEMENTS " + unlocked + " / " + ACH.length) +
          "<div style='display:grid; gap:10px; margin-top:10px; width:100%;'>";
        for (const a of ACH){
          const ok = !!S.unlockedAchievements[a.id];
          html += "<div class='listItem' style='border-color:" + (ok ? "rgba(124,247,178,.35)" : "rgba(255,255,255,.10)") + ";'>" +
                  "<b>" + a.name + "</b>" +
                  "<div style='margin-top:6px;'>" + a.desc + "</div>" +
                  "<div style='margin-top:6px; color:var(--muted);'>" + (ok ? "UNLOCKED" : "LOCKED") + "</div>" +
                  "</div>";
        }
        html += "</div>";
        overlayBody.innerHTML = html;
      }

      function openSettings(){
        openOverlay("SETTINGS");
        overlayTabs.style.display = "none";
        overlayBody.innerHTML =
          menuTitle("SETTINGS") +
          "<div style='display:grid; gap:10px; margin-top:10px; width:100%;'>" +
            row("AUTO CARE", "AUTO FEED AND CLEAN WHEN LOW (USES INVENTORY)", "btnAlt", "set_autoCare", (S.autoCare ? "ON" : "OFF")) +
            row("AUTO SAVE", "SAVE TO BROWSER STORAGE", "btnAlt", "set_autoSave", (S.autoSave ? "ON" : "OFF")) +
            row("CLEAR SAVE", "RESET SAVE FILE ONLY", "btnDanger", "set_clearSave", "CLEAR") +
          "</div>";

        overlayBody.querySelector("#set_autoCare").onclick = ()=>{
          S.autoCare = !S.autoCare;
          log("AUTO CARE " + (S.autoCare ? "ON" : "OFF"));
          tmsg("AUTO CARE " + (S.autoCare ? "ON" : "OFF"));
          updateUI();
          openSettings();
        };
        overlayBody.querySelector("#set_autoSave").onclick = ()=>{
          S.autoSave = !S.autoSave;
          log("AUTO SAVE " + (S.autoSave ? "ON" : "OFF"));
          tmsg("AUTO SAVE " + (S.autoSave ? "ON" : "OFF"));
          try{
            if (S.autoSave) localStorage.setItem(SAVE_KEY, JSON.stringify(S));
          } catch(e){}
          openSettings();
        };
        overlayBody.querySelector("#set_clearSave").onclick = ()=>{
          const ok = confirm("CLEAR SAVE FILE?");
          if (!ok) return;
          try{ localStorage.removeItem(SAVE_KEY); }catch(e){}
          log("SAVE CLEARED");
          tmsg("SAVE CLEARED");
        };
      }

      // BASIC ACTIONS
      function actSleepToggle(){
        if (S.mode === "SLEEPING"){ S.mode = "NORMAL"; log("WOKE UP"); }
        else { S.mode = "SLEEPING"; log("SLEEP START"); }
        burst("burst-nod", 420);
        updateUI();
      }

      // BUTTON WIRING
      btnInventory.addEventListener("click", openInventory);
      btnShop.addEventListener("click", openShop);
      btnAchievements.addEventListener("click", openAchievements);
      btnSettings.addEventListener("click", openSettings);

      btnFeed.addEventListener("click", ()=>{
        // OPEN INVENTORY DIRECTLY TO FEED
        openInventory();
      });

      btnSleep.addEventListener("click", actSleepToggle);

      btnClean.addEventListener("click", ()=>{
        if (!takeItem("SOAP",1)) return tmsg("NO SOAP");
        S.clean += 22; S.happy += 2;
        S.counters.cleans += 1; addXP(6); unlockAchievements();
        log("CLEANED"); burst("burst-wig", 520);
        updateUI();
      });

      btnMed.addEventListener("click", ()=>{
        if (!takeItem("MED",1)) return tmsg("NO MED");
        S.health += 20;
        S.counters.meds += 1; addXP(7); unlockAchievements();
        log("MEDICINE USED"); burst("burst-pop", 260);
        updateUI();
      });

      btnWork.addEventListener("click", ()=>{
        const earned = rint(2,5);
        S.coins += earned;
        S.energy -= 8; S.hunger -= 2; S.happy -= 1;
        S.counters.works += 1; addXP(7); unlockAchievements();
        log("WORK EARNED " + earned); burst("burst-nod", 420);
        updateUI();
      });

      btnTrain.addEventListener("click", ()=>{
        if (S.energy < 10) return tmsg("LOW ENERGY");
        S.disc += 8; S.energy -= 10; S.happy -= 1;
        S.counters.trains += 1; addXP(8); unlockAchievements();
        log("TRAIN COMPLETE"); burst("burst-pop", 260);
        updateUI();
      });

      btnPause.addEventListener("click", ()=>{
        S.paused = !S.paused;
        log(S.paused ? "PAUSED" : "RESUMED");
        tmsg(S.paused ? "PAUSED" : "RESUMED");
        updateUI();
      });

      btnReset.addEventListener("click", ()=>{
        const ok = confirm("RESET POPPY?");
        if (!ok) return;
        S = defaultState();
        logEl.innerHTML = "";
        log("RESET COMPLETE");
        tmsg("RESET");
        updateUI();
      });

      // TICK LOOP
      const TICK_MS = 25000;

      function autoCareTick(){
        if (!S.autoCare) return;
        if (S.mode === "SLEEPING") return;

        if (S.hunger < 28 && have("FOOD",1)){
          takeItem("FOOD",1);
          S.hunger += 5; S.happy += 1;
          S.counters.feeds += 1;
          log("AUTO CARE FED FOOD");
        } else if (S.hunger < 28 && have("SNACK",1)){
          takeItem("SNACK",1);
          S.hunger += 1; S.happy += 1;
          S.counters.feeds += 1; S.counters.snacks += 1;
          log("AUTO CARE FED SNACK");
        }

        if (S.clean < 24 && have("SOAP",1)){
          takeItem("SOAP",1);
          S.clean += 22;
          S.counters.cleans += 1;
          log("AUTO CARE CLEANED");
        }

        if (S.health < 22 && have("MED",1)){
          takeItem("MED",1);
          S.health += 20;
          S.counters.meds += 1;
          log("AUTO CARE USED MED");
        }
      }

      function tick(){
        if (!S.alive || S.paused) return;

        if (chance(0.14)) blink();

        S.age += 1;

        if (S.mode === "SLEEPING"){
          S.energy += 5;
          S.health += 1;
          S.hunger -= 1;
        } else {
          S.hunger -= 1.2;
          S.energy -= 1.2;
          S.clean  -= 0.8;
          S.happy  -= 0.8;
        }

        // health damage when neglected
        let dmg = 0;
        if (S.hunger <= 10) dmg += 3;
        if (S.clean  <= 10) dmg += 3;
        if (S.energy <= 8)  dmg += 2;
        if (S.happy  <= 8)  dmg += 2;
        S.health -= dmg;

        autoCareTick();

        // passive xp
        S.xp += 1;
        while (S.xp >= xpToNext(S.lvl)){
          S.xp -= xpToNext(S.lvl);
          S.lvl += 1;
          S.coins += 2;
          log("LEVEL UP " + S.lvl + " COINS +2");
        }

        if (S.health <= 0){
          S.alive = false;
          S.health = 0;
          log("POPPY DIED");
          tmsg("POPPY DIED");
        }

        unlockAchievements();
        updateUI();
      }

      // START
      const loaded = load();
      logEl.innerHTML = "";
      log(loaded ? "SAVE LOADED" : "WELCOME TO POPPY");
      updateUI();

      setInterval(tick, TICK_MS);
    })();
  </script>
</body>
</html>
