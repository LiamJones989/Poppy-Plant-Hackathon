<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>POPPY | TAMAGOTCHI</title>
  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#101a33;
      --card:rgba(15,23,48,.86);
      --text:#eef2ff;
      --muted:#c7d2ff;
      --accent:#7cf7b2;
      --accent2:#8aa4ff;
      --warn:#ffd18a;
      --danger:#ff8aa1;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
      --ink:#0b1020;
      --good:rgba(124,247,178,.22);
      --goodB:rgba(124,247,178,.30);
      --blue:rgba(138,164,255,.22);
      --blueB:rgba(138,164,255,.30);
      --warnA:rgba(255,209,138,.22);
      --warnB:rgba(255,209,138,.30);
      --badA:rgba(255,138,161,.22);
      --badB:rgba(255,138,161,.30);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      font-weight: 950;
      color: var(--text);
      background:
        radial-gradient(900px 600px at 15% 10%, rgba(122,249,184,.16), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(138,164,255,.18), transparent 60%),
        linear-gradient(160deg, var(--bg1), var(--bg2));
      padding:22px;
      overflow-x:hidden;
      text-transform: uppercase;
      letter-spacing:.2px;
    }

    .wrap{
      width:min(1180px, 100%);
      margin:0 auto;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 980px){ .wrap{ grid-template-columns:1fr; } }

    .card{
      background: var(--card);
      border:1px solid rgba(255,255,255,.10);
      border-color: rgba(124,247,178,.16);
      border-top-color: rgba(138,164,255,.20);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    header{
      padding:18px 18px 10px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }

    .title{ display:flex; flex-direction:column; gap:6px; }
    h1{ margin:0; font-size: clamp(18px, 2.6vw, 26px); }
    .sub{ margin:0; color: var(--muted); font-size: 13px; }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      user-select:none;
    }
    .badge .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--accent);
      box-shadow: 0 0 0 6px rgba(124,247,178,.10);
    }

    .stage{
      padding: 14px 18px 18px;
      display:grid;
      gap:14px;
    }

    .screen{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(520px 260px at 50% 35%, rgba(124,247,178,.10), transparent 60%),
        radial-gradient(560px 260px at 50% 60%, rgba(138,164,255,.07), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.16));
      height: 448px;
      position:relative;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 14px;
    }

    .hud{
      position:absolute;
      inset: 12px 12px auto 12px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      pointer-events:none;
      z-index:5;
    }

    .statusBox{
      max-width: 66%;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(6px);
      font-size: 12px;
      line-height: 1.25;
      box-shadow: 0 12px 26px rgba(0,0,0,.35);
      white-space: pre-line;
    }

    .pill{
      padding: 9px 10px;
      border-radius: 999px;
      font-size: 12px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      color: var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .pill b{ color: var(--text); }

    .floorGlow{
      position:absolute;
      bottom:-110px;
      width: 600px;
      height: 280px;
      border-radius: 999px;
      background: radial-gradient(circle at 50% 35%, rgba(124,247,178,.14), transparent 62%);
      filter: blur(2px);
      opacity:.85;
      pointer-events:none;
    }

    /* POPPY */
    .poppyWrap{
      position:relative;
      width: 270px;
      height: 300px;
      display:flex;
      align-items:flex-end;
      justify-content:center;
      transform-origin: 50% 90%;
      z-index:2;
    }

    .nameTag{
      position:absolute;
      top: 4px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(0,0,0,.18));
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      letter-spacing: .9px;
      user-select:none;
      font-size: 12px;
    }

    .square{
      width: 178px;
      height: 178px;
      border-radius: 22px;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.22), transparent 55%),
        linear-gradient(180deg, rgba(185,255,217,1), rgba(47,228,138,1));
      border: 1px solid rgba(0,0,0,.10);
      box-shadow: 0 18px 44px rgba(0,0,0,.36);
      position:relative;
      overflow:hidden;
    }

    .face{
      width: 138px;
      height: 92px;
      border-radius: 22px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(10px);
      box-shadow: 0 16px 26px rgba(0,0,0,.20);
      position:absolute;
      bottom: 34px;
      left: 50%;
      transform: translateX(-50%);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:24px;
      padding-top:12px;
    }

    .eye{
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: #0b1020;
      box-shadow: 0 0 0 7px rgba(255,255,255,.10);
      position:relative;
      overflow:hidden;
    }
    .eye:after{
      content:"";
      position:absolute;
      width: 6px;height:6px;border-radius:999px;
      background: rgba(255,255,255,.90);
      top: 2px; left: 2px;
    }

    .mouth{
      position:absolute;
      left: 50%;
      bottom: 14px;
      transform: translateX(-50%);
      width: 36px;
      height: 16px;
      border: 3px solid rgba(11,16,32,.92);
      border-top: none;
      border-radius: 0 0 28px 28px;
      background: transparent;
    }

    .brow{
      position:absolute;
      top: 10px;
      width: 24px;
      height: 6px;
      border-radius: 999px;
      background: rgba(11,16,32,.92);
      opacity:0;
    }
    .brow.left{ left: 20px; transform: rotate(-10deg); }
    .brow.right{ right: 20px; transform: rotate(10deg); }

    /* FACE STATES */
    .mood-happy .mouth{ width: 44px; height: 20px; border-radius: 0 0 30px 30px; }
    .mood-sad .mouth{
      bottom: 18px; width: 44px; height: 16px;
      border-top: 3px solid rgba(11,16,32,.92);
      border-bottom:none; border-radius: 30px 30px 0 0;
    }
    .mood-angry .mouth{
      width: 36px; height: 14px;
      border-top: 3px solid rgba(11,16,32,.92);
      border-bottom:none; border-radius: 22px 22px 0 0;
    }
    .mood-angry .brow{ opacity:1; }
    .mood-angry .brow.left{ transform: rotate(18deg); }
    .mood-angry .brow.right{ transform: rotate(-18deg); }
    .mood-hungry .mouth{
      width: 18px; height: 18px;
      border: 3px solid rgba(11,16,32,.92);
      border-radius: 999px;
    }
    .mood-sick .mouth{
      width: 34px; height: 7px;
      border:none; background: rgba(11,16,32,.92); border-radius: 999px;
    }
    .mood-sick .eye{ height: 11px; }
    .mood-bored .mouth{
      width: 30px; height: 6px;
      border:none; background: rgba(11,16,32,.92); border-radius: 999px;
      opacity:.85;
    }
    .mood-asleep .mouth{
      width: 28px; height: 6px;
      border:none; background: rgba(11,16,32,.92); border-radius: 999px;
      opacity:.65;
    }
    .mood-asleep .eye{ transform: scaleY(.25); }

    /* NO CONSTANT MOTION: ONLY BLINK SOMETIMES */
    @keyframes blink {
      0%, 90%, 100% { transform: scaleY(1); }
      92%, 96% { transform: scaleY(0.15); }
    }
    .blink .eye{ animation: blink 220ms linear 1; transform-origin:center; }

    /* SHORT ACTION BURSTS */
    @keyframes pop { 0%{ transform: scale(1); } 50%{ transform: scale(1.05); } 100%{ transform: scale(1); } }
    @keyframes nod { 0%{ transform: translateY(0); } 40%{ transform: translateY(-8px); } 100%{ transform: translateY(0); } }
    @keyframes wig { 0%{ transform: rotate(0deg); } 25%{ transform: rotate(-8deg); } 50%{ transform: rotate(10deg); } 75%{ transform: rotate(-6deg); } 100%{ transform: rotate(0deg); } }
    .burst-pop .square{ animation: pop 380ms ease-out 1; }
    .burst-nod .poppyWrap{ animation: nod 420ms ease-out 1; }
    .burst-wig .poppyWrap{ animation: wig 520ms ease-in-out 1; }

    .sleepTint{
      position:absolute;
      inset:0;
      background: radial-gradient(circle at 50% 30%, rgba(138,164,255,.14), rgba(0,0,0,.62));
      opacity:0;
      transition: opacity .25s ease;
      pointer-events:none;
      z-index:3;
    }
    .sleepOn .sleepTint{ opacity:1; }

    /* OVERLAY */
    .overlay{
      position:absolute;
      inset: 0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10;
      background: radial-gradient(circle at 50% 40%, rgba(0,0,0,.20), rgba(0,0,0,.55));
      backdrop-filter: blur(3px);
    }
    .overlay.show{ display:flex; }
    .overlayCard{
      width:min(560px, 94%);
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,14,28,.84);
      box-shadow: 0 22px 60px rgba(0,0,0,.55);
      padding: 14px;
    }
    .overlayTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .overlayTop b{ color: var(--text); }
    .overlayBody{
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 12px;
      min-height: 190px;
      display:grid;
      place-items:center;
      position:relative;
      overflow:hidden;
    }
    .overlayActions{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){ .overlayActions{ grid-template-columns:1fr; } }

    /* APPLE MINI GAME */
    .gameArea{
      width: min(500px, 96%);
      height: 250px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      position:relative;
      overflow:hidden;
    }
    .apple{
      width: 40px;
      height: 40px;
      border-radius: 999px;
      position:absolute;
      left: 20px;
      top: 20px;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 18px 30px rgba(0,0,0,.30);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.85), rgba(255,255,255,0) 45%),
        radial-gradient(circle at 50% 60%, rgba(255,120,120,.95), rgba(190,30,50,.95));
    }
    .apple:before{
      content:"";
      position:absolute;
      width: 8px; height: 13px;
      left: 50%;
      top: -7px;
      transform: translateX(-50%) rotate(10deg);
      border-radius: 6px;
      background: linear-gradient(180deg, rgba(120,80,40,1), rgba(80,50,25,1));
      box-shadow: 0 4px 10px rgba(0,0,0,.25);
    }
    .apple:after{
      content:"";
      position:absolute;
      width: 16px; height: 11px;
      left: 56%;
      top: -2px;
      transform: rotate(20deg);
      border-radius: 14px 14px 14px 2px;
      background: linear-gradient(180deg, rgba(170,255,200,1), rgba(55,220,140,1));
      box-shadow: 0 6px 12px rgba(0,0,0,.18);
    }
    .gameHud{
      display:flex;
      justify-content:space-between;
      width: min(500px, 96%);
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
    }
    .gameHud b{ color: var(--text); }

    /* SIMPLE DODGE GAME */
    .dodgeArea{
      width: min(500px, 96%);
      height: 250px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      position:relative;
      overflow:hidden;
    }
    .runner{
      width: 36px;
      height: 36px;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(185,255,217,1), rgba(47,228,138,1));
      border: 1px solid rgba(255,255,255,.12);
      position:absolute;
      bottom: 12px;
      left: 14px;
      box-shadow: 0 18px 30px rgba(0,0,0,.25);
    }
    .rock{
      width: 30px;
      height: 30px;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.14);
      position:absolute;
      bottom: 12px;
      left: 460px;
      box-shadow: 0 18px 30px rgba(0,0,0,.25);
    }

    /* VISUALS FOR ACTIONS */
    .bubble{
      position:absolute;
      width: 14px; height: 14px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.08);
      opacity:0;
    }
    @keyframes bubbleRise{
      0%{ transform: translate(0, 20px) scale(.6); opacity:0; }
      10%{ opacity:1; }
      80%{ opacity:1; }
      100%{ transform: translate(var(--dx), -190px) scale(1.15); opacity:0; }
    }
    .pulseRing{
      width: 120px; height: 120px;
      border-radius: 999px;
      border: 2px solid rgba(124,247,178,.55);
      box-shadow: 0 0 0 10px rgba(124,247,178,.12);
      opacity:0;
      position:absolute;
    }
    @keyframes pulse{
      0%{ transform: scale(.7); opacity:0; }
      18%{ opacity:1; }
      100%{ transform: scale(1.7); opacity:0; }
    }

    .toast{
      position:fixed;
      left: 16px;
      right: 16px;
      top: 14px;
      margin:0 auto;
      width: min(900px, calc(100% - 32px));
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
      z-index:9999;
      display:none;
      white-space: pre-line;
    }
    .errorBanner{
      position:fixed;
      left:16px;
      right:16px;
      bottom:16px;
      padding:12px 14px;
      border-radius:14px;
      background: rgba(255,138,161,.18);
      border: 1px solid rgba(255,138,161,.40);
      color: var(--text);
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
      z-index:9999;
      display:none;
      white-space: pre-line;
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 680px){ .controls{ grid-template-columns:1fr; } }

    .panel{
      padding: 14px 14px 16px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
    }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    @media (max-width: 680px){ .grid2,.grid3{ grid-template-columns:1fr; } }

    button{
      width:100%;
      font: inherit;
      font-weight: 950;
      color: var(--text);
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 10px 12px;
      outline:none;
      cursor:pointer;
      letter-spacing:.3px;
      transition: transform .08s ease, filter .2s ease, border-color .2s ease;
    }
    button:hover{ filter: brightness(1.06); border-color: rgba(124,247,178,.42); }
    button:active{ transform: translateY(1px) scale(.99); }
    button:disabled{
      opacity:.55;
      cursor:not-allowed;
      filter: grayscale(.2);
    }

    .btnMain{
      background: linear-gradient(180deg, rgba(124,247,178,.24), rgba(124,247,178,.08));
      border-color: rgba(124,247,178,.22);
    }
    .btnAlt{
      background: linear-gradient(180deg, rgba(138,164,255,.20), rgba(138,164,255,.06));
      border-color: rgba(138,164,255,.22);
    }
    .btnWarn{
      background: linear-gradient(180deg, rgba(255,209,138,.22), rgba(255,209,138,.07));
      border-color: rgba(255,209,138,.22);
    }
    .btnDanger{
      background: linear-gradient(180deg, rgba(255,138,161,.22), rgba(255,138,161,.07));
      border-color: rgba(255,138,161,.22);
    }

    .bars{ display:grid; gap:10px; }
    .barRow{
      display:grid;
      grid-template-columns: 116px 1fr 54px;
      gap:10px;
      align-items:center;
      font-size: 12px;
      color: var(--muted);
    }
    @media (max-width: 420px){
      .barRow{ grid-template-columns: 1fr; }
    }

    .meter{
      height: 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    .fill{
      height:100%;
      width: 50%;
      background: linear-gradient(90deg, rgba(124,247,178,.85), rgba(138,164,255,.85));
    }

    .log{
      height: 310px;
      overflow:auto;
      padding: 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.10);
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
    }
    .log b{ color: var(--text); }
    .log .item{ margin-bottom:10px; }

    .smallRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      color: var(--muted);
      font-size: 12px;
      margin-top: 10px;
    }
    .smallRow b{ color: var(--text); }
    .chip{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      white-space:nowrap;
    }

    .list{
      display:grid;
      gap:10px;
      margin-top: 10px;
    }
    .listItem{
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
    .listItem b{ color: var(--text); }

    @media (prefers-reduced-motion: reduce){
      .burst-pop .square,
      .burst-nod .poppyWrap,
      .burst-wig .poppyWrap{ animation:none !important; }
      .overlay, .overlayCard{ backdrop-filter:none; }
    }
  </style>
</head>

<body>
  <div class="toast" id="toast"></div>
  <div class="errorBanner" id="errorBanner"></div>

  <main class="wrap">
    <section class="card" id="app">
      <header>
        <div class="title">
          <h1>POPPY</h1>
          <p class="sub">FULLY FLEDGED: STATS, INVENTORY, SHOP, AUTO CARE, RANDOM EVENTS, SAVE</p>
        </div>
        <div class="badge">
          <span class="dot" id="statusDot"></span>
          <span id="statusText">ALIVE</span>
        </div>
      </header>

      <div class="stage">
        <div class="screen" id="screen">
          <div class="sleepTint" id="sleepTint"></div>

          <div class="hud">
            <div class="statusBox" id="statusBox">POPPY IS IDLE. CLICK A BUTTON.</div>
            <div class="pill">
              MOOD <b id="moodPill">HAPPY</b>
              LVL <b id="lvlPill">1</b>
              AGE <b id="agePill">0</b>
              COINS <b id="coinsPill">5</b>
            </div>
          </div>

          <div class="floorGlow"></div>

          <div class="poppyWrap" id="poppyWrap" aria-label="Poppy">
            <div class="nameTag">POPPY</div>
            <div class="square" id="square">
              <div class="face" id="face">
                <div class="brow left"></div>
                <div class="brow right"></div>
                <div class="eye"></div>
                <div class="eye"></div>
                <div class="mouth"></div>
              </div>
            </div>
          </div>

          <div class="overlay" id="overlay">
            <div class="overlayCard">
              <div class="overlayTop">
                <div>MODE <b id="overlayTitle">ACTION</b></div>
                <div>TIME <b id="overlayTimer">0</b></div>
              </div>
              <div class="overlayBody" id="overlayBody"></div>
              <div class="overlayActions" id="overlayActions">
                <button class="btnMain" id="overlayPrimary" type="button">OK</button>
                <button class="btnAlt" id="overlayClose" type="button">CLOSE</button>
              </div>
            </div>
          </div>
        </div>

        <div class="controls">
          <div class="panel">
            <div class="bars">
              <div class="barRow"><span>HUNGER</span><div class="meter"><div class="fill" id="hungerFill"></div></div><span id="hungerVal">50</span></div>
              <div class="barRow"><span>HAPPINESS</span><div class="meter"><div class="fill" id="happyFill"></div></div><span id="happyVal">70</span></div>
              <div class="barRow"><span>ENERGY</span><div class="meter"><div class="fill" id="energyFill"></div></div><span id="energyVal">70</span></div>
              <div class="barRow"><span>CLEANLINESS</span><div class="meter"><div class="fill" id="cleanFill"></div></div><span id="cleanVal">60</span></div>
              <div class="barRow"><span>HEALTH</span><div class="meter"><div class="fill" id="healthFill"></div></div><span id="healthVal">90</span></div>
              <div class="barRow"><span>DISCIPLINE</span><div class="meter"><div class="fill" id="discFill"></div></div><span id="discVal">50</span></div>
              <div class="barRow"><span>XP</span><div class="meter"><div class="fill" id="xpFill"></div></div><span id="xpVal">0</span></div>
            </div>

            <div class="smallRow">
              <span class="chip">MODE <b id="modeChip">NORMAL</b></span>
              <span class="chip">AUTO CARE <b id="autoChip">OFF</b></span>
              <span class="chip">SAVES <b id="saveChip">ON</b></span>
            </div>
          </div>

          <div class="panel">
            <div class="grid3">
              <button class="btnMain" id="btnFeed" type="button">FEED</button>
              <button class="btnMain" id="btnPlay" type="button">PLAY</button>
              <button class="btnMain" id="btnSleep" type="button">SLEEP</button>
              <button class="btnMain" id="btnClean" type="button">CLEAN</button>
              <button class="btnWarn" id="btnMed" type="button">MEDICINE</button>
              <button class="btnAlt" id="btnWork" type="button">WORK</button>
              <button class="btnAlt" id="btnInventory" type="button">INVENTORY</button>
              <button class="btnAlt" id="btnShop" type="button">SHOP</button>
              <button class="btnAlt" id="btnTrain" type="button">TRAIN</button>
              <button class="btnAlt" id="btnSettings" type="button">SETTINGS</button>
              <button class="btnAlt" id="btnPause" type="button">PAUSE</button>
              <button class="btnDanger" id="btnReset" type="button">RESET</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <aside class="card" style="padding:16px 16px 18px;">
      <h2 style="margin:0 0 10px; font-size:16px;">EVENT LOG</h2>
      <div class="log" id="log"></div>

      <div class="panel" style="margin-top:12px;">
        <h2 style="margin:0 0 10px; font-size:16px;">QUICK HELP</h2>

        <div class="list">
          <div class="listItem"><b>FEED</b> USES FOOD ITEMS. IF NONE, YOU CAN BUY IN SHOP.</div>
          <div class="listItem"><b>PLAY</b> CHOOSE APPLE CLICK GAME OR DODGE GAME.</div>
          <div class="listItem"><b>TRAIN</b> INCREASES DISCIPLINE BUT COSTS ENERGY.</div>
          <div class="listItem"><b>AUTO CARE</b> CAN USE ITEMS AUTOMATICALLY IF YOU OWN THEM.</div>
          <div class="listItem"><b>SAVING</b> AUTO SAVES TO LOCAL STORAGE. SETTINGS CAN TURN IT OFF.</div>
        </div>
      </div>
    </aside>
  </main>

  <script>
    (function(){
      const $ = (id)=>document.getElementById(id);

      const toast = $("toast");
      const banner = $("errorBanner");
      function showError(msg){
        banner.style.display = "block";
        banner.textContent = "ERROR\n" + msg;
      }
      function tmsg(msg){
        toast.style.display = "block";
        toast.textContent = msg;
        clearTimeout(tmsg._t);
        tmsg._t = setTimeout(()=>{ toast.style.display = "none"; }, 1700);
      }
      function need(id){
        const el = $(id);
        if (!el) throw new Error("MISSING ELEMENT ID: " + id);
        return el;
      }

      // SAFE RANDOM
      function rint(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
      function chance(p){ return Math.random() < p; }
      function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

      // SAVE KEY
      const SAVE_KEY = "POPPY_TAMAGOTCHI_SAVE_V1";

      try{
        // Elements
        const app = need("app");
        const screen = need("screen");
        const face = need("face");

        const statusBox = need("statusBox");
        const moodPill = need("moodPill");
        const lvlPill = need("lvlPill");
        const agePill = need("agePill");
        const coinsPill = need("coinsPill");

        const statusDot = need("statusDot");
        const statusText = need("statusText");

        const modeChip = need("modeChip");
        const autoChip = need("autoChip");
        const saveChip = need("saveChip");

        const logEl = need("log");

        const fills = {
          hunger: need("hungerFill"),
          happy: need("happyFill"),
          energy: need("energyFill"),
          clean: need("cleanFill"),
          health: need("healthFill"),
          disc: need("discFill"),
          xp: need("xpFill")
        };
        const vals = {
          hunger: need("hungerVal"),
          happy: need("happyVal"),
          energy: need("energyVal"),
          clean: need("cleanVal"),
          health: need("healthVal"),
          disc: need("discVal"),
          xp: need("xpVal")
        };

        // Overlay
        const overlay = need("overlay");
        const overlayTitle = need("overlayTitle");
        const overlayTimer = need("overlayTimer");
        const overlayBody = need("overlayBody");
        const overlayPrimary = need("overlayPrimary");
        const overlayClose = need("overlayClose");

        // Buttons
        const btnFeed = need("btnFeed");
        const btnPlay = need("btnPlay");
        const btnSleep = need("btnSleep");
        const btnClean = need("btnClean");
        const btnMed = need("btnMed");
        const btnWork = need("btnWork");
        const btnInventory = need("btnInventory");
        const btnShop = need("btnShop");
        const btnTrain = need("btnTrain");
        const btnSettings = need("btnSettings");
        const btnPause = need("btnPause");
        const btnReset = need("btnReset");

        // GAME STATE
        const defaultState = ()=>({
          alive: true,
          paused: false,
          mode: "NORMAL",          // NORMAL | SLEEPING | SICK
          autoCare: false,
          autoSave: true,

          age: 0,
          coins: 5,

          lvl: 1,
          xp: 0,

          hunger: 55,
          happy: 70,
          energy: 70,
          clean: 60,
          health: 90,
          disc: 50,

          // inventory counts
          inv: {
            FOOD: 2,
            SNACK: 2,
            WATER: 2,
            SOAP: 1,
            MED: 1,
            TOY: 1,
            BLANKET: 0
          },

          // flags/upgrades
          upgrades: {
            AUTO_FEED: false,
            AUTO_CLEAN: false,
            AUTO_MED: false,
            COMFY_BED: false,
            BIG_WALLET: false,
            XP_BOOST: false,
            SLOW_DECAY: false
          },

          // achievements
          ach: {
            FIRST_FEED: false,
            FIRST_GAME: false,
            FIRST_SHOP: false,
            LVL_3: false,
            LVL_5: false,
            RICH_50: false,
            CLEAN_FREAK: false,
            FULL_HEALTH: false
          },

          // last tick timestamp (for offline progress)
          last: Date.now()
        });

        let S = defaultState();

        // LOAD
        function load(){
          try{
            const raw = localStorage.getItem(SAVE_KEY);
            if (!raw) return false;
            const data = JSON.parse(raw);
            if (!data || typeof data !== "object") return false;
            // shallow merge with defaults to keep new fields
            const base = defaultState();
            S = mergeDeep(base, data);
            return true;
          } catch(e){
            return false;
          }
        }

        function mergeDeep(target, source){
          const out = Array.isArray(target) ? target.slice() : { ...target };
          for (const k in source){
            if (!Object.prototype.hasOwnProperty.call(source, k)) continue;
            const sv = source[k];
            const tv = out[k];
            if (sv && typeof sv === "object" && !Array.isArray(sv) && tv && typeof tv === "object" && !Array.isArray(tv)){
              out[k] = mergeDeep(tv, sv);
            } else {
              out[k] = sv;
            }
          }
          return out;
        }

        function save(force){
          if (!S.autoSave && !force) return;
          try{
            S.last = Date.now();
            localStorage.setItem(SAVE_KEY, JSON.stringify(S));
          } catch(e){
            // ignore
          }
        }

        // LOG
        function log(msg){
          const t = new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = "<b>" + t + "</b> | " + msg;
          logEl.prepend(div);
        }

        // MOTION BURSTS
        function burst(cls, ms){
          app.classList.add(cls);
          setTimeout(()=>app.classList.remove(cls), ms);
        }
        function blink(){
          face.classList.add("blink");
          setTimeout(()=>face.classList.remove("blink"), 250);
        }

        // MOOD + FACE
        function mood(){
          if (!S.alive) return "DEAD";
          if (S.mode === "SLEEPING") return "ASLEEP";
          if (S.health <= 20 || S.mode === "SICK") return "SICK";
          if (S.hunger <= 25) return "HUNGRY";
          if (S.clean <= 20) return "ANGRY";
          if (S.happy <= 25) return "SAD";
          if (S.energy <= 20) return "BORED";
          return "HAPPY";
        }
        function setFaceMoodClass(m){
          face.classList.remove(
            "mood-happy","mood-sad","mood-angry","mood-hungry","mood-sick","mood-bored","mood-asleep"
          );
          if (m === "ASLEEP") face.classList.add("mood-asleep");
          else if (m !== "DEAD") face.classList.add("mood-" + m.toLowerCase());
        }

        // XP / LEVEL
        function xpToNext(lvl){
          return 30 + (lvl-1)*18;
        }
        function addXP(amount, reason){
          if (!S.alive) return;
          let a = amount;
          if (S.upgrades.XP_BOOST) a = Math.round(a * 1.2);
          S.xp += a;
          if (reason) log("XP +" + a + " " + reason);
          while (S.xp >= xpToNext(S.lvl)){
            S.xp -= xpToNext(S.lvl);
            S.lvl += 1;
            S.coins += 2;
            log("LEVEL UP TO " + S.lvl + " COINS +2");
            burst("burst-wig", 520);
          }
          // achievements
          if (S.lvl >= 3 && !S.ach.LVL_3){ S.ach.LVL_3 = true; log("ACHIEVEMENT LEVEL 3"); }
          if (S.lvl >= 5 && !S.ach.LVL_5){ S.ach.LVL_5 = true; log("ACHIEVEMENT LEVEL 5"); }
          updateUI();
          save();
        }

        // INVENTORY HELPERS
        function have(item, n=1){ return (S.inv[item] || 0) >= n; }
        function addItem(item, n=1){
          S.inv[item] = (S.inv[item] || 0) + n;
        }
        function takeItem(item, n=1){
          if (!have(item,n)) return false;
          S.inv[item] -= n;
          return true;
        }

        // ACHIEVEMENTS CHECK
        function checkAchievements(){
          if (S.coins >= 50 && !S.ach.RICH_50){ S.ach.RICH_50 = true; log("ACHIEVEMENT 50 COINS"); }
          if (S.clean >= 95 && !S.ach.CLEAN_FREAK){ S.ach.CLEAN_FREAK = true; log("ACHIEVEMENT CLEAN FREAK"); }
          if (S.health >= 100 && !S.ach.FULL_HEALTH){ S.ach.FULL_HEALTH = true; log("ACHIEVEMENT FULL HEALTH"); }
        }

        // UI UPDATE
        function updateUI(){
          // clamp
          S.hunger = clamp(S.hunger, 0, 100);
          S.happy  = clamp(S.happy, 0, 100);
          S.energy = clamp(S.energy, 0, 100);
          S.clean  = clamp(S.clean, 0, 100);
          S.health = clamp(S.health, 0, 100);
          S.disc   = clamp(S.disc, 0, 100);
          S.xp     = clamp(S.xp, 0, 9999);

          // fills
          fills.hunger.style.width = S.hunger + "%";
          fills.happy.style.width  = S.happy + "%";
          fills.energy.style.width = S.energy + "%";
          fills.clean.style.width  = S.clean + "%";
          fills.health.style.width = S.health + "%";
          fills.disc.style.width   = S.disc + "%";
          const xpPct = Math.floor((S.xp / xpToNext(S.lvl)) * 100);
          fills.xp.style.width = clamp(xpPct,0,100) + "%";

          vals.hunger.textContent = String(Math.round(S.hunger));
          vals.happy.textContent  = String(Math.round(S.happy));
          vals.energy.textContent = String(Math.round(S.energy));
          vals.clean.textContent  = String(Math.round(S.clean));
          vals.health.textContent = String(Math.round(S.health));
          vals.disc.textContent   = String(Math.round(S.disc));
          vals.xp.textContent     = String(Math.round(S.xp));

          // pills
          const m = mood();
          moodPill.textContent = m;
          lvlPill.textContent  = String(S.lvl);
          agePill.textContent  = String(S.age);
          coinsPill.textContent= String(S.coins);

          // mode chips
          modeChip.textContent = S.mode;
          autoChip.textContent = S.autoCare ? "ON" : "OFF";
          saveChip.textContent = S.autoSave ? "ON" : "OFF";

          setFaceMoodClass(m);

          // status dot
          if (!S.alive){
            statusDot.style.background = "var(--danger)";
            statusText.textContent = "DEAD";
          } else if (S.paused){
            statusDot.style.background = "var(--accent2)";
            statusText.textContent = "PAUSED";
          } else {
            statusText.textContent = "ALIVE";
            if (m === "SICK" || m === "ANGRY") statusDot.style.background = "var(--danger)";
            else if (m === "HUNGRY" || m === "SAD") statusDot.style.background = "var(--warn)";
            else statusDot.style.background = "var(--accent)";
          }

          // sleeping tint
          if (S.mode === "SLEEPING") screen.classList.add("sleepOn");
          else screen.classList.remove("sleepOn");

          // status text block
          statusBox.textContent =
            "POPPY STATUS\n" +
            "MOOD " + m + "\n" +
            "MODE " + S.mode + "\n" +
            "COINS " + S.coins + "\n" +
            "AUTO CARE " + (S.autoCare ? "ON" : "OFF") + "\n" +
            "FOOD " + (S.inv.FOOD||0) + " SNACK " + (S.inv.SNACK||0) + " WATER " + (S.inv.WATER||0) + "\n" +
            "SOAP " + (S.inv.SOAP||0) + " MED " + (S.inv.MED||0) + " TOY " + (S.inv.TOY||0);

          // disable buttons when dead
          const disabled = !S.alive;
          for (const b of [btnFeed,btnPlay,btnSleep,btnClean,btnMed,btnWork,btnInventory,btnShop,btnTrain,btnSettings]){
            b.disabled = disabled;
          }
          btnPause.disabled = false;
          btnReset.disabled = false;

          checkAchievements();
        }

        // OVERLAY
        let overlayInterval = null;
        let overlayEndAt = 0;
        let overlayMode = "NONE";
        let game = null;

        function closeOverlay(){
          overlay.classList.remove("show");
          overlayBody.innerHTML = "";
          overlayTitle.textContent = "ACTION";
          overlayTimer.textContent = "0";
          overlayMode = "NONE";
          if (overlayInterval){ clearInterval(overlayInterval); overlayInterval = null; }
          stopGame();
          updateUI();
          save();
        }

        function openOverlay(mode, seconds){
          overlayMode = mode;
          overlayTitle.textContent = mode;
          overlay.classList.add("show");
          overlayEndAt = Date.now() + seconds*1000;

          function tickTimer(){
            const left = Math.max(0, Math.ceil((overlayEndAt - Date.now())/1000));
            overlayTimer.textContent = String(left);
            if (left <= 0){
              if (overlayMode.startsWith("PLAY")) finishGame(true);
              else closeOverlay();
            }
          }
          tickTimer();
          if (overlayInterval) clearInterval(overlayInterval);
          overlayInterval = setInterval(tickTimer, 200);
        }

        overlayClose.addEventListener("click", ()=>{
          if (overlayMode.startsWith("PLAY")) finishGame(false);
          closeOverlay();
        });
        overlayPrimary.addEventListener("click", ()=>{
          if (overlayMode.startsWith("PLAY")) finishGame(true);
          else closeOverlay();
        });

        // VISUAL ACTIONS
        function animClean(){
          openOverlay("CLEAN", 2);
          overlayPrimary.textContent = "DONE";
          overlayClose.textContent = "CLOSE";
          overlayBody.innerHTML = "";

          for (let i=0;i<14;i++){
            const b = document.createElement("div");
            b.className = "bubble";
            b.style.left = (10 + Math.random()*80) + "%";
            b.style.top = (150 + Math.random()*40) + "px";
            b.style.setProperty("--dx", (Math.random()*140 - 70) + "px");
            b.style.animation = "bubbleRise 980ms ease-out " + (i*60) + "ms 1";
            overlayBody.appendChild(b);
          }
          burst("burst-wig", 520);
        }

        function animMed(){
          openOverlay("MEDICINE", 2);
          overlayPrimary.textContent = "DONE";
          overlayClose.textContent = "CLOSE";
          overlayBody.innerHTML = "";
          for (let i=0;i<4;i++){
            const ring = document.createElement("div");
            ring.className = "pulseRing";
            ring.style.animation = "pulse 820ms ease-out " + (i*160) + "ms 1";
            overlayBody.appendChild(ring);
          }
          burst("burst-pop", 380);
        }

        function animFeed(msg){
          openOverlay("FEED", 2);
          overlayPrimary.textContent = "DONE";
          overlayClose.textContent = "CLOSE";
          overlayBody.innerHTML =
            "<div style='color:var(--muted); font-size:12px; line-height:1.35; text-align:center;'>" +
            msg +
            "</div>";
          burst("burst-pop", 380);
          burst("burst-nod", 420);
        }

        function animSleep(){
          openOverlay("SLEEP", 3);
          overlayPrimary.textContent = "WAKE";
          overlayClose.textContent = "CLOSE";
          overlayBody.innerHTML =
            "<div style='color:var(--muted); font-size:12px; line-height:1.35; text-align:center;'>" +
            "POPPY IS RESTING\nENERGY RECOVERS FASTER" +
            "</div>";
          burst("burst-nod", 420);
        }

        // MINI GAMES
        function stopGame(){
          if (!game) return;
          if (game.timers){
            for (const t of game.timers) clearInterval(t);
          }
          game = null;
        }

        function startAppleGame(){
          openOverlay("PLAY APPLES", 14);
          overlayPrimary.textContent = "FINISH";
          overlayClose.textContent = "QUIT";
          overlayBody.innerHTML = "";

          const area = document.createElement("div");
          area.className = "gameArea";
          const apple = document.createElement("div");
          apple.className = "apple";
          area.appendChild(apple);

          const hud = document.createElement("div");
          hud.className = "gameHud";
          hud.innerHTML = "<div>SCORE <b id='gScore'>0</b></div><div>REWARD <b id='gReward'>0</b></div>";

          overlayBody.appendChild(area);
          overlayBody.appendChild(hud);

          const gScore = overlayBody.querySelector("#gScore");
          const gReward = overlayBody.querySelector("#gReward");

          game = { type:"APPLE", score:0, timers:[], apple, area, gScore, gReward };

          function move(){
            const w = area.clientWidth;
            const h = area.clientHeight;
            const size = 40;
            const pad = 10;
            const x = Math.max(pad, Math.min(w - size - pad, rint(0, w - size)));
            const y = Math.max(pad, Math.min(h - size - pad, rint(0, h - size)));
            apple.style.left = x + "px";
            apple.style.top = y + "px";
          }

          apple.addEventListener("click", ()=>{
            if (!game) return;
            game.score += 1;
            gScore.textContent = String(game.score);
            const reward = Math.min(14, Math.floor(game.score/2));
            gReward.textContent = String(reward);
            move();
            burst("burst-pop", 240);
          });

          move();

          // SLOW AND EASY
          const MOVE_MS = 1400; // SLOWER THAN BEFORE
          game.timers.push(setInterval(move, MOVE_MS));
        }

        function startDodgeGame(){
          openOverlay("PLAY DODGE", 16);
          overlayPrimary.textContent = "FINISH";
          overlayClose.textContent = "QUIT";
          overlayBody.innerHTML = "";

          const area = document.createElement("div");
          area.className = "dodgeArea";
          const runner = document.createElement("div");
          runner.className = "runner";
          const rock = document.createElement("div");
          rock.className = "rock";
          area.appendChild(runner);
          area.appendChild(rock);

          const hud = document.createElement("div");
          hud.className = "gameHud";
          hud.innerHTML = "<div>SURVIVE <b id='gTime'>0</b></div><div>REWARD <b id='gReward'>0</b></div>";
          overlayBody.appendChild(area);
          overlayBody.appendChild(hud);

          const gTime = overlayBody.querySelector("#gTime");
          const gReward = overlayBody.querySelector("#gReward");

          game = { type:"DODGE", score:0, timers:[], area, runner, rock, gTime, gReward, alive:true };

          let runnerX = 14;
          let rockX = area.clientWidth + 20;
          let speed = 5; // easy
          let ticks = 0;

          function resetRock(){
            rockX = area.clientWidth + rint(0, 90);
            speed = clamp(5 + Math.floor(S.lvl/2), 5, 9);
          }

          function draw(){
            runner.style.left = runnerX + "px";
            rock.style.left = rockX + "px";
          }

          function step(){
            if (!game || !game.alive) return;
            ticks += 1;
            rockX -= speed;

            if (rockX < -40){
              resetRock();
              game.score += 1;
            }

            // collision
            const rRect = runner.getBoundingClientRect();
            const oRect = rock.getBoundingClientRect();
            const hit = !(rRect.right < oRect.left || rRect.left > oRect.right || rRect.bottom < oRect.top || rRect.top > oRect.bottom);
            if (hit){
              game.alive = false;
              overlayTimer.textContent = "0";
              finishGame(true);
              return;
            }

            gTime.textContent = String(game.score);
            const reward = Math.min(16, game.score);
            gReward.textContent = String(reward);

            draw();
          }

          function moveLeft(){ runnerX = clamp(runnerX - 22, 10, area.clientWidth - 46); draw(); }
          function moveRight(){ runnerX = clamp(runnerX + 22, 10, area.clientWidth - 46); draw(); }

          // controls inside overlay
          const controlRow = document.createElement("div");
          controlRow.style.marginTop = "10px";
          controlRow.innerHTML =
            "<div style='display:grid; grid-template-columns:1fr 1fr; gap:10px; width:min(500px,96%);'>" +
            "<button class='btnAlt' id='dgLeft' type='button'>LEFT</button>" +
            "<button class='btnAlt' id='dgRight' type='button'>RIGHT</button>" +
            "</div>";
          overlayBody.appendChild(controlRow);

          overlayBody.querySelector("#dgLeft").addEventListener("click", ()=>{ moveLeft(); });
          overlayBody.querySelector("#dgRight").addEventListener("click", ()=>{ moveRight(); });

          function keyHandler(e){
            if (!overlay.classList.contains("show")) return;
            if (!game || game.type !== "DODGE") return;
            const k = e.key.toLowerCase();
            if (k === "a" || k === "arrowleft") moveLeft();
            if (k === "d" || k === "arrowright") moveRight();
          }
          window.addEventListener("keydown", keyHandler, { passive:true });

          // cleanup hook
          game.cleanup = ()=>window.removeEventListener("keydown", keyHandler);

          resetRock();
          draw();
          game.timers.push(setInterval(step, 110)); // easy speed
        }

        function finishGame(applyRewards){
          if (!game) return;

          let score = game.score;
          let coinsGain = 0;
          let xpGain = 0;
          let happyGain = 0;

          if (applyRewards){
            if (game.type === "APPLE"){
              coinsGain = clamp(Math.floor(score/2), 0, 14);
              xpGain = clamp(8 + score*2, 8, 36);
              happyGain = clamp(10 + score*2, 10, 30);
            } else if (game.type === "DODGE"){
              coinsGain = clamp(score, 0, 16);
              xpGain = clamp(10 + score*3, 10, 40);
              happyGain = clamp(8 + score*2, 8, 26);
            }
            S.coins += coinsGain;
            S.happy += happyGain;
            S.energy -= 6;
            S.clean -= 1;

            log("GAME " + game.type + " SCORE " + score + " COINS +" + coinsGain + " HAPPINESS +" + happyGain);
            if (!S.ach.FIRST_GAME){ S.ach.FIRST_GAME = true; log("ACHIEVEMENT FIRST GAME"); }
            addXP(xpGain, "FROM GAME");
            burst("burst-wig", 520);
          } else {
            log("GAME QUIT");
          }

          if (game.cleanup) game.cleanup();
          stopGame();
          closeOverlay();
        }

        // MENUS (INVENTORY / SHOP / SETTINGS / FEED PICKER / PLAY PICKER)
        function menuTitle(text){
          return "<div style='color:var(--muted); font-size:12px; line-height:1.35; text-align:left; width:100%;'>" +
                 "<b style='color:var(--text);'>" + text + "</b>" +
                 "</div>";
        }

        function openInfo(title, html, seconds){
          openOverlay(title, seconds || 9999);
          overlayTimer.textContent = "INF";
          overlayPrimary.textContent = "OK";
          overlayClose.textContent = "CLOSE";
          overlayBody.innerHTML = html;
        }

        function openInventory(){
          const inv = S.inv;
          const html =
            menuTitle("INVENTORY") +
            "<div style='width:100%; display:grid; gap:10px; margin-top:10px;'>" +
            itemRow("FOOD", inv.FOOD||0, "MAIN MEAL. BIG HUNGER UP.") +
            itemRow("SNACK", inv.SNACK||0, "SMALL HUNGER UP. SMALL HAPPINESS UP.") +
            itemRow("WATER", inv.WATER||0, "SMALL HEALTH UP. SMALL ENERGY UP.") +
            itemRow("SOAP", inv.SOAP||0, "USED BY CLEAN.") +
            itemRow("MED", inv.MED||0, "USED BY MEDICINE.") +
            itemRow("TOY", inv.TOY||0, "USED BY PLAY BOOST.") +
            itemRow("BLANKET", inv.BLANKET||0, "USED BY SLEEP BOOST.") +
            "</div>";
          openInfo("INVENTORY", html);
        }

        function itemRow(name, count, desc){
          return "<div style='padding:10px 12px; border-radius:14px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.14); color:var(--muted); font-size:12px; line-height:1.35;'>" +
                 "<div style='display:flex; justify-content:space-between; gap:12px; align-items:center;'>" +
                 "<span><b style='color:var(--text);'>" + name + "</b> X " + count + "</span>" +
                 "</div>" +
                 "<div style='margin-top:6px;'>" + desc + "</div>" +
                 "</div>";
        }

        function openShop(){
          if (!S.ach.FIRST_SHOP){ S.ach.FIRST_SHOP = true; log("ACHIEVEMENT FIRST SHOP"); }
          const html =
            menuTitle("SHOP") +
            "<div style='color:var(--muted); font-size:12px; margin-top:8px;'>COINS " +
            "<b style='color:var(--text);'>" + S.coins + "</b></div>" +

            "<div style='display:grid; gap:10px; margin-top:10px; width:100%;'>" +
              shopRow("BUY FOOD", "COST 2", "FOOD", 2, 1) +
              shopRow("BUY SNACK", "COST 1", "SNACK", 1, 1) +
              shopRow("BUY WATER", "COST 1", "WATER", 1, 1) +
              shopRow("BUY SOAP", "COST 2", "SOAP", 2, 1) +
              shopRow("BUY MED", "COST 3", "MED", 3, 1) +
              shopRow("BUY TOY", "COST 4", "TOY", 4, 1) +
              shopRow("BUY BLANKET", "COST 4", "BLANKET", 4, 1) +
            "</div>" +

            "<div style='margin-top:12px; width:100%;'>" + menuTitle("UPGRADES") + "</div>" +
            "<div style='display:grid; gap:10px; margin-top:10px; width:100%;'>" +
              upgRow("AUTO FEED", "COST 12", "AUTOMATICALLY USES FOOD OR SNACK WHEN HUNGER LOW", "AUTO_FEED", 12) +
              upgRow("AUTO CLEAN", "COST 12", "AUTOMATICALLY USES SOAP WHEN CLEANLINESS LOW", "AUTO_CLEAN", 12) +
              upgRow("AUTO MED", "COST 14", "AUTOMATICALLY USES MED WHEN HEALTH LOW", "AUTO_MED", 14) +
              upgRow("COMFY BED", "COST 10", "SLEEP RECOVERS MORE ENERGY", "COMFY_BED", 10) +
              upgRow("BIG WALLET", "COST 10", "WORK PAYS MORE COINS", "BIG_WALLET", 10) +
              upgRow("XP BOOST", "COST 14", "ALL XP GAINS INCREASED", "XP_BOOST", 14) +
              upgRow("SLOW DECAY", "COST 16", "STATS DECAY SLOWER OVER TIME", "SLOW_DECAY", 16) +
            "</div>";

          openOverlay("SHOP", 9999);
          overlayTimer.textContent = "INF";
          overlayPrimary.textContent = "DONE";
          overlayClose.textContent = "CLOSE";
          overlayBody.innerHTML = html;

          // bind buttons
          bindShopButtons();
          updateUI();
          save();
        }

        function shopRow(label, costLabel, item, cost, qty){
          const id = "shop_" + item;
          return "<div class='listItem' style='display:flex; justify-content:space-between; align-items:center; gap:12px;'>" +
                 "<div><b>" + label + "</b><div style='margin-top:4px;'>" + costLabel + " | +" + qty + " " + item + "</div></div>" +
                 "<div style='min-width:140px;'><button class='btnMain' id='" + id + "' type='button'>BUY</button></div>" +
                 "</div>";
        }

        function upgRow(name, costLabel, desc, key, cost){
          const id = "upg_" + key;
          const owned = S.upgrades[key] ? "OWNED" : "BUY";
          const cls = S.upgrades[key] ? "btnAlt" : "btnWarn";
          return "<div class='listItem' style='display:flex; justify-content:space-between; align-items:center; gap:12px;'>" +
                 "<div><b>" + name + "</b><div style='margin-top:4px;'>" + costLabel + "</div><div style='margin-top:6px;'>" + desc + "</div></div>" +
                 "<div style='min-width:140px;'><button class='" + cls + "' id='" + id + "' type='button'>" + owned + "</button></div>" +
                 "</div>";
        }

        function bindShopButtons(){
          // item buys
          const items = [
            ["FOOD",2,1],["SNACK",1,1],["WATER",1,1],["SOAP",2,1],["MED",3,1],["TOY",4,1],["BLANKET",4,1]
          ];
          for (const [item,cost,qty] of items){
            const el = overlayBody.querySelector("#shop_" + item);
            if (!el) continue;
            el.onclick = ()=>{
              if (!S.alive) return;
              if (S.coins < cost) return tmsg("NOT ENOUGH COINS");
              S.coins -= cost;
              addItem(item, qty);
              log("BOUGHT " + item + " X" + qty);
              addXP(3, "FROM SHOP");
              tmsg("PURCHASED");
              updateUI();
              openShop(); // refresh
            };
          }

          // upgrades
          const upgs = [
            ["AUTO_FEED",12],["AUTO_CLEAN",12],["AUTO_MED",14],["COMFY_BED",10],["BIG_WALLET",10],["XP_BOOST",14],["SLOW_DECAY",16]
          ];
          for (const [key,cost] of upgs){
            const el = overlayBody.querySelector("#upg_" + key);
            if (!el) continue;
            el.onclick = ()=>{
              if (S.upgrades[key]) return tmsg("ALREADY OWNED");
              if (S.coins < cost) return tmsg("NOT ENOUGH COINS");
              S.coins -= cost;
              S.upgrades[key] = true;
              log("UPGRADE PURCHASED " + key);
              addXP(8, "FROM UPGRADE");
              tmsg("UPGRADE ACTIVE");
              updateUI();
              openShop(); // refresh
            };
          }
        }

        function openSettings(){
          const html =
            menuTitle("SETTINGS") +
            "<div style='display:grid; gap:10px; margin-top:10px; width:100%;'>" +
              "<div class='listItem' style='display:flex; justify-content:space-between; align-items:center; gap:12px;'>" +
                "<div><b>AUTO CARE</b><div style='margin-top:6px;'>WHEN ON, POPPY CAN AUTO FEED/CLEAN/MED IF YOU OWN UPGRADES AND ITEMS.</div></div>" +
                "<div style='min-width:160px;'><button class='btnAlt' id='set_auto' type='button'>" + (S.autoCare ? "ON" : "OFF") + "</button></div>" +
              "</div>" +
              "<div class='listItem' style='display:flex; justify-content:space-between; align-items:center; gap:12px;'>" +
                "<div><b>AUTO SAVE</b><div style='margin-top:6px;'>SAVES TO LOCAL STORAGE AUTOMATICALLY.</div></div>" +
                "<div style='min-width:160px;'><button class='btnAlt' id='set_save' type='button'>" + (S.autoSave ? "ON" : "OFF") + "</button></div>" +
              "</div>" +
              "<div class='listItem' style='display:flex; justify-content:space-between; align-items:center; gap:12px;'>" +
                "<div><b>EXPORT SAVE</b><div style='margin-top:6px;'>COPIES YOUR SAVE DATA TO CLIPBOARD.</div></div>" +
                "<div style='min-width:160px;'><button class='btnMain' id='set_export' type='button'>COPY</button></div>" +
              "</div>" +
              "<div class='listItem' style='display:flex; justify-content:space-between; align-items:center; gap:12px;'>" +
                "<div><b>IMPORT SAVE</b><div style='margin-top:6px;'>PASTE JSON IN PROMPT TO IMPORT.</div></div>" +
                "<div style='min-width:160px;'><button class='btnWarn' id='set_import' type='button'>IMPORT</button></div>" +
              "</div>" +
            "</div>";

          openOverlay("SETTINGS", 9999);
          overlayTimer.textContent = "INF";
          overlayPrimary.textContent = "DONE";
          overlayClose.textContent = "CLOSE";
          overlayBody.innerHTML = html;

          const autoBtn = overlayBody.querySelector("#set_auto");
          const saveBtn = overlayBody.querySelector("#set_save");
          const expBtn  = overlayBody.querySelector("#set_export");
          const impBtn  = overlayBody.querySelector("#set_import");

          autoBtn.onclick = ()=>{
            S.autoCare = !S.autoCare;
            log("AUTO CARE " + (S.autoCare ? "ON" : "OFF"));
            tmsg("UPDATED");
            openSettings();
            updateUI();
            save();
          };
          saveBtn.onclick = ()=>{
            S.autoSave = !S.autoSave;
            log("AUTO SAVE " + (S.autoSave ? "ON" : "OFF"));
            tmsg("UPDATED");
            openSettings();
            updateUI();
            save(true);
          };
          expBtn.onclick = async ()=>{
            try{
              save(true);
              const txt = JSON.stringify(S);
              await navigator.clipboard.writeText(txt);
              tmsg("COPIED");
              log("SAVE EXPORTED");
            } catch(e){
              tmsg("COPY FAILED");
            }
          };
          impBtn.onclick = ()=>{
            const pasted = prompt("PASTE SAVE JSON HERE");
            if (!pasted) return;
            try{
              const data = JSON.parse(pasted);
              const base = defaultState();
              S = mergeDeep(base, data);
              log("SAVE IMPORTED");
              tmsg("IMPORTED");
              closeOverlay();
              updateUI();
              save(true);
            } catch(e){
              tmsg("INVALID JSON");
            }
          };
        }

        function openFeedMenu(){
          const html =
            menuTitle("FEED MENU") +
            "<div style='display:grid; gap:10px; margin-top:10px; width:100%;'>" +
              actionRow("EAT FOOD", "USES 1 FOOD", have("FOOD") ? "btnMain" : "btnAlt", "feed_food") +
              actionRow("EAT SNACK", "USES 1 SNACK", have("SNACK") ? "btnMain" : "btnAlt", "feed_snack") +
              actionRow("DRINK WATER", "USES 1 WATER", have("WATER") ? "btnMain" : "btnAlt", "feed_water") +
            "</div>";
          openOverlay("FEED", 9999);
          overlayTimer.textContent = "INF";
          overlayPrimary.textContent = "DONE";
          overlayClose.textContent = "CLOSE";
          overlayBody.innerHTML = html;

          bindFeedMenu();
        }

        function actionRow(title, sub, btnClass, id){
          return "<div class='listItem' style='display:flex; justify-content:space-between; align-items:center; gap:12px;'>" +
                 "<div><b>" + title + "</b><div style='margin-top:6px;'>" + sub + "</div></div>" +
                 "<div style='min-width:160px;'><button class='" + btnClass + "' id='" + id + "' type='button'>USE</button></div>" +
                 "</div>";
        }

        function bindFeedMenu(){
          const b1 = overlayBody.querySelector("#feed_food");
          const b2 = overlayBody.querySelector("#feed_snack");
          const b3 = overlayBody.querySelector("#feed_water");

          b1.onclick = ()=>{
            if (!takeItem("FOOD",1)) return tmsg("NO FOOD");
            S.hunger += 30;
            S.happy += 4;
            S.clean -= 2;
            S.disc += 1;
            log("ATE FOOD");
            if (!S.ach.FIRST_FEED){ S.ach.FIRST_FEED = true; log("ACHIEVEMENT FIRST FEED"); }
            addXP(8, "FROM FEED");
            animFeed("POPPY ATE FOOD");
            closeOverlay();
            updateUI(); save();
          };

          b2.onclick = ()=>{
            if (!takeItem("SNACK",1)) return tmsg("NO SNACK");
            S.hunger += 16;
            S.happy += 7;
            S.clean -= 1;
            log("ATE SNACK");
            addXP(6, "FROM SNACK");
            animFeed("POPPY ATE SNACK");
            closeOverlay();
            updateUI(); save();
          };

          b3.onclick = ()=>{
            if (!takeItem("WATER",1)) return tmsg("NO WATER");
            S.health += 7;
            S.energy += 6;
            S.happy += 2;
            log("DRANK WATER");
            addXP(5, "FROM WATER");
            animFeed("POPPY DRANK WATER");
            closeOverlay();
            updateUI(); save();
          };
        }

        function openPlayMenu(){
          const html =
            menuTitle("PLAY MENU") +
            "<div style='display:grid; gap:10px; margin-top:10px; width:100%;'>" +
              actionRow("APPLE GAME", "CLICK THE APPLE. IT MOVES SLOW AND IS BIG", "btnMain", "play_apples") +
              actionRow("DODGE GAME", "MOVE LEFT AND RIGHT. AVOID THE BLOCK", "btnMain", "play_dodge") +
            "</div>" +
            "<div style='margin-top:10px; color:var(--muted); font-size:12px; width:100%; line-height:1.35;'>" +
              "TIP: TOY ITEMS INCREASE HAPPINESS BONUS AFTER A GAME." +
            "</div>";

          openOverlay("PLAY", 9999);
          overlayTimer.textContent = "INF";
          overlayPrimary.textContent = "DONE";
          overlayClose.textContent = "CLOSE";
          overlayBody.innerHTML = html;

          overlayBody.querySelector("#play_apples").onclick = ()=>{
            closeOverlay();
            startAppleGame();
          };
          overlayBody.querySelector("#play_dodge").onclick = ()=>{
            closeOverlay();
            startDodgeGame();
          };
        }

        // CORE ACTIONS
        function actClean(){
          if (!S.alive || S.paused) return log("CANNOT CLEAN RIGHT NOW");
          if (!takeItem("SOAP",1)){
            log("NO SOAP FOR CLEAN");
            return tmsg("NO SOAP");
          }
          S.clean += 40;
          S.happy += 3;
          S.disc += 2;
          log("CLEANED");
          addXP(9, "FROM CLEAN");
          animClean();
          closeOverlay();
          updateUI(); save();
        }

        function actMed(){
          if (!S.alive || S.paused) return log("CANNOT USE MEDICINE RIGHT NOW");
          if (!takeItem("MED",1)){
            log("NO MEDICINE");
            return tmsg("NO MED");
          }
          S.health += 34;
          S.happy -= 2;
          S.clean -= 1;
          S.mode = "NORMAL";
          log("MEDICINE USED");
          addXP(10, "FROM MED");
          animMed();
          closeOverlay();
          updateUI(); save();
        }

        function actSleepToggle(){
          if (!S.alive) return;
          if (S.mode === "SLEEPING"){
            S.mode = "NORMAL";
            log("WOKE UP");
            addXP(4, "FROM WAKE");
            updateUI(); save();
            return;
          }
          if (S.paused) return log("CANNOT SLEEP WHILE PAUSED");
          S.mode = "SLEEPING";
          log("SLEEP START");
          animSleep();
          updateUI(); save();
        }

        function actWork(){
          if (!S.alive || S.paused) return log("CANNOT WORK RIGHT NOW");
          if (S.mode === "SLEEPING") return tmsg("WAKE UP FIRST");
          const base = rint(2,5);
          const bonus = S.upgrades.BIG_WALLET ? 2 : 0;
          const earned = base + bonus;
          S.coins += earned;
          S.energy -= 10;
          S.hunger -= 7;
          S.happy -= 2;
          S.disc += 1;
          log("WORK EARNED " + earned);
          addXP(10, "FROM WORK");
          burst("burst-nod", 420);
          updateUI(); save();
        }

        function actTrain(){
          if (!S.alive || S.paused) return log("CANNOT TRAIN RIGHT NOW");
          if (S.mode === "SLEEPING") return tmsg("WAKE UP FIRST");
          if (S.energy < 18) return tmsg("LOW ENERGY");
          S.disc += 10;
          S.happy -= 3;
          S.energy -= 14;
          S.hunger -= 4;
          log("TRAIN COMPLETE DISCIPLINE +10");
          addXP(14, "FROM TRAIN");
          burst("burst-pop", 380);
          updateUI(); save();
        }

        // AUTO CARE: uses items + upgrades
        function runAutoCare(){
          if (!S.autoCare) return;
          if (!S.alive || S.paused) return;
          if (S.mode === "SLEEPING") return;

          // auto feed
          if (S.upgrades.AUTO_FEED && S.hunger <= 22){
            if (have("FOOD",1)){ takeItem("FOOD",1); S.hunger += 26; S.happy += 2; log("AUTO FEED FOOD"); addXP(2, "AUTO"); }
            else if (have("SNACK",1)){ takeItem("SNACK",1); S.hunger += 14; S.happy += 3; log("AUTO FEED SNACK"); addXP(2, "AUTO"); }
          }
          // auto clean
          if (S.upgrades.AUTO_CLEAN && S.clean <= 18){
            if (have("SOAP",1)){ takeItem("SOAP",1); S.clean += 30; log("AUTO CLEAN"); addXP(2, "AUTO"); }
          }
          // auto med
          if (S.upgrades.AUTO_MED && S.health <= 22){
            if (have("MED",1)){ takeItem("MED",1); S.health += 26; S.mode = "NORMAL"; log("AUTO MED"); addXP(2, "AUTO"); }
          }
        }

        // OFFLINE PROGRESS
        function applyOfflineProgress(){
          const now = Date.now();
          const diffMs = Math.max(0, now - (S.last || now));
          const ticks = Math.min(120, Math.floor(diffMs / TICK_MS)); // cap offline to 120 ticks
          if (ticks <= 0) return;
          log("OFFLINE TICKS " + ticks);
          for (let i=0;i<ticks;i++){
            internalTick(true);
          }
        }

        // TICK LOOP
        const TICK_MS = 25000; // SLOWER AND EASIER TO MANAGE
        let tickTimer = null;

        function internalTick(isOffline){
          if (!S.alive) return;
          if (S.paused) return;

          // tiny idle blink sometimes (skip if overlay shown)
          if (!overlay.classList.contains("show") && chance(0.18)) blink();

          // age increases per tick
          S.age += 1;

          // decay rates
          let hungerD = 2;
          let energyD = 2;
          let cleanD  = 1;
          let happyD  = 1;

          if (S.upgrades.SLOW_DECAY){
            hungerD = 1.6;
            energyD = 1.6;
            cleanD  = 0.8;
            happyD  = 0.8;
          }

          // sleeping recovery
          if (S.mode === "SLEEPING"){
            const bed = S.upgrades.COMFY_BED ? 2 : 0;
            S.energy += 5 + bed;
            S.health += 1;
            S.hunger -= 1;
            S.clean  -= 0.4;
            S.happy  -= 0.2;

            // blanket item bonus if present
            if (S.inv.BLANKET > 0 && chance(0.18)){
              // do not consume: it is a comfort item; if you want consumable, change this.
              S.energy += 1;
              S.happy += 1;
            }

            // auto wake if energy high
            if (S.energy >= 92 && !isOffline){
              S.mode = "NORMAL";
              log("AUTO WAKE");
              addXP(4, "FROM REST");
            }
          } else {
            S.hunger -= hungerD;
            S.energy -= energyD;
            S.clean  -= cleanD;

            // happiness depends on problems
            let penalty = 0;
            if (S.hunger < 35) penalty += 2;
            if (S.energy < 25) penalty += 2;
            if (S.clean  < 25) penalty += 2;
            if (S.health < 35) penalty += 2;
            if (S.disc  < 25) penalty += 1;

            S.happy -= (happyD + penalty * 0.55);

            // discipline drifts down if unhappy or messy
            if (S.happy < 30 || S.clean < 25) S.disc -= 1;
            else if (S.happy > 70 && S.clean > 70) S.disc += 0.5;
          }

          // health damage if extreme
          let dmg = 0;
          if (S.hunger <= 10) dmg += 4;
          if (S.clean  <= 10) dmg += 4;
          if (S.energy <= 8)  dmg += 3;
          if (S.happy  <= 8)  dmg += 3;
          if (S.disc   <= 8)  dmg += 2;
          S.health -= dmg;

          // becoming sick
          if (S.health <= 25 && S.mode !== "SLEEPING" && chance(0.18)){
            S.mode = "SICK";
          }
          if (S.mode === "SICK"){
            S.health -= 1;
            S.energy -= 1;
            S.happy -= 1;
            if (S.health > 45) S.mode = "NORMAL";
          }

          // random events (rare)
          if (!overlay.classList.contains("show") && chance(0.06)){
            randomEvent();
          }

          // toy passive benefit
          if ((S.inv.TOY||0) > 0 && chance(0.08) && S.mode !== "SLEEPING"){
            S.happy += 1;
          }

          // clamp + death
          S.hunger = clamp(S.hunger, 0, 100);
          S.happy  = clamp(S.happy, 0, 100);
          S.energy = clamp(S.energy, 0, 100);
          S.clean  = clamp(S.clean, 0, 100);
          S.health = clamp(S.health, 0, 100);
          S.disc   = clamp(S.disc, 0, 100);

          if (S.health <= 0){
            S.alive = false;
            S.health = 0;
            log("POPPY HAS DIED");
            tmsg("POPPY DIED");
          }

          // auto care each tick
          runAutoCare();

          // tiny passive xp for keeping stable
          if (S.alive && S.mode !== "SICK"){
            const stable = (S.hunger>40 && S.happy>40 && S.energy>40 && S.clean>40 && S.health>40);
            if (stable) S.xp += 1;
          }

          // level up if needed
          while (S.xp >= xpToNext(S.lvl)){
            S.xp -= xpToNext(S.lvl);
            S.lvl += 1;
            S.coins += 2;
            log("LEVEL UP TO " + S.lvl + " COINS +2");
          }

          updateUI();
          save();
        }

        function randomEvent(){
          // choose event type
          const roll = Math.random();
          if (roll < 0.20){
            const c = rint(1,4);
            S.coins += c;
            log("FOUND COINS +" + c);
          } else if (roll < 0.40){
            const item = ["FOOD","SNACK","WATER","SOAP"][rint(0,3)];
            addItem(item, 1);
            log("FOUND ITEM " + item);
          } else if (roll < 0.58){
            S.clean -= rint(4,9);
            log("MESS EVENT CLEANLINESS DOWN");
          } else if (roll < 0.76){
            S.happy -= rint(4,9);
            log("MOOD DROP EVENT HAPPINESS DOWN");
          } else if (roll < 0.90){
            S.energy -= rint(4,9);
            log("TIRED EVENT ENERGY DOWN");
          } else {
            S.health -= rint(4,9);
            S.mode = "SICK";
            log("SICK EVENT HEALTH DOWN");
          }
          addXP(2, "FROM EVENT");
          updateUI();
        }

        function startTick(){
          if (tickTimer) clearInterval(tickTimer);
          tickTimer = setInterval(()=>internalTick(false), TICK_MS);
        }

        // BUTTON WIRING
        btnFeed.addEventListener("click", ()=>{
          if (!S.alive || S.paused) return;
          if (S.mode === "SLEEPING") return tmsg("WAKE UP FIRST");
          openFeedMenu();
        });

        btnPlay.addEventListener("click", ()=>{
          if (!S.alive || S.paused) return;
          if (S.mode === "SLEEPING") return tmsg("WAKE UP FIRST");
          openPlayMenu();
        });

        btnSleep.addEventListener("click", actSleepToggle);

        btnClean.addEventListener("click", ()=>{
          if (!S.alive || S.paused) return;
          if (S.mode === "SLEEPING") return tmsg("WAKE UP FIRST");
          actClean();
        });

        btnMed.addEventListener("click", ()=>{
          if (!S.alive || S.paused) return;
          if (S.mode === "SLEEPING") return tmsg("WAKE UP FIRST");
          actMed();
        });

        btnWork.addEventListener("click", actWork);
        btnInventory.addEventListener("click", openInventory);
        btnShop.addEventListener("click", openShop);
        btnTrain.addEventListener("click", actTrain);
        btnSettings.addEventListener("click", openSettings);

        btnPause.addEventListener("click", ()=>{
          S.paused = !S.paused;
          log(S.paused ? "PAUSED" : "RESUMED");
          tmsg(S.paused ? "PAUSED" : "RESUMED");
          updateUI();
          save();
        });

        btnReset.addEventListener("click", ()=>{
          const ok = confirm("RESET POPPY?");
          if (!ok) return;
          stopGame();
          closeOverlay();
          S = defaultState();
          logEl.innerHTML = "";
          log("RESET COMPLETE");
          tmsg("RESET");
          updateUI();
          save(true);
        });

        // OVERLAY CLOSE ESC
        window.addEventListener("keydown", (e)=>{
          const k = e.key.toLowerCase();
          if (overlay.classList.contains("show") && k === "escape"){
            if (overlayMode.startsWith("PLAY")) finishGame(false);
            closeOverlay();
          }
        }, { passive:true });

        // SIMPLE SHORTCUTS OUTSIDE OVERLAY
        window.addEventListener("keydown", (e)=>{
          if (overlay.classList.contains("show")) return;
          const k = e.key.toLowerCase();
          if (k === "f") btnFeed.click();
          if (k === "p") btnPlay.click();
          if (k === "s") btnSleep.click();
          if (k === "c") btnClean.click();
          if (k === "m") btnMed.click();
          if (k === "w") btnWork.click();
          if (k === "i") btnInventory.click();
          if (k === "b") btnShop.click();
          if (k === "t") btnTrain.click();
          if (k === " ") btnPause.click();
        }, { passive:true });

        // STARTUP
        const loaded = load();
        logEl.innerHTML = "";
        if (loaded){
          log("SAVE LOADED");
          applyOfflineProgress();
        } else {
          log("WELCOME TO POPPY");
          log("TIP: BUY ITEMS IN SHOP");
          log("TIP: PLAY GAMES TO EARN COINS AND XP");
        }

        // occasional blink (no constant motion)
        setInterval(()=>{
          if (!S.alive || S.paused) return;
          if (overlay.classList.contains("show")) return;
          if (chance(0.16)) blink();
        }, 2600);

        // check coin achievement and more
        updateUI();
        save();

        // begin ticking
        startTick();

        // EXTRA: SOFT AUTO-CARE WITHOUT UPGRADES IF USER ENABLES AUTO CARE
        // DOES NOT CONSUME ITEMS. IT IS A VERY SMALL HELP.
        setInterval(()=>{
          if (!S.autoCare) return;
          if (!S.alive || S.paused) return;
          if (S.mode === "SLEEPING") return;
          // tiny stabilizers so it feels alive without breaking balance
          if (S.happy < 25) S.disc = clamp(S.disc + 1, 0, 100);
          if (S.clean < 20) S.happy = clamp(S.happy + 1, 0, 100);
          if (S.energy < 18) S.happy = clamp(S.happy - 1, 0, 100);
          updateUI();
          save();
        }, 12000);

        // UI: AUTO CARE TOGGLE ALSO AVAILABLE VIA SETTINGS ONLY, BUT QUICK TOGGLE HERE
        // DOUBLE CLICK STATUS BOX TO TOGGLE AUTO CARE FAST
        statusBox.addEventListener("dblclick", ()=>{
          S.autoCare = !S.autoCare;
          log("AUTO CARE " + (S.autoCare ? "ON" : "OFF"));
          tmsg("AUTO CARE " + (S.autoCare ? "ON" : "OFF"));
          updateUI(); save();
        });

      } catch(err){
        console.error(err);
        showError(String(err && err.message ? err.message : err));
      }
    })();
  </script>
</body>
</html>
